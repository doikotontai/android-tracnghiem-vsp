<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Trắc Nghiệm - NDT Glass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CẤU HÌNH TAILWIND THEME -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Be Vietnam Pro"', 'sans-serif'],
                        display: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        primary: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: #f3f4f6;
            transition: all 0.3s ease;
        }
        
        /* --- DARK MODE CONFIGURATION --- */
        body.dark-mode {
            /* Nền Aurora */
            background: radial-gradient(circle at 50% -20%, #1e3a8a 0%, #020617 50%, #000000 100%) !important;
            background-attachment: fixed;
            color: #f1f5f9;
        }

        /* Glass Panel Styles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        /* Dark Mode Glass Panel */
        body.dark-mode .glass-panel,
        body.dark-mode .bg-white {
            background-color: rgba(15, 23, 42, 0.6) !important; /* Nền tối trong suốt */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #f1f5f9 !important;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Override Text Colors in Dark Mode (Quan trọng để chữ sáng lên) */
        body.dark-mode .text-slate-900, 
        body.dark-mode .text-slate-800, 
        body.dark-mode .text-slate-700,
        body.dark-mode .text-gray-800 {
            color: #f1f5f9 !important;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        body.dark-mode .text-slate-600,
        body.dark-mode .text-slate-500 {
            color: #94a3b8 !important;
        }

        /* Components in Dark Mode */
        body.dark-mode header {
            background-color: rgba(15, 23, 42, 0.6) !important;
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        body.dark-mode footer {
            background-color: rgba(15, 23, 42, 0.6) !important;
            border-top-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Cards & Inputs */
        body.dark-mode .option-card {
            background-color: rgba(255, 255, 255, 0.03) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        body.dark-mode .option-card:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(56, 189, 248, 0.5) !important;
        }
        
        
        /* --- OPTION STATES (LIGHT MODE) --- */
        .option-card.selected {
            background-color: rgba(59, 130, 246, 0.10) !important;
            border-color: #2563eb !important;
        }
        .option-card.correct {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
        }
        .option-card.wrong {
            background-color: #fee2e2 !important;
            border-color: #dc2626 !important;
        }

        /* --- OPTION STATES (DARK MODE) --- */
        body.dark-mode .option-card.selected {
            background-color: rgba(59, 130, 246, 0.14) !important;
            border-color: rgba(96, 165, 250, 0.90) !important;
        }
        body.dark-mode .option-card.correct {
            background-color: rgba(22, 163, 74, 0.18) !important;
            border-color: rgba(34, 197, 94, 0.90) !important;
        }
        body.dark-mode .option-card.wrong {
            background-color: rgba(220, 38, 38, 0.18) !important;
            border-color: rgba(239, 68, 68, 0.90) !important;
        }
        body.dark-mode .option-card.correct span,
        body.dark-mode .option-card.wrong span {
            color: #f1f5f9 !important;
        }

        body.dark-mode input {
            background-color: rgba(30, 41, 59, 0.6) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        body.dark-mode input::placeholder { color: #64748b; }

        /* Buttons */
        body.dark-mode #login-back-btn, 
        body.dark-mode #mode-back-btn,
        body.dark-mode #prev-btn,
        body.dark-mode #next-btn,
        body.dark-mode #stop-btn {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: #e2e8f0 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        body.dark-mode #login-back-btn:hover,
        body.dark-mode #next-btn:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation */
        .live-dot { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- LOAD DATA JS FILES -->
    <script src="data_antoan.js"></script>
    <script src="data_mt.js"></script>
    <script src="data_pt.js"></script>
    <script src="data_ut.js"></script>
    <script src="data_rt.js"></script>
    <script src="data_paut.js"></script>
    <script src="data_acfm.js"></script>
    <script src="data_et.js"></script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel, getDocs, query, orderBy, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp, getApps, getApp, getAuth, signInAnonymously, onAuthStateChanged,
            signInWithEmailAndPassword, signOut, getFirestore, addDoc, collection,
            serverTimestamp, setLogLevel, getDocs, query, orderBy, deleteDoc, doc, writeBatch 
        };
    </script>
</head>
<!-- MẶC ĐỊNH DARK MODE -->
<body class="antialiased text-slate-800 min-h-screen flex flex-col selection:bg-primary-100 selection:text-primary-900 dark-mode">

    <!-- HEADER -->
    <header class="glass-panel sticky top-0 z-50 shadow-sm border-b border-white/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="app.goHome()">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-bold shadow-glow">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span class="font-display font-bold text-xl tracking-tight text-slate-800 hidden sm:block">NDT<span class="text-primary-600">Master</span></span>
            </div>

            <div id="header-actions" class="flex items-center gap-3">
                <button id="home-nav-btn" onclick="window.location.href='index.html'" class="hidden text-sm font-medium text-slate-500 hover:text-primary-600 transition-colors flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Trang chủ
                </button>
                <!-- Nút Toggle Theme -->
                <button id="theme-toggle" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <i id="theme-icon" class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app" class="flex-grow flex flex-col items-center justify-start p-4 sm:p-6 md:p-8 w-full max-w-full mx-auto">
        
        <!-- SCREEN: SUBJECT SELECTOR -->
        <div id="selector-screen" class="w-full max-w-5xl animate-slide-up mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-3 font-display">Trung tâm Đánh giá Năng lực</h1>
                <p class="text-slate-500 text-lg">Chọn môn thi để bắt đầu ôn tập hoặc kiểm tra</p>
            </div>

            <div id="subject-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Subject items will be injected here by JS -->
            </div>

            <!-- Admin Area -->
            <div id="admin-button-container" class="mt-12 flex justify-center w-full"></div>
        </div>

        <!-- SCREEN: LOGIN -->
        <div id="login-screen" class="hidden w-full max-w-md animate-fade-in mx-auto">
            <div class="glass-panel rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-primary-600 to-indigo-600 p-6 text-center">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                        <i class="fas fa-user-astronaut text-2xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Thông tin Thí sinh</h2>
                    <p class="text-blue-100 text-sm mt-1">Vui lòng nhập danh số để tiếp tục</p>
                </div>
                
                <div class="p-8">
                    <form id="login-form" class="space-y-5">
                        <div id="danhso-group">
                            <label for="user-danhso" class="block text-sm font-medium text-slate-700 mb-2">Danh số / Mã định danh</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-id-card text-slate-400"></i>
                                </div>
                                <input type="text" id="user-danhso" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all bg-white/50 backdrop-blur-sm" placeholder="Nhập danh số của bạn..." required>
                            </div>
                        </div>

                        <!-- Admin Fields -->
                        <div id="admin-login-group" class="hidden space-y-4 pt-4 border-t border-slate-200">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Admin Email</label>
                                <input type="email" id="admin-email" class="block w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu</label>
                                <input type="password" id="admin-password" class="block w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>

                        <div class="flex gap-3 pt-2">
                            <button type="button" id="login-back-btn" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 font-medium transition-colors">
                                Quay lại
                            </button>
                            <button type="submit" id="login-btn" class="flex-[2] px-4 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 font-medium shadow-lg shadow-primary-500/30 transition-all transform active:scale-95">
                                Vào làm bài
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SCREEN: MODE SELECTOR (MODAL) -->
        <div id="mode-modal" class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-100 transition-transform duration-300">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">Chọn Chế độ</h2>
                    <button id="mode-close-icon" class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6 grid gap-4">
                    <button id="mode-review" class="group relative flex items-center p-4 border border-slate-200 rounded-xl hover:border-primary-500 hover:bg-primary-50 transition-all duration-200">
                        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i class="fas fa-book-open text-xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-slate-800 group-hover:text-primary-700">Ôn tập kiến thức</h3>
                            <p class="text-sm text-slate-500">Luyện tập không giới hạn thời gian, có gợi ý.</p>
                        </div>
                    </button>

                    <button id="mode-test" class="group relative flex items-center p-4 border border-slate-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition-all duration-200">
                        <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mr-4 group-hover:bg-red-600 group-hover:text-white transition-colors">
                            <i class="fas fa-stopwatch text-xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-slate-800 group-hover:text-red-700">Thi thử tính giờ</h3>
                            <p class="text-sm text-slate-500">Mô phỏng bài thi thật, 20 câu / 20 phút.</p>
                        </div>
                    </button>
                </div>
                <div class="p-4 bg-slate-50 border-t border-slate-100 text-right">
                    <button id="mode-back-btn" class="px-5 py-2 text-slate-600 hover:text-slate-900 font-medium">Đóng</button>
                </div>
            </div>
        </div>

        <!-- SCREEN: QUIZ -->
        <div id="quiz-screen" class="hidden w-full flex flex-col gap-6 animate-fade-in">
            
            <!-- Main Question Area -->
            <div class="w-full max-w-4xl mx-auto">
                <div class="glass-panel rounded-2xl shadow-soft p-6 sm:p-8 min-h-[400px] flex flex-col relative">
                    
                    <!-- Timer -->
                    <div id="timer" class="hidden absolute top-6 right-6 bg-red-50 text-red-600 px-4 py-2 rounded-full font-bold border border-red-100 shadow-sm flex items-center gap-2">
                        <i class="fas fa-clock"></i> <span id="timer-text">20:00</span>
                    </div>

                    <!-- Header -->
                    <div class="mb-6 pr-24">
                        <span id="subject-badge" class="inline-block px-3 py-1 rounded-full bg-primary-100 text-primary-700 text-xs font-bold uppercase tracking-wider mb-2">Môn thi</span>
                        <h2 id="question-header" class="text-2xl font-bold text-slate-800">Câu hỏi 1 / 20</h2>
                    </div>

                    <!-- Question Content -->
                    <div class="flex-grow">
                        <div id="question-text" class="text-lg sm:text-xl text-slate-700 leading-relaxed font-medium mb-8">
                            <!-- Question text goes here -->
                        </div>

                        <div id="options-container" class="grid gap-3">
                            <!-- Options injected via JS -->
                        </div>
                        
                        <!-- Feedback -->
                        <div id="feedback-container" class="hidden mt-6 p-4 rounded-xl bg-slate-100 border border-slate-200 animate-fade-in">
                            <div id="feedback-text"></div>
                        </div>
                    </div>

                    <!-- Footer Buttons -->
                    <div class="mt-8 pt-6 border-t border-slate-200 flex flex-wrap justify-between items-center gap-4">
                        <button id="prev-btn" class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition-colors flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Trước
                        </button>
                        
                        <div class="flex gap-3">
                            <button id="hint-btn" class="px-5 py-2.5 rounded-xl bg-yellow-50 text-yellow-700 border border-yellow-200 hover:bg-yellow-100 font-medium transition-colors flex items-center gap-2 shadow-sm">
                                <i class="fas fa-lightbulb"></i> Gợi ý
                            </button>
                            <button id="submit-btn" class="px-6 py-2.5 rounded-xl bg-primary-600 text-white hover:bg-primary-700 font-medium transition-all shadow-lg shadow-primary-500/30 transform active:scale-95">
                                Trả lời
                            </button>
                            <button id="stop-btn" class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-red-50 hover:text-red-600 border border-transparent hover:border-red-100 font-medium transition-colors">
                                Dừng làm bài
                            </button>
                        </div>

                        <button id="next-btn" class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition-colors flex items-center gap-2">
                            Tiếp <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Question Navigator -->
            <div class="w-full">
                <div class="glass-panel rounded-2xl shadow-soft p-6">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-th"></i> Danh sách câu hỏi
                    </h3>
                    <div id="question-list" class="flex flex-wrap gap-2 justify-center">
                        <!-- Nav items injected via JS -->
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-200 flex flex-wrap gap-4 text-xs text-slate-500 justify-center">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-slate-200 border border-slate-300"></div> Chưa xem</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-yellow-100 border border-yellow-400 text-yellow-700"></div> Đã xem / Bỏ qua</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-green-500 border border-green-600"></div> Đúng</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-blue-500 border border-blue-600"></div> Đã làm (Thi)</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-red-500 border border-red-600"></div> Sai</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN: ADMIN -->
        <div id="admin-screen" class="hidden w-full animate-fade-in mx-auto max-w-5xl">
            <div class="glass-panel rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-slate-800 p-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold text-white"><i class="fas fa-user-shield mr-2"></i>Bảng Quản Trị</h2>
                    <div class="flex gap-3">
                        <button id="admin-delete-all-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg">
                            <i class="fas fa-trash-alt mr-1"></i> Xóa toàn bộ
                        </button>
                        <button id="admin-back-btn" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm font-medium transition-colors">
                            Quay lại
                        </button>
                    </div>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                            <tr>
                                <th class="px-6 py-4 border-b border-slate-200">Danh số</th>
                                <th class="px-6 py-4 border-b border-slate-200">Môn thi</th>
                                <th class="px-6 py-4 border-b border-slate-200">Điểm số</th>
                                <th class="px-6 py-4 border-b border-slate-200">Thời gian</th>
                                <th class="px-6 py-4 border-b border-slate-200 text-right">Tác vụ</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="divide-y divide-slate-100 text-sm text-slate-700">
                            <!-- Rows loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODAL: LOADING -->
        <div id="connecting-modal" class="fixed inset-0 z-[70] bg-slate-900/80 flex items-center justify-center hidden">
            <div class="bg-white rounded-xl p-6 shadow-2xl flex flex-col items-center">
                <div class="loader mb-4"></div>
                <p class="font-medium text-slate-700">Đang kết nối máy chủ...</p>
            </div>
        </div>

        <!-- MODAL: RESULTS -->
        <div id="results-modal" class="fixed inset-0 z-[70] bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4 hidden animate-fade-in">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-8 text-center relative overflow-hidden">
                    <h2 id="results-title" class="text-3xl font-bold text-white mb-2 relative z-10">Hoàn thành!</h2>
                    <div class="text-6xl font-bold text-white mb-2 relative z-10 drop-shadow-md" id="results-score-display">--/--</div>
                    <p class="text-indigo-100 relative z-10">Điểm số của bạn</p>
                </div>
                
                <div class="p-8">
                    <div class="grid grid-cols-3 gap-4 mb-8 text-center">
                        <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
                            <div class="text-xs text-slate-500 uppercase font-bold">Tổng câu</div>
                            <div id="results-total" class="text-xl font-bold text-slate-800 mt-1">20</div>
                        </div>
                        <div class="p-3 rounded-xl bg-green-50 border border-green-100">
                            <div class="text-xs text-green-600 uppercase font-bold">Đúng</div>
                            <div id="results-correct" class="text-xl font-bold text-green-600 mt-1">15</div>
                        </div>
                        <div class="p-3 rounded-xl bg-red-50 border border-red-100">
                            <div class="text-xs text-red-600 uppercase font-bold">Sai</div>
                            <div id="results-wrong" class="text-xl font-bold text-red-600 mt-1">5</div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button id="review-wrong-btn" class="w-full py-3 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50 font-semibold transition-colors">
                            Xem lại câu sai
                        </button>
                        <button id="close-results-btn" class="w-full py-3 rounded-xl bg-slate-800 text-white hover:bg-slate-900 font-semibold shadow-lg transition-transform active:scale-95">
                            Về trang chủ
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="mt-auto py-6 text-center border-t border-slate-200/60 bg-white/50 backdrop-blur-sm">
        <div class="inline-flex items-center gap-2 bg-white px-4 py-1.5 rounded-full shadow-sm border border-slate-200 text-xs text-slate-500 mb-2">
            <span class="w-2 h-2 bg-green-500 rounded-full live-dot"></span>
            <span>Lượt truy cập:</span>
            <span id="visitor-count" class="font-bold text-slate-700 tabular-nums">...</span>
        </div>
        <p class="text-slate-500 text-sm">&copy; 2025 BCH-XNXL. Design by Phong Lưu.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const state = {
            currentSubjectKey: null, mode: 'review', questions: [], pickedIndices: [], currentIndex: 0,
            userAnswers: {}, timerId: null, secondsLeft: 0, viewedIndices: new Set(),
            testConfig: { questionCount: 20, durationMinutes: 20 },
            userName: null, userDanhSo: null, db: null, auth: null,
            firebaseReady: false, isFinished: false
        };

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        const subjectConfig = {
            'antoan': { name: 'An toàn Lao động', icon: 'fa-hard-hat', color: 'text-yellow-600', bg: 'bg-yellow-100', border: 'border-yellow-200' },
            'mt': { name: 'Môi trường', icon: 'fa-leaf', color: 'text-green-600', bg: 'bg-green-100', border: 'border-green-200' },
            'pt': { name: 'Phổ thông', icon: 'fa-book', color: 'text-blue-600', bg: 'bg-blue-100', border: 'border-blue-200' },
            'ut': { name: 'Siêu âm (UT)', icon: 'fa-wave-square', color: 'text-indigo-600', bg: 'bg-indigo-100', border: 'border-indigo-200' },
            'rt': { name: 'Chụp ảnh (RT)', icon: 'fa-x-ray', color: 'text-purple-600', bg: 'bg-purple-100', border: 'border-purple-200' },
            'paut': { name: 'PAUT', icon: 'fa-satellite-dish', color: 'text-pink-600', bg: 'bg-pink-100', border: 'border-pink-200' },
            'acfm': { name: 'ACFM', icon: 'fa-magnet', color: 'text-teal-600', bg: 'bg-teal-100', border: 'border-teal-200' },
            'et': { name: 'Dòng xoáy (ET)', icon: 'fa-circle-notch', color: 'text-orange-600', bg: 'bg-orange-100', border: 'border-orange-200' },
            'default': { name: 'Môn học', icon: 'fa-book-open', color: 'text-slate-600', bg: 'bg-slate-100', border: 'border-slate-200' }
        };

        const app = {
            init() {
                this.loadDataFromFiles();
                this.renderSubjectList();
                this.attachEventListeners();
                this.showScreen('selector');
            },

            async initFirebase(isForAdmin = false) {
                if (state.firebaseReady && !isForAdmin) return true;
                try {
                    let attempts = 0;
                    while (!window.firebase && attempts < 50) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firebase) throw new Error("Firebase SDK missing");

                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, setLogLevel, getApps, getApp } = window.firebase;
                    const firebaseConfig = {
                        apiKey: "AIzaSyCt14_pkmWE0MhD0SeH_MisjmHjlY-Mu84",
                        authDomain: "tracnghiemndt.firebaseapp.com",
                        projectId: "tracnghiemndt",
                        storageBucket: "tracnghiemndt.firebasestorage.app",
                        messagingSenderId: "187385061213",
                        appId: "1:187385061213:web:fe7977f62aaaeec60f52b4",
                        measurementId: "G-TKRBZJT880"
                    };

                    let fbApp = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
                    state.db = getFirestore(fbApp);
                    state.auth = getAuth(fbApp);
                    setLogLevel('Debug');
                    state.firebaseReady = true;
                    this.checkAdminAndShowButton();
                    return true;
                } catch (e) { console.error(e); return false; }
            },

            loadDataFromFiles() {
                window.questionData = {};
                try { if (typeof data_antoan !== 'undefined') window.questionData['antoan'] = data_antoan; } catch(e){}
                try { if (typeof data_mt !== 'undefined') window.questionData['mt'] = data_mt; } catch(e){}
                try { if (typeof data_pt !== 'undefined') window.questionData['pt'] = data_pt; } catch(e){}
                try { if (typeof data_ut !== 'undefined') window.questionData['ut'] = data_ut; } catch(e){}
                try { if (typeof data_rt !== 'undefined') window.questionData['rt'] = data_rt; } catch(e){}
                try { if (typeof data_paut !== 'undefined') window.questionData['paut'] = data_paut; } catch(e){}
                try { if (typeof data_acfm !== 'undefined') window.questionData['acfm'] = data_acfm; } catch(e){}
                try { if (typeof data_et !== 'undefined') window.questionData['et'] = data_et; } catch(e){}
            },

            attachEventListeners() {
                $('#login-form').addEventListener('submit', (e) => this.handleLogin(e));
                $('#admin-back-btn').addEventListener('click', () => this.showScreen('selector'));
                $('#admin-delete-all-btn').addEventListener('click', () => this.handleDeleteAllResults());
                $('#login-back-btn').addEventListener('click', () => this.showScreen('selector'));
                $('#mode-back-btn').addEventListener('click', () => $('#mode-modal').classList.add('hidden'));
                $('#mode-close-icon').addEventListener('click', () => $('#mode-modal').classList.add('hidden'));
                $('#mode-review').addEventListener('click', () => this.startQuiz('review'));
                $('#mode-test').addEventListener('click', () => this.handleTestModeClick());

                $('#prev-btn').addEventListener('click', () => this.navigateQuestion(-1));
                $('#next-btn').addEventListener('click', () => this.navigateQuestion(1));
                $('#submit-btn').addEventListener('click', () => this.submitAnswer());
                $('#hint-btn').addEventListener('click', () => this.showHint());
                $('#stop-btn').addEventListener('click', () => {
                    if (state.mode === 'test' && !state.isFinished) { this.finishQuiz(false); } 
                    else { this.goHome(); }
                });
                $('#close-results-btn').addEventListener('click', () => this.goHome());
                $('#review-wrong-btn').addEventListener('click', () => this.reviewWrongAnswers());
                window.addEventListener('beforeunload', () => this.handleWindowClose());
                $('#user-danhso').addEventListener('input', (e) => this.checkDanhSoForAdmin(e.target.value));
            },

            async handleAdminLogout() {
                if (!state.auth) return;
                try { await window.firebase.signOut(state.auth); alert("Đã đăng xuất Admin."); this.checkAdminAndShowButton(); } 
                catch (e) { console.error(e); }
            },

            checkDanhSoForAdmin(danhSo) {
                const adminGroup = $('#admin-login-group');
                const loginBtn = $('#login-btn');
                if (danhSo.toLowerCase() === 'admin') {
                    adminGroup.classList.remove('hidden');
                    loginBtn.textContent = 'Đăng nhập Admin';
                } else {
                    adminGroup.classList.add('hidden');
                    loginBtn.textContent = 'Vào làm bài';
                }
            },

            async handleTestModeClick() {
                $('#mode-modal').classList.add('hidden');
                $('#connecting-modal').classList.remove('hidden');
                try {
                    const success = await this.initFirebase(false);
                    $('#connecting-modal').classList.add('hidden');
                    if (success) {
                        this.showScreen('login');
                        this.checkDanhSoForAdmin($('#user-danhso').value);
                    } else { alert("Lỗi kết nối máy chủ."); }
                } catch (e) { 
                    $('#connecting-modal').classList.add('hidden'); 
                    alert("Lỗi: " + e.message); 
                }
            },

            async handleLogin(e) {
                e.preventDefault();
                const userDanhSo = $('#user-danhso').value.trim();
                const adminEmail = $('#admin-email').value.trim();
                const adminPassword = $('#admin-password').value.trim();
                const loginBtn = $('#login-btn');
                loginBtn.disabled = true;

                if (userDanhSo.toLowerCase() === 'admin') {
                    if (!adminEmail || !adminPassword) { alert("Nhập Email/Pass admin"); loginBtn.disabled = false; return; }
                    try {
                        await window.firebase.signInWithEmailAndPassword(state.auth, adminEmail, adminPassword);
                        this.showScreen('selector');
                    } catch (e) { alert("Đăng nhập Admin thất bại."); }
                } else {
                    if (!userDanhSo) { alert("Nhập danh số"); loginBtn.disabled = false; return; }
                    try {
                        await window.firebase.signInAnonymously(state.auth);
                        state.userName = userDanhSo; state.userDanhSo = userDanhSo;
                        this.startQuiz('test');
                    } catch (e) { alert("Không thể bắt đầu phiên."); }
                }
                loginBtn.disabled = false;
            },

            showScreen(name) {
                ['login', 'selector', 'quiz', 'admin'].forEach(n => $(`#${n}-screen`).classList.add('hidden'));
                $(`#${name}-screen`).classList.remove('hidden');
                
                const homeNavBtn = $('#home-nav-btn');
                if(name === 'quiz' || name === 'admin' || name === 'login') homeNavBtn.classList.remove('hidden');
                else homeNavBtn.classList.add('hidden');

                window.scrollTo(0,0);
                if (name === 'selector') this.checkAdminAndShowButton();
            },

            async checkAdminAndShowButton() {
                if (!state.firebaseReady) await this.initFirebase(true);
                const container = $('#admin-button-container');
                container.innerHTML = '';
                try {
                    const { collection, query, getDocs, orderBy } = window.firebase;
                    const q = query(collection(state.db, 'quiz_results'), orderBy('timestamp', 'desc')); 
                    await getDocs(q); 
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col gap-3 w-full max-w-xs';

                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'w-full py-2.5 px-4 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-medium shadow-lg transition-colors flex items-center justify-center gap-2';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Trang Quản Trị';
                    adminBtn.onclick = () => this.loadAdminResults();
                    
                    const logoutBtn = document.createElement('button');
                    logoutBtn.className = 'w-full py-2 px-4 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-xl text-sm font-medium transition-colors';
                    logoutBtn.innerHTML = 'Thoát Admin';
                    logoutBtn.onclick = () => this.handleAdminLogout();

                    wrapper.appendChild(adminBtn);
                    wrapper.appendChild(logoutBtn);
                    container.appendChild(wrapper);
                } catch (e) {}
            },

            goHome() {
                clearInterval(state.timerId);
                state.isFinished = true;
                $('#results-modal').classList.add('hidden');
                this.showScreen('selector');
            },

            renderSubjectList() {
                const grid = $('#subject-grid');
                grid.innerHTML = '';
                const subjects = Object.entries(window.questionData);
                
                if (subjects.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-1 sm:col-span-2 lg:col-span-3 text-center p-10 glass-panel rounded-2xl border-2 border-dashed border-slate-300">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-folder-open text-3xl text-slate-400"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-700">Chưa tải được dữ liệu môn học</h3>
                            <p class="text-slate-500 mt-2 mb-4">Hệ thống không tìm thấy các biến dữ liệu.</p>
                        </div>
                    `;
                    return;
                }

                subjects.forEach(([key, data]) => {
                    const conf = subjectConfig[key] || subjectConfig['default'];
                    const displayName = data.name || key.toUpperCase();
                    
                    const card = document.createElement('div');
                    card.className = `glass-panel p-6 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer group border-l-4 ${conf.border}`;
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl ${conf.bg} ${conf.color} flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                <i class="fas ${conf.icon}"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">${data.questions.length} Câu</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1 group-hover:text-primary-600 transition-colors">${displayName}</h3>
                        <p class="text-sm text-slate-500">Nhấn để chọn chế độ thi</p>
                    `;
                    card.onclick = () => this.selectSubject(key);
                    grid.appendChild(card);
                });
            },

            async loadAdminResults() {
                if (!state.firebaseReady || !state.db) { alert("Chưa kết nối."); return; }
                this.showScreen('admin');
                const tbody = $('#results-table-body');
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">Đang tải...</td></tr>';
                
                try {
                    const { collection, query, getDocs, orderBy } = window.firebase;
                    const q = query(collection(state.db, 'quiz_results'), orderBy('timestamp', 'desc'));
                    const snapshot = await getDocs(q);
                    tbody.innerHTML = '';
                    if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Trống</td></tr>'; return; }

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const date = d.timestamp ? d.timestamp.toDate().toLocaleString('vi-VN') : 'N/A';
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-50 transition-colors';
                        tr.innerHTML = `
                            <td class="px-6 py-4 font-medium text-slate-900">${d.userDanhSo || 'Ẩn danh'}</td>
                            <td class="px-6 py-4">${d.subject}</td>
                            <td class="px-6 py-4"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${d.correct}/${d.total}</span></td>
                            <td class="px-6 py-4 text-slate-500 text-xs">${date}</td>
                            <td class="px-6 py-4 text-right">
                                <button class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded delete-btn" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    $$('.delete-btn').forEach(b => b.onclick = (e) => this.handleDeleteResult(e));
                } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="5" class="text-red-500 text-center p-4">Lỗi tải dữ liệu.</td></tr>'; }
            },

            async handleDeleteResult(e) {
                const btn = e.currentTarget;
                const id = btn.dataset.id;
                if(!confirm("Xóa kết quả này?")) return;
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(state.db, 'quiz_results', id));
                    btn.closest('tr').remove();
                } catch (err) { alert("Lỗi xóa."); }
            },

            async handleDeleteAllResults() {
                if (!confirm("CẢNH BÁO: XÓA TOÀN BỘ DỮ LIỆU?\nKhông thể phục hồi!")) return;
                if (!confirm("Xác nhận lần 2: Bạn chắc chắn chứ?")) return;
                const btn = $('#admin-delete-all-btn');
                const oldTxt = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                try {
                    const { collection, getDocs, writeBatch } = window.firebase;
                    const snap = await getDocs(collection(state.db, 'quiz_results'));
                    const batch = writeBatch(state.db);
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    alert("Đã xóa xong.");
                    this.loadAdminResults();
                } catch (e) { alert("Lỗi: " + e.message); }
                finally { btn.innerHTML = oldTxt; }
            },

            selectSubject(key) {
                state.currentSubjectKey = key;
                if (key === 'antoan') {
                    $('#mode-review').style.display = 'flex';
                    $('#mode-test').style.display = 'none';
                } else {
                    $('#mode-review').style.display = 'flex';
                    $('#mode-test').style.display = 'flex';
                }
                $('#mode-modal').classList.remove('hidden');
            },

            startQuiz(mode) {
                state.mode = mode;
                state.viewedIndices.clear();
                state.isFinished = false;
                state.secondsLeft = state.testConfig.durationMinutes * 60;

                if (mode === 'test' && !state.userDanhSo) { alert("Chưa đăng nhập"); return; }

                const subjectData = window.questionData[state.currentSubjectKey];
                state.questions = subjectData.questions;
                const total = state.questions.length;
                
                $('#mode-modal').classList.add('hidden');
                this.showScreen('quiz');
                
                const stopBtn = $('#stop-btn');
                const hintBtn = $('#hint-btn');
                const submitBtn = $('#submit-btn');
                const timer = $('#timer');
                const subjectBadge = $('#subject-badge');

                const subConf = subjectConfig[state.currentSubjectKey] || subjectConfig['default'];
                subjectBadge.textContent = subConf.name;
                subjectBadge.className = `inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2 ${subConf.bg} ${subConf.color}`;

                if (mode === 'test') {
                    hintBtn.classList.add('hidden');
                    stopBtn.textContent = 'Nộp bài sớm';
                    stopBtn.className = 'px-5 py-2.5 rounded-xl text-red-600 bg-red-50 hover:bg-red-100 font-medium transition-colors';
                    timer.classList.remove('hidden');
                    this.startTimer();
                    const pickCount = Math.min(state.testConfig.questionCount, total);
                    state.pickedIndices = [...Array(total).keys()].sort(() => 0.5 - Math.random()).slice(0, pickCount);
                } else {
                    hintBtn.classList.remove('hidden');
                    stopBtn.textContent = 'Thoát';
                    stopBtn.className = 'px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition-colors';
                    timer.classList.add('hidden');
                    if (mode === 'review') state.pickedIndices = [...Array(total).keys()].sort(() => 0.5 - Math.random());
                }

                if (mode === 'review-wrong') {
                    submitBtn.classList.add('hidden');
                    hintBtn.classList.add('hidden');
                } else {
                    submitBtn.classList.remove('hidden');
                }

                state.currentIndex = 0;
                state.userAnswers = {};
                this.renderQuestionList();
                this.renderQuestion();
            },

            finishQuiz(isAuto = false) {
                if (state.isFinished) return;
                state.isFinished = true;
                clearInterval(state.timerId);
                $('#timer').classList.add('hidden');
                this.updateQuestionListStatus();

                const total = state.pickedIndices.length;
                let correct = 0;
                state.pickedIndices.forEach(idx => {
                    if (idx in state.userAnswers && this.checkCorrectness(idx, state.userAnswers[idx])) correct++;
                });
                const wrong = total - correct;

                $('#results-title').textContent = isAuto ? "Hết giờ!" : "Hoàn thành!";
                $('#results-score-display').textContent = `${Math.round((correct/total)*100)}%`;
                $('#results-total').textContent = total;
                $('#results-correct').textContent = correct;
                $('#results-wrong').textContent = wrong;

                $('#review-wrong-btn').style.display = wrong > 0 ? 'block' : 'none';
                
                if (!isAuto || (isAuto && state.secondsLeft <= 0)) {
                    $('#results-modal').classList.remove('hidden');
                }

                if (state.mode === 'test') this.saveResultToFirebase(correct, wrong, total);
            },

            async saveResultToFirebase(c, w, t) {
                if (!state.firebaseReady || !state.db) return;
                try {
                    const { addDoc, collection, serverTimestamp } = window.firebase;
                    const subName = window.questionData[state.currentSubjectKey]?.name || state.currentSubjectKey;
                    await addDoc(collection(state.db, 'quiz_results'), {
                        userName: state.userName, userDanhSo: state.userDanhSo,
                        subject: subName, mode: state.mode,
                        correct: c, wrong: w, total: t, score: (c/t)*100,
                        timestamp: serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            },

            renderQuestionList() {
                const el = $('#question-list');
                el.innerHTML = '';
                state.pickedIndices.forEach((idx, i) => {
                    const div = document.createElement('div');
                    div.className = 'w-10 h-10 flex items-center justify-center rounded-lg text-sm font-semibold cursor-pointer bg-slate-100 text-slate-500 hover:bg-primary-100 hover:text-primary-600 transition-colors nav-item';
                    div.textContent = i + 1;
                    div.onclick = () => { state.currentIndex = i; this.renderQuestion(); };
                    el.appendChild(div);
                });
                this.updateQuestionListStatus();
            },

            updateQuestionListStatus() {
                const items = $$('.nav-item');
                items.forEach((item, i) => {
                    const qIdx = state.pickedIndices[i];
                    item.className = 'w-10 h-10 flex items-center justify-center rounded-lg text-sm font-semibold cursor-pointer transition-colors border nav-item ';
                    
                    if (qIdx in state.userAnswers) {
                        if (state.mode === 'test' && !state.isFinished) {
                            item.className += 'bg-blue-500 text-white border-blue-600 shadow-sm';
                        } else {
                            const isCorrect = this.checkCorrectness(qIdx, state.userAnswers[qIdx]);
                            if(isCorrect) item.className += 'bg-green-500 text-white border-green-600 shadow-sm';
                            else item.className += 'bg-red-500 text-white border-red-600 shadow-sm';
                        }
                    } else if (state.viewedIndices.has(qIdx)) {
                        item.className += 'bg-yellow-100 text-yellow-700 border-yellow-300';
                    } else {
                        item.className += 'bg-slate-100 text-slate-500 border-slate-200 hover:bg-primary-50';
                    }

                    if (i === state.currentIndex) item.classList.add('ring-2', 'ring-primary-500', 'ring-offset-2');
                });
            },

            renderQuestion() {
                if(state.currentIndex < 0 || state.currentIndex >= state.pickedIndices.length) return;
                const qIdx = state.pickedIndices[state.currentIndex];
                state.viewedIndices.add(qIdx);
                const q = state.questions[qIdx];

                $('#question-header').textContent = `Câu hỏi ${state.currentIndex + 1} / ${state.pickedIndices.length}`;
                $('#question-text').textContent = q.question;
                
                const cont = $('#options-container');
                cont.innerHTML = '';

                q.options.forEach((optText, i) => {
                    const div = document.createElement('div');
                    div.className = 'option-card p-4 rounded-xl border border-slate-200 bg-white cursor-pointer flex items-center group';
                    div.dataset.idx = i;
                    div.innerHTML = `
                        <div class="w-6 h-6 rounded-full border-2 border-slate-300 mr-4 flex items-center justify-center group-hover:border-primary-500 transition-colors shrink-0">
                            <div class="w-3 h-3 rounded-full bg-primary-500 opacity-0 transition-opacity check-mark"></div>
                        </div>
                        <span class="text-slate-700 font-medium select-none">${optText}</span>
                    `;
                    div.onclick = () => this.toggleOption(div);
                    cont.appendChild(div);
                });

                this.updateUIForQuestionState();
                this.updateQuestionListStatus();
            },

                        toggleOption(el) {
                if ($('#submit-btn').disabled) return;

                const allowMulti = (state.currentSubjectKey === 'antoan');

                if (allowMulti) {
                    // Môn An Toàn Lao Động: cho phép chọn nhiều đáp án (toggle)
                    const isSelected = el.classList.contains('selected');
                    if (isSelected) {
                        el.classList.remove('selected');
                        el.querySelector('.check-mark')?.classList.add('opacity-0');
                    } else {
                        el.classList.add('selected');
                        el.querySelector('.check-mark')?.classList.remove('opacity-0');
                    }
                    return;
                }

                // Các môn còn lại: mỗi câu chỉ được chọn 1 đáp án
                const isSelected = el.classList.contains('selected');

                // Bỏ chọn tất cả các đáp án khác
                $$('.option-card').forEach(card => {
                    card.classList.remove('selected');
                    card.querySelector('.check-mark')?.classList.add('opacity-0');
                });

                // Nếu click lại đúng option đang chọn -> bỏ chọn (cho phép về trạng thái chưa chọn)
                if (isSelected) return;

                // Chọn option hiện tại
                el.classList.add('selected');
                el.querySelector('.check-mark')?.classList.remove('opacity-0');
            },

            updateUIForQuestionState() {
                const qIdx = state.pickedIndices[state.currentIndex];
                const q = state.questions[qIdx];
                const isAns = qIdx in state.userAnswers;
                const submitBtn = $('#submit-btn');

                $('#feedback-container').classList.add('hidden');

                if (state.mode !== 'review-wrong') {
                    submitBtn.disabled = isAns;
                    submitBtn.className = isAns
                        ? 'px-6 py-2.5 rounded-xl bg-slate-200 text-slate-400 font-medium cursor-not-allowed'
                        : 'px-6 py-2.5 rounded-xl bg-primary-600 text-white hover:bg-primary-700 font-medium transition-all shadow-lg shadow-primary-500/30 transform active:scale-95';
                    submitBtn.textContent = isAns ? 'Đã trả lời' : 'Trả lời';
                }

                const opts = $$('.option-card');

                // Reset UI trạng thái option
                opts.forEach(o => {
                    o.style.pointerEvents = isAns ? 'none' : 'auto';
                    o.classList.remove('selected', 'correct', 'wrong');
                    o.querySelector('.check-mark')?.classList.add('opacity-0');
                });

                // Nếu đã trả lời: tô đỏ câu sai (có tick), tô xanh câu đúng để dễ học lại
                if (isAns) {
                    const userAns = state.userAnswers[qIdx] || [];
                    const correct = Array.isArray(q.answer) ? q.answer : [q.answer];

                    // Tô đáp án người dùng đã chọn (sai/đúng) và giữ tick
                    userAns.forEach(ai => {
                        const el = opts[ai];
                        if (!el) return;
                        el.querySelector('.check-mark')?.classList.remove('opacity-0');
                        if (correct.includes(ai)) el.classList.add('correct');
                        else el.classList.add('wrong');
                    });

                    // Nếu trả lời sai hoặc đang ở chế độ xem lại câu sai -> tô toàn bộ đáp án đúng
                    const isCorrect = this.checkCorrectness(qIdx, userAns);
                    if (state.mode === 'review-wrong' || !isCorrect) {
                        correct.forEach(ci => {
                            const el = opts[ci];
                            if (el) el.classList.add('correct');
                        });
                    }
                } else {
                    // Chưa trả lời: khôi phục đáp án đang chọn tạm (nếu có)
                    opts.forEach(o => {
                        if (o.classList.contains('selected')) o.querySelector('.check-mark')?.classList.remove('opacity-0');
                    });
                }
            },


                        submitAnswer() {
                const qIdx = state.pickedIndices[state.currentIndex];
                if (qIdx in state.userAnswers) return;

                const allowMulti = (state.currentSubjectKey === 'antoan');

                const selected = [];
                $$('.option-card').forEach((el, i) => { if (el.classList.contains('selected')) selected.push(i); });

                if (selected.length === 0) {
                    alert(allowMulti ? "Chọn ít nhất 1 đáp án." : "Chọn 1 đáp án.");
                    return;
                }
                if (!allowMulti && selected.length > 1) {
                    alert("Mỗi câu chỉ được chọn 1 đáp án.");
                    return;
                }

                state.userAnswers[qIdx] = selected;
                this.updateUIForQuestionState();
                this.updateQuestionListStatus();

                const total = state.pickedIndices.length;
                if (Object.keys(state.userAnswers).length === total) {
                    setTimeout(() => this.finishQuiz(false), 500);
                } else {
                    setTimeout(() => {
                        const next = this.findNextUnansweredQuestionIndex();
                        if (next !== -1) { state.currentIndex = next; this.renderQuestion(); }
                    }, 800);
                }
            },


            findNextUnansweredQuestionIndex() {
                for (let i = state.currentIndex + 1; i < state.pickedIndices.length; i++) { if (!(state.pickedIndices[i] in state.userAnswers)) return i; }
                for (let i = 0; i < state.currentIndex; i++) { if (!(state.pickedIndices[i] in state.userAnswers)) return i; }
                return -1;
            },

            navigateQuestion(dir) {
                const newIdx = state.currentIndex + dir;
                if (newIdx >= 0 && newIdx < state.pickedIndices.length) { state.currentIndex = newIdx; this.renderQuestion(); }
            },

            checkCorrectness(qIdx, uAns) {
                const q = state.questions[qIdx];
                if(!q || !q.answer) return false;
                const s1 = new Set(q.answer);
                const s2 = new Set(uAns);
                return s1.size === s2.size && [...s1].every(x => s2.has(x));
            },

            showHint() {
                const qIdx = state.pickedIndices[state.currentIndex];
                const q = state.questions[qIdx];
                const txt = q.answer.map(i => q.options[i]).join('; ');
                const fb = $('#feedback-container');
                const fbTxt = $('#feedback-text');
                fb.classList.remove('hidden');
                fbTxt.innerHTML = `<span class="font-bold text-yellow-700"><i class="fas fa-lightbulb"></i> Gợi ý:</span> ${txt}`;
            },

            startTimer() {
                const el = $('#timer-text');
                clearInterval(state.timerId);
                el.textContent = `${String(state.testConfig.durationMinutes).padStart(2,'0')}:00`;
                state.timerId = setInterval(() => {
                    if(state.isFinished) { clearInterval(state.timerId); return; }
                    state.secondsLeft--;
                    const m = Math.floor(state.secondsLeft/60);
                    const s = state.secondsLeft%60;
                    el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    if(state.secondsLeft <= 0) { clearInterval(state.timerId); alert("Hết giờ!"); this.finishQuiz(true); }
                }, 1000);
            },

            handleWindowClose() { if (state.mode === 'test' && !state.isFinished) this.finishQuiz(true); },

            reviewWrongAnswers() {
                const wrongs = state.pickedIndices.filter(idx => idx in state.userAnswers && !this.checkCorrectness(idx, state.userAnswers[idx]));
                if (wrongs.length === 0) { alert("Không có câu sai."); return; }
                state.pickedIndices = wrongs; state.currentIndex = 0; state.mode = 'review-wrong'; state.viewedIndices.clear(); state.isFinished = true;
                $('#results-modal').classList.add('hidden');
                this.showScreen('quiz');
                $('#submit-btn').classList.add('hidden'); $('#hint-btn').classList.add('hidden'); $('#stop-btn').classList.remove('hidden');
                this.renderQuestionList(); this.renderQuestion();
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
        
        // Theme Toggle
        const toggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;

        if (localStorage.getItem('theme') === 'light') {
            body.classList.remove('dark-mode');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        } else {
            localStorage.setItem('theme', 'dark');
        }

        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme', 'light');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        });

        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => { if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 67 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false; }
    </script>

    <!-- VISITOR COUNTER SCRIPT -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyCt14_pkmWE0MhD0SeH_MisjmHjlY-Mu84", authDomain: "tracnghiemndt.firebaseapp.com", projectId: "tracnghiemndt", storageBucket: "tracnghiemndt.firebasestorage.app", messagingSenderId: "187385061213", appId: "1:187385061213:web:fe7977f62aaaeec60f52b4", measurementId: "G-TKRBZJT880" };
        let app, auth, db;
        try { app = getApps().length > 0 ? getApp() : initializeApp(cfg); auth = getAuth(app); db = getFirestore(app); } catch(e){}

        const runCounter = async () => {
            if(!auth || !db) return;
            try { await signInAnonymously(auth); } catch(e){ return; }
            onAuthStateChanged(auth, async (u) => {
                if(u) {
                    const ref = doc(db, 'site_stats', 'visitors_v2');
                    const el = document.getElementById('visitor-count');
                    if(!el) return;
                    try {
                        const snap = await getDoc(ref);
                        if(!snap.exists()) await setDoc(ref, {count: 2000});
                        else await updateDoc(ref, {count: increment(1)});
                        onSnapshot(ref, d => { if(d.exists()) el.innerText = d.data().count.toLocaleString('vi-VN'); });
                    } catch(e){}
                }
            });
        };
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', runCounter); else runCounter();
    </script>
</body>
</html>
