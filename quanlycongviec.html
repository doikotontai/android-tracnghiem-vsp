<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản Lý Chất Lượng Công Việc NDT</title>
    <link rel="icon" href="logo.png" type="image/png">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#1e293b', 900: '#0f172a' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s ease; background-color: #f8fafc; color: #334155; font-size: 13px; }
        html.dark body { background-color: #0f172a; color: #cbd5e1; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        html.dark .glass-panel { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        .status-tag { padding: 2px 6px; border-radius: 4px; font-weight: 400; font-size: 0.7rem; display: inline-block; white-space: nowrap; border: 1px solid transparent; }
        
        /* Status Colors */
        .status-Đang-có-NDT { background-color: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .status-Không-có-NDT { background-color: #f8fafc; color: #475569; border-color: #e2e8f0; }
        
        .status-Đang-làm { background-color: #eff6ff; color: #1e40af; border-color: #bfdbfe; } 
        .status-Đã-làm { background-color: #faf5ff; color: #6b21a8; border-color: #e9d5ff; } 
        .status-Đã-xong { background-color: #f0fdf4; color: #166534; border-color: #bbf7d0; } 
        .status-Tạm-dừng { background-color: #fff7ed; color: #9a3412; border-color: #fed7aa; }

        .detail-content { display: block; opacity: 1; padding-top: 0.25rem; }
        
        /* Table & Inputs */
        .shift-table th, .nvsx-table th { font-weight: 500; font-size: 0.7rem; text-align: left; padding: 0.25rem 0.5rem; color: #64748b; background-color: #f8fafc; }
        .shift-table td, .nvsx-table td { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-top: 1px solid #f1f5f9; }
        html.dark .shift-table td, html.dark .nvsx-table td { border-top-color: #334155; color: #cbd5e1; }
        html.dark .shift-table th, html.dark .nvsx-table th { color: #94a3b8; background-color: #1e293b; }
        
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; outline: none; }
        input, select, textarea { font-size: 0.75rem; padding: 0.25rem 0.5rem; }

        .no-select { user-select: none; -webkit-user-select: none; }
        
        /* Custom Scrollbar only for Shift History & Main NVSX Grid */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col no-select">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm border-b border-slate-200 dark:border-white/5 h-12">
        <div class="max-w-[1920px] mx-auto px-4 h-full grid grid-cols-3 items-center">
            
            <!-- Left -->
            <div class="flex items-center gap-2">
                <a href="index.html" class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 transition" title="Về trang chủ">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </a>
                <div id="connection-status" class="hidden md:flex items-center gap-1.5 px-2 py-0.5 rounded bg-slate-50 dark:bg-slate-800/50 text-[10px] text-slate-400 border border-slate-200 dark:border-slate-700">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-slate-500"></span>
                    </span>
                    Syncing
                </div>
            </div>

            <!-- Center -->
            <div class="flex flex-col items-center justify-center">
                <h1 class="text-sm font-medium text-slate-700 dark:text-slate-200 uppercase tracking-wide">Quản Lý Công Việc NDT</h1>
            </div>

            <!-- Right -->
            <div class="flex items-center justify-end gap-2">
                <button id="theme-toggle" class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-500"><i data-lucide="moon" class="w-4 h-4"></i></button>
                <div class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 text-xs shadow-sm">U</div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-grow w-full px-2 py-3 space-y-3 max-w-[1920px] mx-auto">
        
        <!-- Controls -->
        <div class="glass-panel p-2 rounded-lg flex flex-col sm:flex-row gap-2 justify-between items-center sticky top-12 z-40">
            <div class="flex items-center gap-2 w-full sm:w-auto flex-1">
                <div class="relative">
                    <select id="sort-by" class="appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded pl-2 pr-6 py-1 text-xs focus:border-blue-500 cursor-pointer">
                        <option value="name_asc">Tên Giàn (A-Z)</option>
                        <option value="status">Trạng Thái NDT</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-1 top-1.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                </div>

                <div class="relative flex-1 max-w-sm group">
                    <i data-lucide="search" class="absolute left-2 top-1.5 w-3.5 h-3.5 text-slate-400 group-focus-within:text-blue-500"></i>
                    <input type="text" id="search-input" placeholder="Tìm kiếm..." 
                        class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded pl-7 pr-2 py-1 text-xs focus:border-blue-500 transition-all placeholder:text-slate-400">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center gap-2 w-full md:w-auto">
                <button onclick="window.exportToExcel()" class="flex-1 md:flex-none flex items-center justify-center gap-1.5 bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded text-xs shadow-sm transition active:scale-95">
                    <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> Excel
                </button>
                <button onclick="window.addNewRig()" class="flex-1 md:flex-none flex items-center justify-center gap-1.5 bg-slate-700 hover:bg-slate-800 text-white py-1 px-3 rounded text-xs shadow-sm transition active:scale-95">
                    <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> Thêm Giàn
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-container" class="space-y-4 pb-10">
            <!-- Loader -->
            <div class="animate-pulse space-y-3">
                <div class="h-32 bg-slate-100 dark:bg-slate-800 rounded-lg"></div>
                <div class="h-32 bg-slate-100 dark:bg-slate-800 rounded-lg"></div>
            </div>
        </div>

    </main>

    <!-- Code Protection Script (Anti-Debug) -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { return false; } 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } 
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } 
        }
    </script>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Obfuscated config 
        const _0x1a2b = {
            k: atob("QUl6YVN5Q3QxNF9wa21XRTBNaEQwU2VIX01pc2ptSGpsWS1NdTg0"), 
            d: "tracnghiemndt.firebaseapp.com",
            p: "tracnghiemndt",
            b: "tracnghiemndt.firebasestorage.app",
            s: "187385061213",
            i: "1:187385061213:web:fe7977f62aaaeec60f52b4",
            m: "G-TKRBZJT880"
        };

        const firebaseConfig = {
            apiKey: _0x1a2b.k,
            authDomain: _0x1a2b.d,
            projectId: _0x1a2b.p,
            storageBucket: _0x1a2b.b,
            messagingSenderId: _0x1a2b.s,
            appId: _0x1a2b.i,
            measurementId: _0x1a2b.m
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const DOC_REF = doc(db, 'app_data', 'quanlycongviec_live'); 

        const SEED_DATA = { "items": {} };

        let currentData = {};
        let historyViewMode = new Set(); 
        let nvsxHistoryViewMode = new Set(); 
        let editModes = {}; 
        let nvsxEditModes = {}; 

        // --- CORE FUNCTIONS ---

        const initApp = async () => {
            const statusEl = document.getElementById('connection-status');
            try { await signInAnonymously(auth); } catch (error) {
                console.error("Auth Err");
                if(statusEl) { statusEl.innerText = "Err"; statusEl.classList.add("text-red-500"); }
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    onSnapshot(DOC_REF, async (snap) => {
                        if (snap.exists()) {
                            currentData = snap.data();
                            renderDashboard();
                            if(statusEl) {
                                statusEl.innerHTML = `<span class="relative flex h-1.5 w-1.5"><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span></span> Sync`;
                                statusEl.className = "hidden md:flex items-center gap-1.5 px-2 py-0.5 rounded bg-green-50 dark:bg-green-900/20 text-[10px] text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800";
                            }
                        } else {
                            if(statusEl) statusEl.innerText = "Init...";
                            try { await setDoc(DOC_REF, SEED_DATA); } catch (e) { console.error("Init Err"); }
                        }
                    }, (error) => {
                        console.error("FS Err");
                        if(statusEl) { statusEl.innerText = "Offline"; statusEl.classList.add("text-red-500"); }
                    });
                }
            });
        };

        const getCurrentTime = () => {
            const now = new Date();
            return `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        };

        const renderDashboard = () => {
            const container = document.getElementById('dashboard-container');
            const sortBy = document.getElementById('sort-by').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            let rigs = Object.entries(currentData.items || {}).map(([k, v]) => ({ key: k, ...v }));

            if (searchTerm) {
                rigs = rigs.filter(rig => {
                    const matchName = rig.Fullname.toLowerCase().includes(searchTerm) || rig.key.toLowerCase().includes(searchTerm);
                    const matchNVSX = rig.NVSX ? Object.keys(rig.NVSX).some(k => k.toLowerCase().includes(searchTerm)) : false;
                    return matchName || matchNVSX;
                });
            }

            rigs.sort((a, b) => {
                if (sortBy === 'name_asc') return a.Fullname.localeCompare(b.Fullname);
                return (a.NDT_Status || "").localeCompare(b.NDT_Status || "");
            });

            if (rigs.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-10 text-sm">Không tìm thấy dữ liệu.</div>`;
                return;
            }

            container.innerHTML = rigs.map(rig => {
                const shiftHistory = Array.isArray(rig.ShiftHistory) ? rig.ShiftHistory : [];
                const latestShift = shiftHistory.length > 0 ? shiftHistory[0] : { Staff: '---', Date: '---' };
                const isShiftHistoryMode = historyViewMode.has(rig.key);
                const isNVSXHistoryMode = nvsxHistoryViewMode.has(rig.key);
                const ndtStatus = rig.NDT_Status || "Không có NDT";
                const ndtClass = sanitize(ndtStatus);

                const allNVSX = Object.entries(rig.NVSX || {});
                const visibleNVSX = isNVSXHistoryMode ? allNVSX : allNVSX.slice(0, 8); 

                const nvsxContentHtml = visibleNVSX.map(([nk, nv]) => {
                    const h = nv.Header || {};
                    const isEditing = nvsxEditModes[`${rig.key}-${nk}`];
                    const totalWeld = h.TotalWelds || '0';
                    const totalNdtCount = h.TotalNDT || '0';
                    const detailText = h.Detail || '';
                    
                    // --- NVSX EDIT MODE ---
                    if (isEditing) {
                        return `
                            <div class="bg-white dark:bg-slate-800 p-2 rounded border border-blue-400 shadow-md relative text-xs">
                                <div class="grid gap-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input id="edit-nvsx-id-${rig.key}-${nk}" value="${nk}" class="w-full border rounded px-1 py-0.5" placeholder="Số NVSX">
                                        <input id="edit-nvsx-method-${rig.key}-${nk}" value="${h.Method || ''}" class="w-full border rounded px-1 py-0.5" placeholder="Phương pháp">
                                    </div>
                                    <input id="edit-nvsx-title-${rig.key}-${nk}" value="${h.Title || ''}" class="w-full border rounded px-1 py-0.5" placeholder="Nội dung">
                                    <div class="grid grid-cols-3 gap-2">
                                        <input id="edit-nvsx-weld-${rig.key}-${nk}" value="${totalWeld}" type="number" class="border rounded px-1 py-0.5" placeholder="Weld">
                                        <input id="edit-nvsx-ndt-${rig.key}-${nk}" value="${totalNdtCount}" type="number" class="border rounded px-1 py-0.5" placeholder="NDT">
                                        <input id="edit-nvsx-progress-${rig.key}-${nk}" value="${h.ProgressText || ''}" class="border rounded px-1 py-0.5" placeholder="%">
                                    </div>
                                    <div class="flex justify-end gap-2 mt-1">
                                        <button onclick="window.saveNVSX('${rig.key}', '${nk}')" class="bg-blue-600 text-white px-2 py-0.5 rounded hover:bg-blue-700">Lưu</button>
                                        <button onclick="window.toggleNVSXEdit('${rig.key}', '${nk}')" class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded">Hủy</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // --- NVSX DISPLAY MODE ---
                    const statusClass = sanitize(h.Status);
                    const cardContent = `
                        <div class="bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700 hover:shadow-md transition group h-full flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-blue-600 dark:text-blue-400 text-xs">${nk}</span>
                                    <div class="flex items-center gap-1">
                                        <span class="status-tag status-${statusClass} cursor-pointer hover:opacity-80" 
                                              onclick="window.updateNVSXStatus('${rig.key}', '${nk}', '${h.Status}')">${h.Status}</span>
                                        <div class="flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="window.toggleNVSXEdit('${rig.key}', '${nk}')" class="p-0.5 text-slate-400 hover:text-blue-500"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                            <button onclick="window.deleteNVSX('${rig.key}', '${nk}')" class="p-0.5 text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-700 dark:text-slate-300 mb-1 line-clamp-2" title="${h.Title}">${h.Title || '---'}</p>
                                <div class="grid grid-cols-2 gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                                    <span>PP: ${h.Method || '-'}</span>
                                    <span class="text-right">Tiến độ: ${h.ProgressText || '-'}</span>
                                    <!-- RENAMED LABELS -->
                                    <span class="truncate">Tổng số mối: <b class="text-slate-700 dark:text-slate-200">${totalWeld}</b></span>
                                    <span class="text-right truncate">Đã NDT: <b class="text-blue-600 dark:text-blue-400">${totalNdtCount}</b></span>
                                </div>
                            </div>
                            <!-- Inline Detail - Expanded Automatically -->
                            <div class="mt-2 pt-1 border-t border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-0.5">
                                    <span class="text-[10px] text-slate-400 uppercase">Chi tiết công việc</span>
                                    <button onclick="window.editNVSXDetail('${rig.key}', '${nk}')" class="text-slate-300 hover:text-blue-500" title="Sửa chi tiết"><i data-lucide="edit-3" class="w-2.5 h-2.5"></i></button>
                                </div>
                                <div id="detail-nvsx-${rig.key}-${nk}" class="text-[11px] text-slate-600 dark:text-slate-400 whitespace-pre-wrap leading-tight">
                                    ${detailText || '-'}
                                </div>
                            </div>
                        </div>
                    `;

                    if (isNVSXHistoryMode) {
                        return `
                             <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700/50">
                                <td class="px-2 py-1 align-top text-blue-600 font-medium">${nk}</td>
                                <td class="px-2 py-1 align-top text-slate-700 dark:text-slate-300">
                                    ${h.Title} <br><span class="text-[10px] text-slate-400 whitespace-pre-wrap">${detailText}</span>
                                </td>
                                <td class="px-2 py-1 align-top"><span class="status-tag status-${statusClass}" onclick="window.updateNVSXStatus('${rig.key}', '${nk}', '${h.Status}')">${h.Status}</span></td>
                                <td class="px-2 py-1 align-top text-slate-500">${h.Method}</td>
                                <td class="px-2 py-1 align-top text-slate-500">${h.ProgressText} (Tổng:${totalWeld}/NDT:${totalNdtCount})</td>
                                <td class="px-2 py-1 align-top text-right">
                                    <button onclick="window.toggleNVSXEdit('${rig.key}', '${nk}')" class="text-blue-500 hover:text-blue-700 mr-2"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button onclick="window.deleteNVSX('${rig.key}', '${nk}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </td>
                            </tr>
                        `;
                    }
                    return cardContent;
                }).join('');

                const eqItems = rig.Inventory.Equipment.Items || '';
                const matItems = rig.Inventory.Materials.Items || '';

                // Shift Section
                let shiftContent = '';
                const shiftHeader = `
                    <div class="flex justify-between items-center mb-2 pb-1 border-b border-slate-100 dark:border-slate-700">
                        <h4 class="font-medium text-xs text-slate-500 dark:text-slate-400 uppercase flex items-center">
                            <i data-lucide="users" class="w-3.5 h-3.5 mr-1.5 text-purple-500"></i> Ca Biển
                        </h4>
                        <button onclick="window.addNewShift('${rig.key}')" class="text-[10px] text-purple-600 dark:text-purple-400 hover:underline">+ Thêm</button>
                    </div>
                `;

                if (!isShiftHistoryMode) {
                    shiftContent = `
                        ${shiftHeader}
                        <div class="flex flex-col gap-2">
                            <div>
                                <p class="text-[10px] text-slate-400 mb-0.5">Nhân sự</p>
                                <p class="text-sm text-slate-700 dark:text-slate-200 flex items-center">
                                    ${latestShift.Staff}
                                </p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 mb-0.5">Thời gian</p>
                                <p class="text-sm text-slate-700 dark:text-slate-200 flex items-center">
                                    ${latestShift.Date}
                                </p>
                            </div>
                            <div class="mt-2 pt-1 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-[10px] text-slate-400">
                                <span>Upd: ${rig.ShiftLastUpdated ? rig.ShiftLastUpdated.split(' ')[1] : '-'}</span>
                                <button onclick="window.toggleHistoryMode('${rig.key}')" class="text-blue-500 hover:underline">Lịch sử</button>
                            </div>
                        </div>
                    `;
                } else {
                    // History Table Mode (Compact)
                    const tableRows = shiftHistory.map((s, idx) => {
                         const isEditing = editModes[`${rig.key}-${idx}`];
                         if (isEditing) {
                             return `<tr class="bg-blue-50 dark:bg-blue-900/20"><td colspan="3" class="p-1">
                                <input id="edit-staff-${rig.key}-${idx}" value="${s.Staff}" class="w-full mb-1 border rounded px-1 text-xs">
                                <input id="edit-date-${rig.key}-${idx}" value="${s.Date}" class="w-full mb-1 border rounded px-1 text-xs">
                                <div class="flex justify-end gap-2">
                                    <button onclick="window.saveShift('${rig.key}', ${idx})" class="text-green-600"><i data-lucide="check" class="w-3 h-3"></i></button>
                                    <button onclick="window.toggleEditMode('${rig.key}', ${idx})" class="text-slate-400"><i data-lucide="x" class="w-3 h-3"></i></button>
                                </div>
                             </td></tr>`;
                         }
                         return `<tr class="border-b border-slate-100 dark:border-slate-700/50 group">
                            <td class="py-1 text-xs text-slate-700 dark:text-slate-300">${s.Staff}<br><span class="text-[10px] text-slate-400">${s.Date}</span></td>
                            <td class="py-1 text-right align-top w-12">
                                <div class="hidden group-hover:flex justify-end gap-1">
                                    <button onclick="window.toggleEditMode('${rig.key}', ${idx})" class="text-blue-400"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button onclick="window.deleteShift('${rig.key}', ${idx})" class="text-red-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            </td>
                         </tr>`;
                    }).join('');
                    
                    shiftContent = `
                        ${shiftHeader}
                        <div class="flex flex-col h-40">
                             <button onclick="window.toggleHistoryMode('${rig.key}')" class="text-[10px] text-slate-400 mb-1 flex items-center hover:text-slate-600"><i data-lucide="arrow-left" class="w-3 h-3 mr-1"></i> Quay lại</button>
                             <div class="overflow-y-auto custom-scrollbar flex-1 pr-1">
                                <table class="w-full">
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">${tableRows}</tbody>
                                </table>
                             </div>
                        </div>
                    `;
                }

                // Inventory Section - AUTO EXPANDED
                const inventoryContent = `
                    <div class="flex justify-between items-center mb-2 pb-1 border-b border-slate-100 dark:border-slate-700">
                        <h4 class="font-medium text-xs text-slate-500 dark:text-slate-400 uppercase flex items-center">
                            <i data-lucide="box" class="w-3.5 h-3.5 mr-1.5 text-blue-500"></i> Vật Tư Thiết Bị
                        </h4>
                        <span class="text-[10px] text-slate-400">${rig.Inventory.LastUpdated ? rig.Inventory.LastUpdated.split(' ')[1] : '-'}</span>
                    </div>
                    <div class="space-y-3">
                        <!-- Eq -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-slate-600 dark:text-slate-400 flex items-center">TB
                                    <button class="ml-1 text-slate-300 hover:text-blue-500" onclick="window.editInventoryItems('${rig.key}', 'Equipment')"><i data-lucide="edit-3" class="w-2.5 h-2.5"></i></button>
                                </span>
                                <span class="status-tag status-${sanitize(rig.Inventory.Equipment.Available)} cursor-pointer scale-90 origin-right" onclick="window.toggleInventory('${rig.key}', 'Equipment')">${rig.Inventory.Equipment.Available}</span>
                            </div>
                            <div class="detail-content" id="detail-${rig.key}-Equipment">
                                <p class="text-xs text-slate-600 dark:text-slate-300 whitespace-pre-wrap pl-2 border-l-2 border-slate-200 dark:border-slate-600 ml-0.5">${eqItems || '-'}</p>
                            </div>
                        </div>
                        <!-- Mat -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-slate-600 dark:text-slate-400 flex items-center">VT
                                    <button class="ml-1 text-slate-300 hover:text-blue-500" onclick="window.editInventoryItems('${rig.key}', 'Materials')"><i data-lucide="edit-3" class="w-2.5 h-2.5"></i></button>
                                </span>
                                <span class="status-tag status-${sanitize(rig.Inventory.Materials.Available)} cursor-pointer scale-90 origin-right" onclick="window.toggleInventory('${rig.key}', 'Materials')">${rig.Inventory.Materials.Available}</span>
                            </div>
                            <div class="detail-content" id="detail-${rig.key}-Materials">
                                <p class="text-xs text-slate-600 dark:text-slate-300 whitespace-pre-wrap pl-2 border-l-2 border-slate-200 dark:border-slate-600 ml-0.5">${matItems || '-'}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Main Rig Card Structure
                return `
                    <div class="glass-panel p-3 rounded-lg border-l-4 ${ndtStatus === 'Đang có NDT' ? 'border-l-green-500' : 'border-l-slate-400'} hover:shadow-md transition-all duration-200">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100 dark:border-slate-700/50">
                             <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded bg-slate-100 dark:bg-slate-700 flex items-center justify-center font-medium text-slate-500 text-sm border border-slate-200 dark:border-slate-600">
                                    ${rig.key.substring(0,2)}
                                </div>
                                <h3 class="font-medium text-slate-800 dark:text-white text-base flex items-center gap-1">
                                    ${rig.Fullname}
                                    <button onclick="window.updateRigName('${rig.key}', '${rig.Fullname}')" class="text-slate-300 hover:text-blue-500 p-0.5"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                                    <button onclick="window.deleteRig('${rig.key}')" class="text-slate-300 hover:text-red-500 p-0.5"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </h3>
                             </div>
                             <span class="status-tag status-${ndtClass} cursor-pointer text-xs px-2 py-0.5 border hover:bg-slate-50 dark:hover:bg-slate-700/50 transition select-none rounded flex items-center gap-1" 
                                      onclick="window.toggleNDTStatus('${rig.key}', '${ndtStatus}')">
                                    ${ndtStatus === 'Đang có NDT' ? '<i data-lucide="check-circle-2" class="w-3 h-3"></i>' : '<i data-lucide="x-circle" class="w-3 h-3"></i>'}
                                    ${ndtStatus}
                             </span>
                        </div>

                        <!-- Grid Content -->
                        <div class="${isNVSXHistoryMode ? 'block' : 'grid grid-cols-1 lg:grid-cols-4 gap-3'}">
                            ${isNVSXHistoryMode ? nvsxWrapper : `
                                <!-- 1. Shift -->
                                <div class="col-span-1 bg-white dark:bg-slate-800/40 p-2 rounded border border-slate-100 dark:border-slate-700/50">
                                    ${shiftContent}
                                </div>
                                <!-- 2. Inventory -->
                                <div class="col-span-1 bg-white dark:bg-slate-800/40 p-2 rounded border border-slate-100 dark:border-slate-700/50">
                                    ${inventoryContent}
                                </div>
                                <!-- 3. Tasks -->
                                <div class="col-span-1 lg:col-span-2 flex flex-col h-full">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-medium text-xs text-slate-500 dark:text-slate-400 uppercase flex items-center">
                                            <i data-lucide="list-todo" class="w-3.5 h-3.5 mr-1.5 text-orange-500"></i> Công Việc (${allNVSX.length})
                                        </h4>
                                        <button onclick="window.addNVSX('${rig.key}')" class="text-[10px] bg-green-50 text-green-600 px-2 py-0.5 rounded border border-green-200 hover:bg-green-100 transition">
                                            + Thêm NVSX
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 overflow-y-auto custom-scrollbar max-h-80">
                                        ${nvsxContentHtml || '<div class="col-span-full text-center py-4 text-xs text-slate-400 italic border border-dashed border-slate-200 dark:border-slate-700 rounded">Trống</div>'}
                                    </div>
                                    ${allNVSX.length > 0 ? `
                                        <div class="mt-2 text-right">
                                            <button onclick="window.toggleNVSXHistory('${rig.key}')" class="text-[10px] text-blue-500 hover:underline">Xem tất cả ></button>
                                        </div>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        };

        // ... (Keep existing Logic Actions: toggleNDTStatus, toggleHistoryMode, addNewShift, saveShift, deleteShift, addNVSX, toggleNVSXEdit, editNVSXDetail, saveNVSXDetail, saveNVSX, deleteNVSX, updateNVSXStatus, toggleInventory, editInventoryItems, saveInventoryItem, updateRigName, addNewRig, deleteRig, exportToExcel, cancelEdit, sanitize) ...
        
        // --- RE-INSERTING LOGIC FUNCTIONS (To ensure they are present in the final file) ---
        window.toggleNDTStatus = async (key, currentStatus) => {
            if (!confirm(`Đổi trạng thái thành "${currentStatus === 'Không có NDT' ? 'Đang có NDT' : 'Không có NDT'}"?`)) return;
            const newStatus = currentStatus === 'Không có NDT' ? 'Đang có NDT' : 'Không có NDT';
            await updateDoc(DOC_REF, { [`items.${key}.NDT_Status`]: newStatus });
        };
        window.toggleHistoryMode = (key) => {
            if (historyViewMode.has(key)) historyViewMode.delete(key); else historyViewMode.add(key);
            renderDashboard();
        };
        window.toggleNVSXHistory = (key) => {
            if (nvsxHistoryViewMode.has(key)) nvsxHistoryViewMode.delete(key); else nvsxHistoryViewMode.add(key);
            renderDashboard();
        };
        window.addNewShift = async (key) => {
            const staff = prompt("Nhập tên nhân sự:"); if (!staff) return;
            const date = prompt("Nhập thời gian:"); if (!date) return;
            const currentItem = currentData.items[key];
            const currentHistory = Array.isArray(currentItem.ShiftHistory) ? currentItem.ShiftHistory : [];
            const newHistory = [{ Staff: staff, Date: date }, ...currentHistory];
            await updateDoc(DOC_REF, { [`items.${key}.ShiftHistory`]: newHistory, [`items.${key}.ShiftLastUpdated`]: getCurrentTime() });
        };
        window.toggleEditMode = (key, idx) => {
            const editKey = `${key}-${idx}`; if (editModes[editKey]) delete editModes[editKey]; else editModes[editKey] = true;
            renderDashboard();
        };
        window.saveShift = async (key, idx) => {
            if (!confirm('Lưu thay đổi?')) return;
            const staff = document.getElementById(`edit-staff-${key}-${idx}`).value;
            const date = document.getElementById(`edit-date-${key}-${idx}`).value;
            const currentHistory = [...currentData.items[key].ShiftHistory];
            currentHistory[idx] = { ...currentHistory[idx], Staff: staff, Date: date };
            await updateDoc(DOC_REF, { [`items.${key}.ShiftHistory`]: currentHistory, [`items.${key}.ShiftLastUpdated`]: getCurrentTime() });
            delete editModes[`${key}-${idx}`];
        };
        window.deleteShift = async (key, idx) => {
            if (!confirm('Xóa ca này?')) return;
            const currentHistory = [...currentData.items[key].ShiftHistory];
            currentHistory.splice(idx, 1);
            await updateDoc(DOC_REF, { [`items.${key}.ShiftHistory`]: currentHistory, [`items.${key}.ShiftLastUpdated`]: getCurrentTime() });
        };
        window.addNVSX = async (rigKey) => {
            const nvsxId = prompt("Nhập số NVSX:"); if (!nvsxId) return;
            const title = prompt("Nhập nội dung:"); if (!title) return;
            const path = `items.${rigKey}.NVSX.${nvsxId}`;
            const newNVSXData = { Header: { Title: title, Detail: "", Status: "Đang làm", Method: "", ProgressText: "Mới tạo", TotalWelds: "0", TotalNDT: "0" }, Progress: {} };
            await updateDoc(DOC_REF, { [path]: newNVSXData, [`items.${rigKey}.NVSXLastUpdated`]: getCurrentTime() });
        };
        window.toggleNVSXEdit = (rigKey, nvsxKey) => {
            const editKey = `${rigKey}-${nvsxKey}`; if (nvsxEditModes[editKey]) delete nvsxEditModes[editKey]; else nvsxEditModes[editKey] = true;
            renderDashboard();
        };
        window.editNVSXDetail = (rigKey, nvsxKey) => {
             const containerId = `detail-nvsx-${rigKey}-${nvsxKey}`;
             const container = document.getElementById(containerId);
             if(!container) return;
             const currentVal = currentData.items[rigKey].NVSX[nvsxKey].Header.Detail || '';
             container.innerHTML = `<div class="mt-1 animate-fade-in"><textarea id="input-nvsx-detail-${rigKey}-${nvsxKey}" class="w-full p-1 text-xs border rounded bg-slate-50 dark:bg-slate-900 dark:border-slate-700 dark:text-white outline-none" rows="2" placeholder="Chi tiết...">${currentVal}</textarea><div class="flex gap-1 mt-1 justify-end"><button onclick="window.cancelEdit()" class="px-2 py-0.5 text-[10px] bg-slate-200 rounded text-slate-600">Hủy</button><button onclick="window.saveNVSXDetail('${rigKey}', '${nvsxKey}')" class="px-2 py-0.5 text-[10px] bg-blue-600 text-white rounded">Lưu</button></div></div>`;
        };
        window.saveNVSXDetail = async (rigKey, nvsxKey) => {
            if(!confirm('Lưu chi tiết?')) return;
            const val = document.getElementById(`input-nvsx-detail-${rigKey}-${nvsxKey}`).value;
            await updateDoc(DOC_REF, { [`items.${rigKey}.NVSX.${nvsxKey}.Header.Detail`]: val, [`items.${rigKey}.NVSXLastUpdated`]: getCurrentTime() });
        };
        window.saveNVSX = async (rigKey, oldNvsxKey) => {
            if (!confirm('Lưu thay đổi?')) return;
            const newId = document.getElementById(`edit-nvsx-id-${rigKey}-${oldNvsxKey}`).value.trim();
            const newTitle = document.getElementById(`edit-nvsx-title-${rigKey}-${oldNvsxKey}`).value;
            const newMethod = document.getElementById(`edit-nvsx-method-${rigKey}-${oldNvsxKey}`).value;
            const newProgress = document.getElementById(`edit-nvsx-progress-${rigKey}-${oldNvsxKey}`).value;
            const newTotalWeld = document.getElementById(`edit-nvsx-weld-${rigKey}-${oldNvsxKey}`).value;
            const newTotalNdt = document.getElementById(`edit-nvsx-ndt-${rigKey}-${oldNvsxKey}`).value;
            if (!newId) return alert("Số NVSX trống");
            const currentNVSX = currentData.items[rigKey].NVSX[oldNvsxKey];
            if (newId !== oldNvsxKey) { await updateDoc(DOC_REF, { [`items.${rigKey}.NVSX.${oldNvsxKey}`]: deleteField() }); }
            const path = `items.${rigKey}.NVSX.${newId}`;
            const newData = { Header: { Title: newTitle, Status: currentNVSX.Header.Status, Method: newMethod, ProgressText: newProgress, TotalWelds: newTotalWeld, TotalNDT: newTotalNdt, Detail: currentNVSX.Header.Detail || '' }, Progress: currentNVSX.Progress || {} };
            await updateDoc(DOC_REF, { [path]: newData, [`items.${rigKey}.NVSXLastUpdated`]: getCurrentTime() });
            delete nvsxEditModes[`${rigKey}-${oldNvsxKey}`];
        };
        window.deleteNVSX = async (rigKey, nvsxKey) => {
            if (!confirm(`Xóa NVSX ${nvsxKey}?`)) return;
            await updateDoc(DOC_REF, { [`items.${rigKey}.NVSX.${nvsxKey}`]: deleteField(), [`items.${rigKey}.NVSXLastUpdated`]: getCurrentTime() });
        };
        window.updateNVSXStatus = async (rigKey, nvsxKey, oldStatus) => {
            const statuses = ["Đang làm", "Đã xong", "Tạm dừng"];
            let promptText = `Chọn trạng thái (Nhập số):\n`; statuses.forEach((s, i) => promptText += `${i+1}. ${s}\n`);
            const choice = prompt(promptText); if (!choice) return;
            const index = parseInt(choice) - 1;
            if (index >= 0 && index < statuses.length) {
                if (statuses[index] !== oldStatus) await updateDoc(DOC_REF, { [`items.${rigKey}.NVSX.${nvsxKey}.Header.Status`]: statuses[index], [`items.${rigKey}.NVSXLastUpdated`]: getCurrentTime() });
            } else alert("Sai");
        };
        window.toggleInventory = async (rigKey, type) => {
            if (!confirm(`Đổi trạng thái tồn kho?`)) return;
            const current = currentData.items[rigKey].Inventory[type].Available;
            const next = current === 'Còn' ? 'Hết' : 'Còn';
            await updateDoc(DOC_REF, { [`items.${rigKey}.Inventory.${type}.Available`]: next, [`items.${rigKey}.Inventory.LastUpdated`]: getCurrentTime() });
        };
        window.editInventoryItems = (rigKey, type) => {
            const containerId = `detail-${rigKey}-${type}`; const container = document.getElementById(containerId); if (!container) return;
            const currentVal = currentData.items[rigKey].Inventory[type].Items || '';
            container.innerHTML = `<div class="mt-2 animate-fade-in"><textarea id="input-${rigKey}-${type}" class="w-full p-2 text-xs border rounded bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-white outline-none" rows="3">${currentVal}</textarea><div class="flex gap-1 mt-1 justify-end"><button onclick="window.cancelEdit()" class="px-2 py-0.5 text-xs bg-slate-200 rounded text-slate-600">Hủy</button><button onclick="window.saveInventoryItem('${rigKey}', '${type}')" class="px-2 py-0.5 text-xs bg-blue-600 text-white rounded">Lưu</button></div></div>`;
        };
        window.saveInventoryItem = async (rigKey, type) => {
            if (!confirm('Lưu thay đổi?')) return;
            const val = document.getElementById(`input-${rigKey}-${type}`).value;
            await updateDoc(DOC_REF, { [`items.${rigKey}.Inventory.${type}.Items`]: val, [`items.${rigKey}.Inventory.LastUpdated`]: getCurrentTime() });
        };
        window.updateRigName = async (key, oldName) => {
            const newName = prompt("Tên mới:", oldName);
            if (newName && newName !== oldName && confirm(`Đổi tên thành "${newName}"?`)) { await updateDoc(DOC_REF, { [`items.${key}.Fullname`]: newName }); }
        };
        window.addNewRig = async () => {
            const rigName = prompt("Tên giàn (VD: BK-20):"); if (!rigName) return;
            const rigKey = rigName.replace(/\s+/g, '_').replace(/\//g, '-');
            if (currentData.items && currentData.items[rigKey]) return alert("Đã tồn tại!");
            const newRigData = { Fullname: rigName, Owner: "", NDT_Status: "Không có NDT", ShiftHistory: [], Inventory: { Equipment: { Available: "Hết", Items: "" }, Materials: { Available: "Hết", Items: "" } }, NVSX: {} };
            await updateDoc(DOC_REF, { [`items.${rigKey}`]: newRigData });
        };
        window.deleteRig = async (rigKey) => {
            if (confirm(`XÓA VĨNH VIỄN giàn ${rigKey}?`)) {
                if (prompt(`Nhập lại "${rigKey}" để xóa:`) === rigKey) { await updateDoc(DOC_REF, { [`items.${rigKey}`]: deleteField() }); } else alert("Sai mã.");
            }
        };
        window.exportToExcel = () => {
             if (!currentData || !currentData.items) return alert("No data");
             const overviewData = [], tasksData = [];
             Object.entries(currentData.items).forEach(([key, rig]) => {
                const shifts = rig.ShiftHistory || [];
                overviewData.push({ "Mã": key, "Tên": rig.Fullname, "TT NDT": rig.NDT_Status, "Nhân Sự": shifts[0]?.Staff, "Ngày": shifts[0]?.Date, "TT TB": rig.Inventory?.Equipment?.Available, "CT TB": rig.Inventory?.Equipment?.Items, "TT VT": rig.Inventory?.Materials?.Available, "CT VT": rig.Inventory?.Materials?.Items });
                Object.entries(rig.NVSX || {}).forEach(([id, t]) => { tasksData.push({ "Mã": key, "Tên": rig.Fullname, "Số NVSX": id, "Nội Dung": t.Header.Title, "Chi Tiết": t.Header.Detail, "Trạng Thái": t.Header.Status, "PP": t.Header.Method, "Tiến Độ": t.Header.ProgressText, "Weld": t.Header.TotalWelds, "NDT": t.Header.TotalNDT }); });
             });
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(overviewData), "TongHop");
             XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tasksData), "CongViec");
             XLSX.writeFile(wb, `QuanLyNDT_${new Date().toISOString().slice(0,10)}.xlsx`);
        };
        window.cancelEdit = () => { renderDashboard(); };
        function sanitize(str) { return str ? str.replace(/ /g, '-').replace(/[^a-zA-Z0-9-\u00C0-\u1EF9]/g, '') : ''; }

        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            };
            document.getElementById('sort-by').onchange = renderDashboard;
            document.getElementById('search-input').oninput = renderDashboard;
            initApp();
        });
    </script>
</body>
</html>
