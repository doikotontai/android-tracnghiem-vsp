<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Learning Content Galaxy - VEO3</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    holo: {
                        bg: "#050810",
                        surface: "rgba(10, 20, 35, 0.9)", 
                        border: "rgba(100, 220, 255, 0.3)",
                        text: "#d0e0ff",
                        cyan: "#00f0ff",
                        purple: "#bc13fe",
                        green: "#0aff0a",
                        blue: "#3b82f6"
                    }
                },
                fontFamily: {
                    sans: ["Inter", "sans-serif"],
                    display: "Be Vietnam Pro"
                },
                animation: {
                    'pulse-glow': 'pulseGlow 4s infinite alternate',
                    'spin-slow': 'spin 20s linear infinite',
                },
                keyframes: {
                    pulseGlow: {
                        '0%': { opacity: 0.8, filter: 'brightness(1)' },
                        '100%': { opacity: 1, filter: 'brightness(1.3)' },
                    }
                }
            }
        }
    };
</script>
<style type="text/tailwindcss">
    body {
        @apply bg-holo-bg text-holo-text overflow-hidden font-sans;
        touch-action: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- Background --- */
    .conceptual-map-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: 
            radial-gradient(circle at 50% 50%, rgba(20, 30, 60, 0.4) 0%, rgba(5, 8, 16, 1) 80%),
            linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        perspective: 1000px;
        will-change: transform; /* Tối ưu render */
    }

    /* --- Connecting Lines --- */
    .connecting-line {
        position: absolute;
        height: 1px;
        background: linear-gradient(90deg, rgba(0, 240, 255, 0.1), rgba(0, 240, 255, 0.6), rgba(0, 240, 255, 0.1));
        transform-origin: 0 50%;
        pointer-events: none;
        z-index: 5;
        opacity: 0;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    }

    /* --- Nodes Common --- */
    .map-node {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        backdrop-filter: blur(4px);
        /* Tinh chỉnh transition để mượt hơn */
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease;
        will-change: transform, left, top;
        -webkit-user-select: none;
        user-select: none;
    }

    .node-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0) translateZ(0) !important;
    }

    /* --- Main Node (Sun) --- */
    .map-node.type-main {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.9) 0%, rgba(0, 220, 255, 0.6) 20%, rgba(0, 80, 200, 0.8) 50%, rgba(0, 10, 30, 0.95) 100%);
        box-shadow: 0 0 30px rgba(0, 200, 255, 0.4);
        border: 1px solid rgba(100, 220, 255, 0.4);
        color: white;
        font-weight: 700;
        font-size: 1rem;
        text-align: center;
        z-index: 20;
    }
    .map-node.type-main::after {
        content: '';
        position: absolute;
        inset: -10px;
        border-radius: 50%;
        border: 1px dashed rgba(0, 240, 255, 0.3);
        animation: spin-slow 20s linear infinite;
    }
    
    @media (min-width: 768px) {
        .map-node.type-main { width: 150px; height: 150px; font-size: 1.25rem; }
    }

    /* --- Topic Nodes --- */
    .map-node.type-topic {
        background: rgba(15, 25, 45, 0.7);
        border: 1px solid rgba(0, 240, 255, 0.3);
        border-radius: 50px;
        padding: 8px 16px;
        color: #fff;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        min-width: 100px;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
    }
    /* Special style for Video Node (formerly Docs) */
    .map-node.type-topic.video-trigger {
        border-color: #f00; /* Youtube Red hint */
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
    }
    .map-node.type-topic.video-trigger .material-symbols-outlined {
        color: #ff4444;
    }

    .map-node.type-topic:active, .map-node.type-topic.active-cluster {
        background: rgba(0, 240, 255, 0.15);
        border-color: #00f0ff;
        box-shadow: 0 0 25px rgba(0, 240, 255, 0.3);
        transform: scale(1.05);
    }
    
    @media (min-width: 768px) {
        .map-node.type-topic { padding: 12px 24px; font-size: 0.9rem; min-width: 140px; }
    }

    /* --- Leaf Nodes --- */
    .map-node.type-image {
        background: rgba(5, 10, 20, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.7rem;
        color: rgba(200, 230, 255, 0.8);
        display: flex;
        align-items: center;
        gap: 6px;
        max-width: 140px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-left: 2px solid #4ade80;
    }
    .map-node.type-image .material-symbols-outlined { color: #4ade80; font-size: 16px; }

    .map-node.active-node {
        background: rgba(20, 40, 80, 0.95);
        border-color: #fff;
        color: #fff;
        z-index: 50;
        transform: scale(1.1);
    }

    /* --- Content Panel (Mobile: Bottom Sheet / Desktop: Floating) --- */
    .node-content-panel {
        background: rgba(12, 18, 32, 0.98);
        border: 1px solid rgba(0, 240, 255, 0.2);
        backdrop-filter: blur(20px);
        color: #e0f0ff;
        z-index: 100;
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
        will-change: transform, opacity;
        
        /* Mobile Default: Bottom Sheet */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 85vh; /* Tăng chiều cao để chứa video thoải mái */
        border-radius: 20px 20px 0 0;
        border-bottom: none;
        transform: translateY(105%); /* Hide */
        padding: 20px;
        box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
    }
    
    @media (min-width: 768px) {
        /* Desktop: Floating Panel */
        .node-content-panel {
            position: fixed;
            bottom: auto;
            right: auto;
            width: 450px; /* Rộng hơn cho video */
            border-radius: 16px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
    }

    .node-content-panel.panel-visible {
        transform: translateY(0); /* Mobile & Desktop reset */
        opacity: 1;
        pointer-events: auto;
    }

    /* Video Container Aspect Ratio */
    .aspect-video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .aspect-video-container iframe, 
    .aspect-video-container video,
    .aspect-video-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* --- Widget (Mobile Optimized) --- */
    .mindmap-widget {
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @media (max-width: 767px) {
        .mindmap-widget {
            position: fixed;
            inset: 10px;
            width: auto;
            height: auto;
            max-width: none;
            z-index: 200;
            transform: scale(0.95) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        .mindmap-widget.open {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
    }
    @media (min-width: 768px) {
        .mindmap-widget.collapsed {
            transform: translateX(120%) !important;
            opacity: 0.5;
        }
    }

</style>
</head>
<body class="min-h-screen flex flex-col bg-black">

<!-- Mobile Header -->
<div class="fixed top-4 left-4 z-30 pointer-events-none md:hidden">
    <div class="flex items-center space-x-2 bg-black/40 backdrop-blur rounded-full p-1 pr-3 border border-white/10 pointer-events-auto">
        <div class="w-8 h-8 rounded-full bg-holo-cyan/20 flex items-center justify-center text-holo-cyan">
            <span class="material-symbols-outlined text-lg">science</span>
        </div>
        <span class="text-xs font-bold text-white tracking-widest">VEO3</span>
    </div>
</div>

<!-- Main Canvas -->
<main class="flex-grow w-full relative h-screen overflow-hidden">
    <div class="absolute inset-0 conceptual-map-container" id="learning-galaxy">
        
        <!-- Center Core -->
        <div class="map-node type-main animate-pulse-glow" id="main-node">
            VEO3
        </div>

        <!-- Topic: Video (Formerly Docs) -->
        <div class="map-node type-topic video-trigger" data-node-id="core-docs">
            <span class="material-symbols-outlined text-base mr-1 md:mr-2">play_circle</span>
            VIDEO HDSD
        </div>
        <!-- Note: Children of core-docs removed from HTML as they are no longer needed for expansion -->

        <!-- Topic: Visual Assets -->
        <div class="map-node type-topic" data-node-id="visual-assets">
            <span class="material-symbols-outlined text-base mr-1 md:mr-2">perm_media</span>
            Assets
        </div>
        <!-- Children -->
        <div class="map-node type-image node-hidden" data-parent-node="visual-assets">
            <span class="material-symbols-outlined">image</span>
            <span>Khối 1.png</span>
            <img alt="Preview" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBhlBm49epTesS6md2pp5Nbl6tDLRPsql8TneeFXTeWPfys-J14NL5KuB6Q6JxUxMZizLIJ2UAhDz2ph-lqdML7AnwVSek_LnMRuYxEa3bZInwF9SmIZEzJ4TGxkc2xTGzeygY57e_HMPBVcmSNwqFCdNRrUkPB-k7uT7BNJAE_V7cyJbbb9hBT8jPuYkrkN9GGXIBm0xAWH5g_bMvRCNKLqMO1I4Yv9kTcK3uIqne8VrP5WzjLHIa--rF68TBBVFebA7gd9r1ghbo"/>
        </div>
        <div class="map-node type-image node-hidden" data-parent-node="visual-assets">
            <span class="material-symbols-outlined">image</span>
            <span>Khối 2.png</span>
             <img alt="Preview" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDdUDc4X8wdNJjCViSlzNlE9p2lvZ7Q7oeVmhZBxbzr4fyXPGFIwmZBXt4XcFH5BWw0xFrjXZLjFGKbf0gj86kQxEmHE0kS7g0ZxsimR-yEO-n_7QqL9AL7xznX1i-vFY7dQlwbfqWQ6HYSOfi_M_Ii9mt-Ky_rMd2CoRkUNEMnOBD4K3tzgbrptZ11Fi3AhZz3Nb_hwZBzKvCZtNIJ5oT6QUF1LgrsKJWGYEkRQwwoCfa-Ujgjc_im4k1_Obtdt80PiRxkrfpv3vI"/>
        </div>
        <div class="map-node type-image node-hidden" data-parent-node="visual-assets">
            <span class="material-symbols-outlined">image</span>
            <span>Khối 3.png</span>
             <img alt="Preview" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCAATlxbLg-xJdHfCtxmaB5DgBuEPzAVDHxAVMxf-90qXM6FVvGaY6KmQ4U5jHxjFhdBXBEvAgPh6ZOj3ctJLt9gfQNVcGZxYgpbwuwpx62_ux3Q0iUmty4AscQ-SkcYt5pIPgcPFvXR91wHGviVZJFT2RoOU6cXsz3hrXR-A_VNHy2oW2L8BV5Duo9S8fjy_MefmYNWN9yHKVe8LAa1EzAyRfPQ2RU14L1UwRVJTrQgfbSmrbleRzFu1YAFOTjvcfAeV1b-BKTbLM"/>
        </div>
        <div class="map-node type-image node-hidden" data-parent-node="visual-assets">
             <span class="material-symbols-outlined">image</span>
            <span>Khối 4.png</span>
            <img alt="Preview" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBbJbtCo22ygPAEScirVNpaB1riZ2cT_VWAeMiHy8AOkoNvJ1gA1e5sRMI-frZXyqEFBXaXHpsYYCsxBjtISHe27CReSLTnKdXG9fx4MOoijhnNZbU0wBBjNN3Nyn-6zsyuCXqYBpnfS2hSqikxiUT4J-Fa3xJVJEqSE_GqRmc_6j8To6I5KYzc6CBrBJ2AtKWk3BN5hF_YAIFjv7rH7jiCE5zQmTUqhUeKNRfpMr5tEsIUVngnVMG5YkFPGBw61J4h2__fi179eQ4"/>
        </div>
    </div>

    <!-- DETAILS PANEL (Optimized for Video) -->
    <div class="node-content-panel" id="content-detail-panel">
        <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-4 md:hidden"></div>
        
        <button class="absolute top-4 right-4 text-white/50 hover:text-white p-2 z-10" onclick="closePanel()">
            <span class="material-symbols-outlined">close</span>
        </button>
        
        <h3 class="font-semibold text-lg mb-2 flex items-center text-white pr-8">
            <span class="material-symbols-outlined text-xl mr-2 text-holo-cyan" id="panel-icon"></span>
            <span id="panel-title">Tiêu đề</span>
        </h3>
        
        <div class="h-px w-full bg-gradient-to-r from-holo-cyan/50 to-transparent mb-4"></div>
        
        <div class="overflow-y-auto max-h-[70vh] pr-1 scrollbar-hide">
            <!-- Media Container (16:9) -->
            <div class="aspect-video-container mb-4 hidden" id="media-container">
                <!-- Youtube Iframe placeholder -->
                <div id="youtube-embed"></div>
                <!-- Standard Image/Video fallback -->
                <img alt="Content preview" class="hidden" id="panel-image" src=""/>
                <video class="hidden" controls="" id="panel-video" src=""></video>
            </div>

            <p class="text-sm text-gray-300 leading-relaxed mb-4" id="panel-description">Mô tả nội dung...</p>
        </div>
        
        <a class="flex items-center justify-center w-full py-3 bg-holo-cyan text-black font-bold rounded-lg mt-2 active:scale-95 transition-transform" href="#" id="panel-link" target="_blank">
            <span>TRUY CẬP DỮ LIỆU</span>
            <span class="material-symbols-outlined text-lg ml-2">arrow_forward</span>
        </a>
    </div>

    <!-- MINDMAP WIDGET -->
    <div id="mindmap-widget" class="mindmap-widget bg-holo-surface/95 backdrop-blur-2xl border border-holo-border rounded-2xl shadow-2xl flex flex-col md:fixed md:top-6 md:right-6 md:bottom-6 md:w-[450px] md:z-40">
        <div class="p-4 border-b border-holo-border flex justify-between items-center">
            <h2 class="text-holo-cyan font-bold text-sm uppercase flex items-center">
                <span class="material-symbols-outlined mr-2">hub</span> Tổng quan
            </h2>
            <button onclick="toggleMindmap()" class="text-white/60 p-1 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <div class="p-2 flex-grow overflow-auto flex flex-col items-center justify-center bg-black/50 relative">
             <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none"></div>
             <img src="./images/so-do-mindmap-tong.png" 
                  class="max-w-full h-auto rounded shadow-lg object-contain max-h-[70vh] md:max-h-none border border-white/10" alt="Structure Map"
                  onerror="this.src='https://lh3.googleusercontent.com/aida-public/AB6AXuCHMKeqJ2Qgyyerm4i6J8JwRM5ciJpdMB6i8AzGIj2YXvUSsGXH6Ykfp_d8y65iULeCl48Nr__cBRyM1F6-WDCuk1jaOEE4lsvOixYiB78CCT4kL3dqNlhAYrOFUSZkb-PApu9sx2M3ZFUlt9f9PnuLPzuZenXwpRfqH_nTcDz7BTn6OShL8urhRehXItILQI6IE_6y0hdgr4fK6FT3A4Z4EvsX7gl2BAOMZ3XjT3-4JTlzAot1h6GDdABOEjlmD0tTw9pFP9iWha0'"/>
             
             <div class="mt-4 p-3 bg-white/5 rounded w-full border border-white/10">
                 <p class="text-xs text-gray-400 text-center">Sơ đồ hệ thống VEO3 - Phiên bản rút gọn</p>
             </div>
        </div>
    </div>

    <!-- FLOATING ACTION BUTTON -->
    <button id="mindmap-toggle-btn" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-holo-cyan text-black shadow-[0_0_20px_rgba(0,240,255,0.5)] flex items-center justify-center z-40 active:scale-90 transition-transform md:top-6 md:bottom-auto md:right-0 md:rounded-r-none md:rounded-l-xl md:w-auto md:px-4 md:py-3 md:h-auto hover:bg-white border-2 border-transparent hover:border-holo-cyan group" onclick="toggleMindmap()">
         <span class="material-symbols-outlined text-2xl md:text-xl group-hover:rotate-90 transition-transform duration-300">hub</span>
         <span class="hidden md:inline ml-2 font-bold text-sm tracking-wider">MAP TỔNG</span>
    </button>

</main>

<script>
    // --- Data Configuration ---
    const nodeData = {
        'core-docs': {
            // NEW: Video configuration
            title: 'HƯỚNG DẪN VẬN HÀNH VEO3',
            description: 'Xem video chi tiết quy trình lắp đặt và vận hành hệ thống VEO3.',
            icon: 'play_circle',
            link: 'https://youtu.be/b2TZ0QTYN-I',
            videoType: 'youtube', 
            // Dùng ID video Youtube hoặc URL Embed. Thêm autoplay=1 để tự chạy khi mở panel.
            videoSrc: 'https://www.youtube.com/embed/b2TZ0QTYN-I?autoplay=1', 
            children: [] // No expansion needed
        },
        'visual-assets': {
            title: 'Tài Nguyên Hình Ảnh',
            description: 'Sơ đồ khối và bản vẽ kỹ thuật chi tiết.',
            icon: 'perm_media',
            link: '#',
            children: [
                { type: 'image', title: 'Khối 1.png', description: 'Phân tích cấu trúc khối 1.', icon: 'image', link: '#', details: 'IMG // 4.6 MB', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBhlBm49epTesS6md2pp5Nbl6tDLRPsql8TneeFXTeWPfys-J14NL5KuB6Q6JxUxMZizLIJ2UAhDz2ph-lqdML7AnwVSek_LnMRuYxEa3bZInwF9SmIZEzJ4TGxkc2xTGzeygY57e_HMPBVcmSNwqFCdNRrUkPB-k7uT7BNJAE_V7cyJbbb9hBT8jPuYkrkN9GGXIBm0xAWH5g_bMvRCNKLqMO1I4Yv9kTcK3uIqne8VrP5WzjLHIa--rF68TBBVFebA7gd9r1ghbo' },
                { type: 'image', title: 'Khối 2.png', description: 'Chi tiết khối 2.', icon: 'image', link: '#', details: 'IMG // 5.1 MB', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDdUDc4X8wdNJjCViSlzNlE9p2lvZ7Q7oeVmhZBxbzr4fyXPGFIwmZBXt4XcFH5BWw0xFrjXZLjFGKbf0gj86kQxEmHE0kS7g0ZxsimR-yEO-n_7QqL9AL7xznX1i-vFY7dQlwbfqWQ6HYSOfi_M_Ii9mt-Ky_rMd2CoRkUNEMnOBD4K3tzgbrptZ11Fi3AhZz3Nb_hwZBzKvCZtNIJ5oT6QUF1LgrsKJWGYEkRQwwoCfa-Ujgjc_im4k1_Obtdt80PiRxkrfpv3vI' },
                { type: 'image', title: 'Khối 3.png', description: 'Layout khối 3.', icon: 'image', link: '#', details: 'IMG // 5.1 MB', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuCAATlxbLg-xJdHfCtxmaB5DgBuEPzAVDHxAVMxf-90qXM6FVvGaY6KmQ4U5jHxjFhdBXBEvAgPh6ZOj3ctJLt9gfQNVcGZxYgpbwuwpx62_ux3Q0iUmty4AscQ-SkcYt5pIPgcPFvXR91wHGviVZJFT2RoOU6cXsz3hrXR-A_VNHy2oW2L8BV5Duo9S8fjy_MefmYNWN9yHKVe8LAa1EzAyRfPQ2RU14L1UwRVJTrQgfbSmrbleRzFu1YAFOTjvcfAeV1b-BKTbLM' },
                { type: 'image', title: 'Khối 4.png', description: 'Lắp ráp khối 4.', icon: 'image', link: '#', details: 'IMG // 5.5 MB', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBbJbtCo22ygPAEScirVNpaB1riZ2cT_VWAeMiHy8AOkoNvJ1gA1e5sRMI-frZXyqEFBXaXHpsYYCsxBjtISHe27CReSLTnKdXG9fx4MOoijhnNZbU0wBBjNN3Nyn-6zsyuCXqYBpnfS2hSqikxiUT4J-Fa3xJVJEqSE_GqRmc_6j8To6I5KYzc6CBrBJ2AtKWk3BN5hF_YAIFjv7rH7jiCE5zQmTUqhUeKNRfpMr5tEsIUVngnVMG5YkFPGBw61J4h2__fi179eQ4' },
            ]
        }
    };

    // --- State ---
    const state = {
        activeCluster: null,
        activeLeaf: null,
        mindmapOpen: false 
    };

    // --- DOM ---
    const galaxy = document.getElementById('learning-galaxy');
    const mainNode = document.getElementById('main-node');
    const contentPanel = document.getElementById('content-detail-panel');
    const mindmapWidget = document.getElementById('mindmap-widget');
    const mediaContainer = document.getElementById('media-container');
    const youtubeEmbed = document.getElementById('youtube-embed');
    
    // Panel Elements
    const pTitle = document.getElementById('panel-title');
    const pDesc = document.getElementById('panel-description');
    const pIcon = document.getElementById('panel-icon');
    const pImg = document.getElementById('panel-image');
    const pVid = document.getElementById('panel-video');
    const pLink = document.getElementById('panel-link');

    // --- Logic ---
    function init() {
        positionNodes();
        if (window.innerWidth > 768) {
             state.mindmapOpen = true;
             updateWidgetState();
        }
        window.addEventListener('resize', () => positionNodes());
    }

    function positionNodes() {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const isMobile = window.innerWidth < 768;
        const offsetX = (!isMobile && state.mindmapOpen) ? -100 : 0;

        mainNode.style.left = `${cx + offsetX}px`;
        mainNode.style.top = `${cy}px`;
        mainNode.style.transform = 'translate(-50%, -50%)';

        const topics = document.querySelectorAll('.map-node.type-topic');
        const radius = isMobile ? 110 : 250; 
        
        topics.forEach((topic, index) => {
            let angle;
            if (isMobile) {
                // Top and Bottom
                angle = index === 0 ? -Math.PI/2 : Math.PI/2; 
            } else {
                angle = (index / topics.length) * 2 * Math.PI + Math.PI; 
            }

            const x = (cx + offsetX) + radius * Math.cos(angle);
            const y = cy + radius * Math.sin(angle);

            topic.style.left = `${x}px`;
            topic.style.top = `${y}px`;
            topic.style.transform = 'translate(-50%, -50%)';
            
            if(state.activeCluster) {
                 setTimeout(() => {
                     const parent = document.querySelector(`[data-node-id="${state.activeCluster}"]`);
                     if(parent) expandCluster(state.activeCluster, parent);
                 }, 300);
            }
        });
    }

    // --- Interactions ---
    document.querySelectorAll('.map-node').forEach(node => {
        node.addEventListener('click', (e) => {
            e.stopPropagation();
            const nodeId = node.dataset.nodeId;
            const parentId = node.dataset.parentNode;

            if (nodeId) { // Topic Clicked
                const data = nodeData[nodeId];
                
                // NEW: Logic check for Direct Video Play
                if (data && data.videoType === 'youtube') {
                    // Close other clusters if open
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    
                    // Show Panel Directly with Video
                    showPanel(data, node);
                    return;
                }

                // Normal Cluster Logic
                if (state.activeCluster === nodeId) {
                    collapseCluster(nodeId);
                } else {
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    expandCluster(nodeId, node);
                }
            } else if (parentId) { // Leaf Clicked
                handleLeafClick(node, parentId);
            } else if (node === mainNode) {
                showPanel({
                    title: 'Hệ Thống VEO3',
                    description: 'Trạng thái hoạt động bình thường.',
                    icon: 'science',
                    link: '#'
                });
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (!contentPanel.contains(e.target) && !e.target.closest('.map-node') && !mindmapWidget.contains(e.target) && !document.getElementById('mindmap-toggle-btn').contains(e.target)) {
            closePanel();
        }
    });

    // --- Cluster Logic ---
    function expandCluster(clusterId, parentNode) {
        state.activeCluster = clusterId;
        parentNode.classList.add('active-cluster');
        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());

        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);
        const isMobile = window.innerWidth < 768;
        const radius = isMobile ? 120 : 180;
        
        children.forEach((child, index) => {
            child.classList.remove('hidden', 'node-hidden');
            let angle;
            if (isMobile) {
                const isTop = cy < window.innerHeight / 2;
                const baseAngle = isTop ? Math.PI/2 : -Math.PI/2;
                const spread = Math.PI * 0.8;
                const start = baseAngle - spread/2;
                const step = spread / (children.length - 1 || 1);
                angle = children.length === 1 ? baseAngle : start + (index * step);
            } else {
                angle = (index / children.length) * 2 * Math.PI;
            }

            const tx = cx + radius * Math.cos(angle);
            const ty = cy + radius * Math.sin(angle);

            child.style.left = `${tx}px`;
            child.style.top = `${ty}px`;
            child.style.transform = 'translate(-50%, -50%) scale(1)';

            setTimeout(() => createLine(parentNode, child, `line-${clusterId}`), 300);
        });
    }

    function collapseCluster(clusterId) {
        const parentNode = document.querySelector(`[data-node-id="${clusterId}"]`);
        if(parentNode) parentNode.classList.remove('active-cluster');
        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);

        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());
        children.forEach(child => {
            child.style.left = `${cx}px`;
            child.style.top = `${cy}px`;
            child.classList.add('node-hidden');
            setTimeout(() => child.classList.add('hidden'), 400);
        });
        state.activeCluster = null;
        closePanel();
    }

    // --- Content Logic ---
    function handleLeafClick(node, parentId) {
        if (state.activeLeaf) state.activeLeaf.classList.remove('active-node');
        state.activeLeaf = node;
        node.classList.add('active-node');
        const text = node.textContent.trim();
        const data = nodeData[parentId].children.find(c => text.includes(c.title));
        if(data) showPanel(data, node);
    }

    function showPanel(data, sourceNode) {
        // Stop current video if playing
        youtubeEmbed.innerHTML = '';
        pVid.pause();

        pTitle.textContent = data.title;
        pDesc.textContent = data.description;
        pIcon.textContent = data.icon;
        pLink.href = data.link;

        // Media Handling
        mediaContainer.classList.add('hidden');
        pImg.classList.add('hidden');
        pVid.classList.add('hidden');
        youtubeEmbed.classList.add('hidden');

        if (data.videoType === 'youtube') {
            mediaContainer.classList.remove('hidden');
            youtubeEmbed.classList.remove('hidden');
            // Insert Iframe dynamically with full attributes
            youtubeEmbed.innerHTML = `<iframe id="ytplayer" type="text/html" width="100%" height="100%" src="${data.videoSrc}" frameborder="0" allowfullscreen></iframe>`;
        } else if (data.image) {
            mediaContainer.classList.remove('hidden');
            pImg.src = data.image;
            pImg.classList.remove('hidden');
        } else if (data.video) {
            mediaContainer.classList.remove('hidden');
            pVid.src = data.video;
            pVid.classList.remove('hidden');
        }

        // Panel Positioning
        const isMobile = window.innerWidth < 768;
        contentPanel.classList.add('panel-visible');

        if (!isMobile && sourceNode) {
            const rect = sourceNode.getBoundingClientRect();
            let left = rect.right + 20;
            let top = rect.top - 50;
            
            // Smart positioning
            if (left + 450 > window.innerWidth) left = rect.left - 470;
            if (top < 20) top = 20;
            if (top + 450 > window.innerHeight) top = window.innerHeight - 470;
            
            contentPanel.style.left = `${left}px`;
            contentPanel.style.top = `${top}px`;
            contentPanel.style.width = '450px';
        } else {
            contentPanel.style.left = '';
            contentPanel.style.top = '';
            contentPanel.style.width = '';
        }
    }

    function closePanel() {
        contentPanel.classList.remove('panel-visible');
        // Stop video to save resources
        setTimeout(() => {
            youtubeEmbed.innerHTML = '';
            pVid.pause();
        }, 300);

        if (state.activeLeaf) {
            state.activeLeaf.classList.remove('active-node');
            state.activeLeaf = null;
        }
    }

    // --- Widget Logic ---
    function toggleMindmap() {
        state.mindmapOpen = !state.mindmapOpen;
        updateWidgetState();
        if (window.innerWidth > 768) positionNodes();
    }

    function updateWidgetState() {
        if (state.mindmapOpen) {
            mindmapWidget.classList.remove('collapsed'); 
            mindmapWidget.classList.add('open'); 
        } else {
            mindmapWidget.classList.add('collapsed'); 
            mindmapWidget.classList.remove('open'); 
        }
    }

    // --- Utils ---
    function createLine(el1, el2, cls) {
        const x1 = parseFloat(el1.style.left);
        const y1 = parseFloat(el1.style.top);
        const x2 = parseFloat(el2.style.left);
        const y2 = parseFloat(el2.style.top);
        const dist = Math.hypot(x2 - x1, y2 - y1);
        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

        const line = document.createElement('div');
        line.className = `connecting-line ${cls}`;
        line.style.width = `0px`;
        line.style.left = `${x1}px`;
        line.style.top = `${y1}px`;
        line.style.transform = `rotate(${angle}deg)`;
        galaxy.appendChild(line);
        requestAnimationFrame(() => {
            line.style.width = `${dist}px`;
            line.style.opacity = 1;
        });
    }

    init();
</script>
</body>
</html>
