<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Learning Content Galaxy - VEO3</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class", // Kích hoạt dark mode bằng class 'dark'
        theme: {
            extend: {
                colors: {
                    // Màu cho Dark Mode (Holo)
                    holo: {
                        bg: "#050810",
                        surface: "rgba(10, 20, 35, 0.9)", 
                        border: "rgba(100, 220, 255, 0.3)",
                        text: "#d0e0ff",
                        cyan: "#00f0ff",
                        purple: "#bc13fe",
                        green: "#0aff0a",
                        blue: "#3b82f6"
                    },
                    // Màu cho Light Mode
                    light: {
                        bg: "#f0f4f9",
                        surface: "rgba(255, 255, 255, 0.9)",
                        border: "rgba(0, 100, 200, 0.2)",
                        text: "#1e293b",
                        accent: "#0284c7" // Sky blue đậm
                    }
                },
                fontFamily: {
                    sans: ["Inter", "sans-serif"],
                    display: "Be Vietnam Pro"
                },
                animation: {
                    'pulse-glow': 'pulseGlow 4s infinite alternate',
                    'spin-slow': 'spin 20s linear infinite',
                    'float': 'float 6s ease-in-out infinite',
                    'machine-hover': 'machineHover 3s ease-in-out infinite',
                },
                keyframes: {
                    pulseGlow: {
                        '0%': { opacity: 0.8, filter: 'brightness(1) drop-shadow(0 0 5px rgba(0,240,255,0.2))' },
                        '100%': { opacity: 1, filter: 'brightness(1.1) drop-shadow(0 0 15px rgba(0,240,255,0.5))' },
                    },
                    float: {
                        '0%, 100%': { transform: 'translateY(0)' },
                        '50%': { transform: 'translateY(-10px)' },
                    },
                    machineHover: {
                        '0%, 100%': { transform: 'translate(-50%, -50%) scale(1)' },
                        '50%': { transform: 'translate(-50%, -52%) scale(1.02)' },
                    }
                }
            }
        }
    };
</script>
<style type="text/tailwindcss">
    /* --- CSS Variables cho việc chuyển đổi Theme mượt mà --- */
    :root {
        --bg-primary: #f8fafc;
        --bg-grid: rgba(0, 0, 0, 0.05);
        --bg-gradient-start: rgba(220, 230, 255, 0.6);
        --bg-gradient-end: #ffffff;
        
        --line-color: rgba(96, 165, 250, 0.4); /* Blue-400 mờ */
        
        --node-bg: rgba(255, 255, 255, 0.85);
        --node-border: rgba(200, 200, 200, 0.6);
        --node-text: #1e293b;
        --node-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        
        --main-node-glow: rgba(56, 189, 248, 0.5); /* Sáng hơn chút cho light mode */
    }

    /* Dark Mode Variables */
    .dark {
        --bg-primary: #050810;
        --bg-grid: rgba(0, 240, 255, 0.05);
        --bg-gradient-start: rgba(20, 30, 60, 0.4);
        --bg-gradient-end: #050810;
        
        --line-color: rgba(0, 240, 255, 0.3);
        
        --node-bg: rgba(15, 25, 45, 0.7);
        --node-border: rgba(0, 240, 255, 0.3);
        --node-text: #d0e0ff;
        --node-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        
        --main-node-glow: rgba(0, 220, 255, 0.6);
    }

    body {
        background-color: var(--bg-primary);
        color: var(--node-text);
        overflow: hidden;
        font-family: 'Inter', sans-serif;
        touch-action: none;
        -webkit-tap-highlight-color: transparent;
        transition: background-color 0.5s ease, color 0.5s ease;
    }

    /* --- Background --- */
    .conceptual-map-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: 
            radial-gradient(circle at 50% 50%, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 80%),
            linear-gradient(var(--bg-grid) 1px, transparent 1px),
            linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        perspective: 1000px;
        will-change: transform;
        transition: background 0.5s ease;
    }

    /* --- Connecting Lines --- */
    .connecting-line {
        position: absolute;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--line-color), transparent);
        transform-origin: 0 50%;
        pointer-events: none;
        z-index: 5;
        opacity: 0;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, background 0.5s ease;
    }

    /* --- Nodes Common --- */
    .map-node {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        backdrop-filter: blur(8px);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease, background 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        will-change: transform, left, top;
        -webkit-user-select: none;
        user-select: none;
    }

    .node-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0) translateZ(0) !important;
    }

    /* --- Main Node (VEO3 Machine Image) - MODERNISED --- */
    .map-node.type-main {
        width: 240px; /* Tăng kích thước để làm điểm nhấn */
        height: 240px;
        background: transparent; /* Bỏ nền cứng */
        border: none; /* Bỏ viền cứng */
        box-shadow: none; /* Bỏ bóng hộp cứng */
        color: var(--node-text);
        z-index: 20;
        padding: 0;
        overflow: visible; /* Để hiệu ứng glow lan ra ngoài */
        /* Animation nhẹ nhàng kiểu trôi nổi */
        animation: machine-hover 4s ease-in-out infinite alternate;
    }

    /* Hiệu ứng Glow nền phía sau (Ambient Light) */
    .map-node.type-main::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 60%;
        height: 60%;
        transform: translate(-50%, -50%);
        background: var(--main-node-glow);
        border-radius: 50%;
        filter: blur(40px); /* Làm mờ mạnh để tạo quầng sáng */
        opacity: 0.6;
        z-index: -1;
        transition: opacity 0.3s ease;
    }
    
    /* Hiệu ứng khi hover vào máy */
    .map-node.type-main:hover::before {
        opacity: 0.8;
        filter: blur(50px);
        background: var(--holo-cyan); /* Sáng hơn khi hover */
    }

    /* Bỏ vòng xoay cũ (::after) để trông hiện đại, tối giản hơn */
    .map-node.type-main::after {
        display: none;
    }
    
    @media (min-width: 768px) {
        .map-node.type-main { width: 300px; height: 300px; }
    }

    /* --- Topic Nodes --- */
    .map-node.type-topic {
        background: var(--node-bg);
        border: 1px solid var(--node-border);
        border-radius: 50px;
        padding: 8px 16px;
        color: var(--node-text);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        min-width: 100px;
        box-shadow: var(--node-shadow);
    }
    
    .map-node.type-topic.video-trigger {
        border-color: rgba(255, 68, 68, 0.5); 
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.15);
    }
    .map-node.type-topic.video-trigger .material-symbols-outlined {
        color: #ef4444;
    }

    .map-node.type-topic:active, .map-node.type-topic.active-cluster {
        background: rgba(14, 165, 233, 0.15); /* Sky blue tint */
        border-color: #0ea5e9;
        transform: scale(1.05);
    }
    .dark .map-node.type-topic:active, .dark .map-node.type-topic.active-cluster {
        background: rgba(0, 240, 255, 0.15);
        border-color: #00f0ff;
    }
    
    @media (min-width: 768px) {
        .map-node.type-topic { padding: 12px 24px; font-size: 0.9rem; min-width: 140px; }
    }

    /* --- Leaf Nodes --- */
    .map-node.type-image {
        background: var(--node-bg);
        border: 1px solid var(--node-border);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.7rem;
        color: var(--node-text);
        display: flex;
        align-items: center;
        gap: 6px;
        max-width: 160px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-left: 3px solid #10b981; /* Green-500 */
        box-shadow: var(--node-shadow);
    }
    .map-node.type-image .material-symbols-outlined { color: #10b981; font-size: 16px; }

    .map-node.active-node {
        background: #0ea5e9;
        border-color: #fff;
        color: #fff;
        z-index: 50;
        transform: scale(1.1);
    }
    .dark .map-node.active-node {
        background: rgba(20, 40, 80, 0.95);
    }

    /* --- Content Panel (CENTER MODAL STYLE) --- */
    .node-content-panel {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(20px);
        color: #1e293b;
        z-index: 100;
        
        position: fixed;
        top: 50%;
        left: 50%;
        width: 90%;
        max-width: 500px;
        max-height: 85vh;
        
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
        pointer-events: none;
        
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
        
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease;
    }

    .dark .node-content-panel {
        background: rgba(12, 18, 32, 0.95);
        border: 1px solid rgba(0, 240, 255, 0.3);
        color: #e0f0ff;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.1);
    }

    .node-content-panel.panel-visible {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        pointer-events: auto;
    }

    /* Video Container */
    .aspect-video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .aspect-video-container iframe, 
    .aspect-video-container video,
    .aspect-video-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Theme Toggle Button */
    .theme-toggle-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 100;
        background: var(--node-bg);
        border: 1px solid var(--node-border);
        color: var(--node-text);
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .theme-toggle-btn:hover {
        transform: rotate(15deg) scale(1.1);
        background: rgba(0,0,0,0.05);
    }
    .dark .theme-toggle-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    /* Panel Item Light Mode Styles */
    .panel-item-light {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .panel-item-light:hover {
        background: rgba(0, 0, 0, 0.06);
    }
    .dark .panel-item-light {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .dark .panel-item-light:hover {
        background: rgba(255, 255, 255, 0.1);
    }
</style>
</head>
<!-- Mặc định class body trống để dùng Light Mode. Script sẽ kiểm tra LocalStorage. -->
<body class="min-h-screen flex flex-col transition-colors duration-500">

<!-- Theme Toggle -->
<button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle Dark Mode">
    <span class="material-symbols-outlined" id="theme-icon">dark_mode</span>
</button>

<!-- Mobile Header -->
<div class="fixed top-4 left-4 z-30 pointer-events-none md:hidden">
    <div class="flex items-center space-x-2 bg-white/40 dark:bg-black/40 backdrop-blur rounded-full p-1 pr-3 border border-black/10 dark:border-white/10 pointer-events-auto shadow-sm">
        <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-holo-cyan/20 flex items-center justify-center text-blue-600 dark:text-holo-cyan">
            <span class="material-symbols-outlined text-lg">science</span>
        </div>
        <span class="text-xs font-bold text-slate-700 dark:text-white tracking-widest">VEO3</span>
    </div>
</div>

<!-- Overlay for Modal -->
<div id="panel-overlay" class="fixed inset-0 bg-black/30 dark:bg-black/70 backdrop-blur-[2px] z-50 hidden opacity-0 transition-opacity duration-300" onclick="closePanel()"></div>

<!-- Main Canvas -->
<main class="flex-grow w-full relative h-screen overflow-hidden">
    <div class="absolute inset-0 conceptual-map-container" id="learning-galaxy">
        
        <!-- Center Core: Updated to Image (Modern Style) -->
        <div class="map-node type-main" id="main-node">
            <!-- Hình ảnh máy VEO3 tách nền -->
            <img src="./media_veo3/veo3_hinhmay.png" alt="VEO3 Machine" class="w-full h-full object-contain filter drop-shadow-xl dark:drop-shadow-[0_0_20px_rgba(0,240,255,0.4)] transition-all duration-300 hover:scale-105">
        </div>

        <!-- Topic: Video (Formerly Docs) -->
        <div class="map-node type-topic video-trigger" data-node-id="core-docs">
            <span class="material-symbols-outlined text-base mr-1 md:mr-2">play_circle</span>
            VIDEO HDSD
        </div>

        <!-- Topic: Visual Assets -->
        <div class="map-node type-topic" data-node-id="visual-assets">
            <span class="material-symbols-outlined text-base mr-1 md:mr-2">perm_media</span>
            Assets
        </div>

        <!-- Topic: Structure Map -->
        <div class="map-node type-topic" data-node-id="structure-map">
            <span class="material-symbols-outlined text-base mr-1 md:mr-2">hub</span>
            SƠ ĐỒ TỔNG
        </div>
        
    </div>

    <!-- DETAILS PANEL (Center Modal) -->
    <div class="node-content-panel shadow-2xl" id="content-detail-panel">
        
        <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 dark:text-white/50 dark:hover:text-white p-2 z-10 transition-colors" onclick="closePanel()">
            <span class="material-symbols-outlined">close</span>
        </button>
        
        <h3 class="font-semibold text-lg mb-2 flex items-center pr-8 text-slate-800 dark:text-white">
            <span class="material-symbols-outlined text-xl mr-2 text-blue-500 dark:text-holo-cyan" id="panel-icon"></span>
            <span id="panel-title">Tiêu đề</span>
        </h3>
        
        <div class="h-px w-full bg-gradient-to-r from-blue-200 to-transparent dark:from-holo-cyan/50 mb-4"></div>
        
        <div class="overflow-y-auto max-h-[60vh] pr-1 scrollbar-hide">
            <!-- Media Container (16:9) -->
            <div class="aspect-video-container mb-4 hidden" id="media-container">
                <!-- Youtube Iframe placeholder -->
                <div id="youtube-embed"></div>
                <!-- Standard Image/Video fallback -->
                <img alt="Content preview" class="hidden" id="panel-image" src=""/>
                <video class="hidden" controls="" id="panel-video" src=""></video>
            </div>

            <!-- List Container -->
            <div class="hidden flex flex-col gap-2 mb-4" id="list-container"></div>

            <p class="text-sm text-slate-600 dark:text-gray-300 leading-relaxed mb-4" id="panel-description">Mô tả nội dung...</p>
        </div>
        
        <a class="flex items-center justify-center w-full py-3 bg-blue-600 hover:bg-blue-700 dark:bg-holo-cyan dark:hover:bg-cyan-400 text-white dark:text-black font-bold rounded-lg mt-2 active:scale-95 transition-all shadow-lg hover:shadow-xl" href="#" id="panel-link" target="_blank">
            <span>TRUY CẬP DỮ LIỆU</span>
            <span class="material-symbols-outlined text-lg ml-2">arrow_forward</span>
        </a>
    </div>

</main>

<script>
    // --- Data Configuration ---
    const nodeData = {
        'core-docs': {
            title: 'HƯỚNG DẪN VẬN HÀNH VEO3',
            description: 'Xem video chi tiết quy trình lắp đặt và vận hành hệ thống VEO3.',
            icon: 'play_circle',
            link: 'https://youtu.be/b2TZ0QTYN-I',
            videoType: 'youtube', 
            videoSrc: 'https://www.youtube.com/embed/b2TZ0QTYN-I?autoplay=1', 
            children: [] 
        },
        'visual-assets': {
            title: 'HƯỚNG DẪN VẬN HÀNH VEO3',
            description: 'Danh sách các sơ đồ khối',
            icon: 'perm_media',
            link: '#',
            viewType: 'list', 
            children: [
                { type: 'image', title: '1 – KHỞI ĐỘNG & CHUẨN BỊ', description: 'Phân tích cấu trúc khối 1.', icon: 'settings_power', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 1.png' },
                { type: 'image', title: '2 – TẠO SETUP MỚI', description: 'Create Configuration', icon: 'add_circle', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 2.png' },
                { type: 'image', title: '3 – KHAI BÁO ĐẦU DÒ/NÊM', description: 'Load Probe/Wedge', icon: 'sensors', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 3.png' },
                { type: 'image', title: '4 – THIẾT LẬP SCAN PLAN', description: 'Group Setup', icon: 'qr_code_scanner', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 4.png' },
                { type: 'image', title: '5 – TẠO GROUP 2', description: 'Nếu cần thiết', icon: 'layers', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 5.png' },
                { type: 'image', title: '6 – HIỆU CHUẨN', description: 'Calibration', icon: 'tune', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 6.png' },
                { type: 'image', title: '7 – HOÀN THIỆN THIẾT LẬP', description: 'Final Setup', icon: 'check_circle', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 7.png' },
                { type: 'image', title: '8 – QUÉT THỰC TẾ & DỮ LIỆU', description: 'Data Acquisition', icon: 'database', link: '#', details: 'IMG // 4.6 MB', image: './media_veo3/Khối 8.png' },
		]
        },
        'structure-map': {
            title: 'Sơ Đồ Hệ Thống',
            description: 'Sơ đồ tổng quan toàn bộ hệ thống VEO3.',
            icon: 'hub',
            link: '#',
            image: './media_veo3/mindmaptong.png',
            children: []
        }
    };

    // --- State ---
    const state = {
        activeCluster: null,
        activeLeaf: null,
    };

    // --- DOM ---
    const galaxy = document.getElementById('learning-galaxy');
    const mainNode = document.getElementById('main-node');
    const contentPanel = document.getElementById('content-detail-panel');
    const overlay = document.getElementById('panel-overlay');
    const mediaContainer = document.getElementById('media-container');
    const listContainer = document.getElementById('list-container');
    const youtubeEmbed = document.getElementById('youtube-embed');
    const themeIcon = document.getElementById('theme-icon');
    
    // Panel Elements
    const pTitle = document.getElementById('panel-title');
    const pDesc = document.getElementById('panel-description');
    const pIcon = document.getElementById('panel-icon');
    const pImg = document.getElementById('panel-image');
    const pVid = document.getElementById('panel-video');
    const pLink = document.getElementById('panel-link');

    // --- Theme Logic ---
    function initTheme() {
        // Mặc định là Light Mode như yêu cầu. 
        // Kiểm tra xem người dùng có lưu preference khác không.
        const userPref = localStorage.getItem('theme');
        if (userPref === 'dark') {
            document.documentElement.classList.add('dark');
            themeIcon.textContent = 'light_mode'; // Icon để chuyển sang light
        } else {
            document.documentElement.classList.remove('dark');
            themeIcon.textContent = 'dark_mode'; // Icon để chuyển sang dark
        }
    }

    function toggleTheme() {
        const html = document.documentElement;
        html.classList.toggle('dark');
        
        if (html.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
            themeIcon.textContent = 'light_mode';
        } else {
            localStorage.setItem('theme', 'light');
            themeIcon.textContent = 'dark_mode';
        }
    }

    // --- Core Logic ---
    function init() {
        initTheme();
        positionNodes();
        window.addEventListener('resize', () => positionNodes());
    }

    function positionNodes() {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const isMobile = window.innerWidth < 768;
        const offsetX = 0;

        mainNode.style.left = `${cx + offsetX}px`;
        mainNode.style.top = `${cy}px`;
        mainNode.style.transform = 'translate(-50%, -50%)';

        const topics = document.querySelectorAll('.map-node.type-topic');
        const radius = isMobile ? 120 : 250; 
        
        topics.forEach((topic, index) => {
            let angle;
            if (isMobile) {
                // Phân bố đều hình tam giác cho mobile
                const angles = [-Math.PI/2, Math.PI/6, 5*Math.PI/6];
                angle = angles[index % 3];
            } else {
                angle = (index / topics.length) * 2 * Math.PI - Math.PI/2; 
            }

            const x = (cx + offsetX) + radius * Math.cos(angle);
            const y = cy + radius * Math.sin(angle);

            topic.style.left = `${x}px`;
            topic.style.top = `${y}px`;
            topic.style.transform = 'translate(-50%, -50%)';
            
            if(state.activeCluster) {
                 setTimeout(() => {
                     const parent = document.querySelector(`[data-node-id="${state.activeCluster}"]`);
                     if(parent) expandCluster(state.activeCluster, parent);
                 }, 300);
            }
        });
    }

    // --- Interactions ---
    document.querySelectorAll('.map-node').forEach(node => {
        node.addEventListener('click', (e) => {
            e.stopPropagation();
            const nodeId = node.dataset.nodeId;
            const parentId = node.dataset.parentNode;

            if (nodeId) { // Topic Clicked
                const data = nodeData[nodeId];
                
                if (data && (data.videoType === 'youtube' || data.viewType === 'list' || data.image)) {
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    showPanel(data);
                    return;
                }

                if (state.activeCluster === nodeId) {
                    collapseCluster(nodeId);
                } else {
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    expandCluster(nodeId, node);
                }
            } else if (parentId) { // Leaf Clicked
                handleLeafClick(node, parentId);
            } else if (node === mainNode) {
                showPanel({
                    title: 'Hệ Thống VEO3',
                    description: 'Thiết bị kiểm tra siêu âm mảng pha (PAUT) tiên tiến. Nhấp vào các nút xung quanh để xem tài liệu.',
                    icon: 'science',
                    link: '#',
                    image: './media_veo3/veo3_hinhmay.png'
                });
            }
        });
    });

    document.addEventListener('click', (e) => {
        // Overlay handle click now
    });

    // --- Cluster Logic ---
    function expandCluster(clusterId, parentNode) {
        state.activeCluster = clusterId;
        parentNode.classList.add('active-cluster');
        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());

        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);
        const isMobile = window.innerWidth < 768;
        const radius = isMobile ? 120 : 180;
        
        children.forEach((child, index) => {
            child.classList.remove('hidden', 'node-hidden');
            let angle;
            if (isMobile) {
                const isTop = cy < window.innerHeight / 2;
                const baseAngle = isTop ? Math.PI/2 : -Math.PI/2;
                const spread = Math.PI * 0.8;
                const start = baseAngle - spread/2;
                const step = spread / (children.length - 1 || 1);
                angle = children.length === 1 ? baseAngle : start + (index * step);
            } else {
                angle = (index / children.length) * 2 * Math.PI;
            }

            const tx = cx + radius * Math.cos(angle);
            const ty = cy + radius * Math.sin(angle);

            child.style.left = `${tx}px`;
            child.style.top = `${ty}px`;
            child.style.transform = 'translate(-50%, -50%) scale(1)';

            setTimeout(() => createLine(parentNode, child, `line-${clusterId}`), 300);
        });
    }

    function collapseCluster(clusterId) {
        const parentNode = document.querySelector(`[data-node-id="${clusterId}"]`);
        if(parentNode) parentNode.classList.remove('active-cluster');
        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);

        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());
        children.forEach(child => {
            child.style.left = `${cx}px`;
            child.style.top = `${cy}px`;
            child.classList.add('node-hidden');
            setTimeout(() => child.classList.add('hidden'), 400);
        });
        state.activeCluster = null;
        closePanel();
    }

    function handleLeafClick(node, parentId) {
        if (state.activeLeaf) state.activeLeaf.classList.remove('active-node');
        state.activeLeaf = node;
        node.classList.add('active-node');
        const text = node.textContent.trim();
        const data = nodeData[parentId].children.find(c => text.includes(c.title));
        if(data) showPanel(data);
    }

    function showPanel(data) {
        youtubeEmbed.innerHTML = '';
        pVid.pause();

        pTitle.textContent = data.title;
        pDesc.textContent = data.description;
        pIcon.textContent = data.icon;
        pLink.href = data.link;

        mediaContainer.classList.add('hidden');
        listContainer.classList.add('hidden');
        pImg.classList.add('hidden');
        pVid.classList.add('hidden');
        youtubeEmbed.classList.add('hidden');
        
        listContainer.innerHTML = '';

        if (data.viewType === 'list') {
            listContainer.classList.remove('hidden');
            if (data.children && data.children.length > 0) {
                data.children.forEach(child => {
                    const item = document.createElement('div');
                    // Sử dụng class panel-item-light để style động theo theme
                    item.className = 'panel-item-light flex items-center p-3 rounded-lg cursor-pointer transition-colors group';
                    item.innerHTML = `
                        <div class="w-10 h-10 rounded bg-blue-100 dark:bg-holo-blue/20 flex items-center justify-center mr-3 border border-blue-200 dark:border-holo-blue/30">
                            <span class="material-symbols-outlined text-blue-600 dark:text-holo-blue">${child.icon || 'image'}</span>
                        </div>
                        <div class="flex-grow">
                            <div class="font-medium text-sm text-slate-800 dark:text-white group-hover:text-blue-600 dark:group-hover:text-holo-cyan transition-colors">${child.title}</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">${child.details || 'Chi tiết'}</div>
                        </div>
                        <span class="material-symbols-outlined text-slate-300 dark:text-white/20 group-hover:text-blue-500 dark:group-hover:text-white transition-colors text-sm">arrow_forward_ios</span>
                    `;
                    item.onclick = () => showPanel(child);
                    listContainer.appendChild(item);
                });
            } else {
                 listContainer.innerHTML = '<p class="text-slate-400 dark:text-gray-500 text-sm text-center py-4">Chưa có dữ liệu.</p>';
            }
        } else if (data.videoType === 'youtube') {
            mediaContainer.classList.remove('hidden');
            youtubeEmbed.classList.remove('hidden');
            youtubeEmbed.innerHTML = `<iframe id="ytplayer" type="text/html" width="100%" height="100%" src="${data.videoSrc}" frameborder="0" allowfullscreen></iframe>`;
        } else if (data.image) {
            mediaContainer.classList.remove('hidden');
            pImg.src = data.image;
            pImg.classList.remove('hidden');
        } else if (data.video) {
            mediaContainer.classList.remove('hidden');
            pVid.src = data.video;
            pVid.classList.remove('hidden');
        }

        contentPanel.classList.add('panel-visible');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
    }

    function closePanel() {
        contentPanel.classList.remove('panel-visible');
        overlay.classList.add('opacity-0');
        setTimeout(() => overlay.classList.add('hidden'), 300);

        setTimeout(() => {
            youtubeEmbed.innerHTML = '';
            pVid.pause();
        }, 300);

        if (state.activeLeaf) {
            state.activeLeaf.classList.remove('active-node');
            state.activeLeaf = null;
        }
    }

    // --- Utils ---
    function createLine(el1, el2, cls) {
        const x1 = parseFloat(el1.style.left);
        const y1 = parseFloat(el1.style.top);
        const x2 = parseFloat(el2.style.left);
        const y2 = parseFloat(el2.style.top);
        const dist = Math.hypot(x2 - x1, y2 - y1);
        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

        const line = document.createElement('div');
        line.className = `connecting-line ${cls}`;
        line.style.width = `0px`;
        line.style.left = `${x1}px`;
        line.style.top = `${y1}px`;
        line.style.transform = `rotate(${angle}deg)`;
        galaxy.appendChild(line);
        requestAnimationFrame(() => {
            line.style.width = `${dist}px`;
            line.style.opacity = 1;
        });
    }

    init();
</script>
</body>
</html>
