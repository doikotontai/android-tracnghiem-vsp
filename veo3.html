<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<!-- Giữ user-scalable=no để ta tự xử lý zoom bằng JS mượt hơn, tránh xung đột với trình duyệt -->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Learning Content Galaxy - VEO3</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

<!-- =============================================================== -->
<!-- LOAD DỮ LIỆU NỘI DUNG TỪ FILE BÊN NGOÀI                         -->
<!-- =============================================================== -->
<script src="./media_veo3/Khối 1.js"></script>
<script src="./media_veo3/Khối 2.js"></script>
<script src="./media_veo3/Khối 3.js"></script>
<script src="./media_veo3/Khối 4.js"></script>
<script src="./media_veo3/Khối 5.js"></script>
<script src="./media_veo3/Khối 6.js"></script>
<script src="./media_veo3/Khối 7.js"></script>
<script src="./media_veo3/Khối 8.js"></script>
<!-- THÊM FILE HDSD CHI TIẾT -->
<script src="./media_veo3/hdsd_chitiet.js"></script>

<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    holo: {
                        bg: "#050810",
                        surface: "rgba(10, 20, 35, 0.9)", 
                        border: "rgba(100, 220, 255, 0.3)",
                        text: "#d0e0ff",
                        cyan: "#00f0ff",
                        purple: "#bc13fe",
                        green: "#0aff0a",
                        blue: "#3b82f6"
                    },
                    light: {
                        bg: "#f0f4f9",
                        surface: "rgba(255, 255, 255, 0.9)",
                        border: "rgba(0, 100, 200, 0.2)",
                        text: "#1e293b",
                        accent: "#0284c7"
                    }
                },
                fontFamily: {
                    sans: ["Inter", "sans-serif"],
                    display: "Be Vietnam Pro"
                },
                animation: {
                    'machine-hover': 'machineHover 3s ease-in-out infinite',
                },
                keyframes: {
                    machineHover: {
                        '0%, 100%': { transform: 'translate(-50%, -50%) scale(1)' },
                        '50%': { transform: 'translate(-50%, -52%) scale(1.02)' },
                    }
                }
            }
        }
    };
</script>
<style type="text/tailwindcss">
    :root {
        --bg-primary: #f8fafc;
        --bg-grid: rgba(0, 0, 0, 0.05);
        --bg-gradient-start: rgba(220, 230, 255, 0.6);
        --bg-gradient-end: #ffffff;
        --line-color: rgba(96, 165, 250, 0.4);
        --node-bg: rgba(255, 255, 255, 0.85);
        --node-border: rgba(200, 200, 200, 0.6);
        --node-text: #1e293b;
        --node-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        --main-node-glow: rgba(56, 189, 248, 0.5);
    }

    .dark {
        --bg-primary: #050810;
        --bg-grid: rgba(0, 240, 255, 0.05);
        --bg-gradient-start: rgba(20, 30, 60, 0.4);
        --bg-gradient-end: #050810;
        --line-color: rgba(0, 240, 255, 0.3);
        --node-bg: rgba(15, 25, 45, 0.7);
        --node-border: rgba(0, 240, 255, 0.3);
        --node-text: #d0e0ff;
        --node-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        --main-node-glow: rgba(0, 220, 255, 0.6);
    }

    body {
        background-color: var(--bg-primary);
        color: var(--node-text);
        overflow: hidden; 
        font-family: 'Inter', sans-serif;
        touch-action: none; 
        -webkit-tap-highlight-color: transparent;
        transition: background-color 0.5s ease, color 0.5s ease;
    }

    .conceptual-map-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: 
            radial-gradient(circle at 50% 50%, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 80%),
            linear-gradient(var(--bg-grid) 1px, transparent 1px),
            linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        cursor: grab;
    }
    .conceptual-map-container:active { cursor: grabbing; }

    #galaxy-transformer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        transform-origin: center center; will-change: transform; transition: transform 0.1s linear; 
    }
    .smooth-reset { transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important; }

    .connecting-line {
        position: absolute; height: 1px;
        background: linear-gradient(90deg, transparent, var(--line-color), transparent);
        transform-origin: 0 50%; pointer-events: none; z-index: 5; opacity: 0;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    }

    .map-node {
        position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; z-index: 10; backdrop-filter: blur(8px);
        transition: opacity 0.3s ease, background 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        -webkit-user-select: none; user-select: none;
    }
    .node-hidden { opacity: 0; pointer-events: none; }

    /* CSS CHO NÚT CHÍNH (HÌNH CÁI MÁY) */
    .map-node.type-main {
        width: 180px; height: 180px; background: transparent; border: none; box-shadow: none; 
        color: var(--node-text); z-index: 10; padding: 0; overflow: visible; 
        animation: machine-hover 4s ease-in-out infinite alternate;
        /* QUAN TRỌNG: Tắt hiệu ứng mờ nền để xóa khung mờ */
        backdrop-filter: none; 
    }
    .map-node.type-main::before {
        content: none; /* Đảm bảo không có glow giả */
    }
    @media (min-width: 768px) { .map-node.type-main { width: 300px; height: 300px; } }

    .map-node.type-topic {
        background: var(--node-bg); border: 1px solid var(--node-border);
        border-radius: 50px; padding: 6px 14px; color: var(--node-text);
        font-weight: 600; text-transform: uppercase; font-size: 0.75rem; 
        min-width: 90px; box-shadow: var(--node-shadow); white-space: nowrap; z-index: 30; 
    }
    .map-node.type-topic.video-trigger {
        border-color: rgba(255, 68, 68, 0.5); box-shadow: 0 0 15px rgba(255, 68, 68, 0.15);
    }
    .map-node.type-topic.video-trigger .material-symbols-outlined { color: #ef4444; }
    .map-node.type-topic:active, .map-node.type-topic.active-cluster {
        background: rgba(14, 165, 233, 0.15); border-color: #0ea5e9;
        transform: translate(-50%, -50%) scale(1.05); 
    }
    .dark .map-node.type-topic:active, .dark .map-node.type-topic.active-cluster {
        background: rgba(0, 240, 255, 0.15); border-color: #00f0ff;
    }
    @media (min-width: 768px) { .map-node.type-topic { padding: 12px 24px; font-size: 0.9rem; min-width: 140px; } }

    .map-node.type-image {
        background: var(--node-bg); border: 1px solid var(--node-border);
        border-radius: 6px; padding: 6px 10px; font-size: 0.7rem; color: var(--node-text);
        display: flex; align-items: center; gap: 6px; max-width: 160px;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        border-left: 3px solid #10b981; box-shadow: var(--node-shadow);
    }
    .map-node.type-image .material-symbols-outlined { color: #10b981; font-size: 16px; }
    .map-node.active-node {
        background: #0ea5e9; border-color: #fff; color: #fff; z-index: 50;
    }
    .dark .map-node.active-node { background: rgba(20, 40, 80, 0.95); }

    .node-content-panel {
        background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(20px); color: #1e293b; z-index: 100;
        position: fixed; top: 50%; left: 50%; width: 90%; max-width: 500px; max-height: 85vh;
        transform: translate(-50%, -50%) scale(0.9); opacity: 0; pointer-events: none;
        border-radius: 16px; padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease, max-width 0.3s ease;
        display: flex; flex-direction: column;
    }
    
    /* MEDIA QUERY MỚI: TĂNG CHIỀU RỘNG TRÊN MÀN HÌNH LỚN */
    @media (min-width: 768px) {
        .node-content-panel {
            max-width: 900px; /* Tăng từ 500px lên 900px cho Desktop */
            width: 85%;
        }
    }

    .dark .node-content-panel {
        background: rgba(12, 18, 32, 0.95); border: 1px solid rgba(0, 240, 255, 0.3);
        color: #e0f0ff; box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.1);
    }
    .node-content-panel.panel-visible {
        transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto;
    }

    .aspect-video-container {
        position: relative; width: 100%; padding-bottom: 56.25%; background: #000;
        border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-shrink: 0;
    }
    .aspect-video-container iframe, .aspect-video-container video, .aspect-video-container img {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;
    }
    
    .panel-item-light {
        background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .dark .panel-item-light {
        background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gesture-hint {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.5); color: white; padding: 6px 12px;
        border-radius: 20px; font-size: 12px; pointer-events: none; opacity: 0;
        transition: opacity 0.5s; z-index: 90;
    }
    
    /* Document/Manual Content Styling */
    .manual-section h3 {
        font-size: 1.1rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem;
        color: #0284c7; /* Sky 600 */
    }
    .dark .manual-section h3 { color: #38bdf8; /* Sky 400 */ }
    .manual-section ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    .manual-section p { margin-bottom: 0.8rem; }

    /* ========================================= */
    /* NEW THEME SWITCH STYLES (From Uiverse.io) */
    /* ========================================= */
    .theme-switch {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 100;
        --toggle-size: 15px; /* Điều chỉnh kích thước ở đây nếu cần */
        --container-width: 5.625em;
        --container-height: 2.5em;
        --container-radius: 6.25em;
        --container-light-bg: #3D7EAE;
        --container-night-bg: #1D1F2C;
        --circle-container-diameter: 3.375em;
        --sun-moon-diameter: 2.125em;
        --sun-bg: #ECCA2F;
        --moon-bg: #C4C9D1;
        --spot-color: #959DB1;
        --circle-container-offset: calc((var(--circle-container-diameter) - var(--container-height)) / 2 * -1);
        --stars-color: #fff;
        --clouds-color: #F3FDFF;
        --back-clouds-color: #AACADF;
        --transition: .5s cubic-bezier(0, -0.02, 0.4, 1.25);
        --circle-transition: .3s cubic-bezier(0, -0.02, 0.35, 1.17);
    }

    .theme-switch, .theme-switch *, .theme-switch *::before, .theme-switch *::after {
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-size: var(--toggle-size);
    }

    .theme-switch__container {
        width: var(--container-width);
        height: var(--container-height);
        background-color: var(--container-light-bg);
        border-radius: var(--container-radius);
        overflow: hidden;
        cursor: pointer;
        -webkit-box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
        box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
        -webkit-transition: var(--transition);
        -o-transition: var(--transition);
        transition: var(--transition);
        position: relative;
    }

    .theme-switch__container::before {
        content: "";
        position: absolute;
        z-index: 1;
        inset: 0;
        -webkit-box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
        box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
        border-radius: var(--container-radius)
    }

    .theme-switch__checkbox {
        display: none;
    }

    .theme-switch__circle-container {
        width: var(--circle-container-diameter);
        height: var(--circle-container-diameter);
        background-color: rgba(255, 255, 255, 0.1);
        position: absolute;
        left: var(--circle-container-offset);
        top: var(--circle-container-offset);
        border-radius: var(--container-radius);
        -webkit-box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-transition: var(--circle-transition);
        -o-transition: var(--circle-transition);
        transition: var(--circle-transition);
        pointer-events: none;
    }

    .theme-switch__sun-moon-container {
        pointer-events: auto;
        position: relative;
        z-index: 2;
        width: var(--sun-moon-diameter);
        height: var(--sun-moon-diameter);
        margin: auto;
        border-radius: var(--container-radius);
        background-color: var(--sun-bg);
        -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
        box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
        -webkit-filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
        filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
        overflow: hidden;
        -webkit-transition: var(--transition);
        -o-transition: var(--transition);
        transition: var(--transition);
    }

    .theme-switch__moon {
        -webkit-transform: translateX(100%);
        -ms-transform: translateX(100%);
        transform: translateX(100%);
        width: 100%;
        height: 100%;
        background-color: var(--moon-bg);
        border-radius: inherit;
        -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
        box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
        -webkit-transition: var(--transition);
        -o-transition: var(--transition);
        transition: var(--transition);
        position: relative;
    }

    .theme-switch__spot {
        position: absolute;
        top: 0.75em;
        left: 0.312em;
        width: 0.75em;
        height: 0.75em;
        border-radius: var(--container-radius);
        background-color: var(--spot-color);
        -webkit-box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
        box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
    }

    .theme-switch__spot:nth-of-type(2) {
        width: 0.375em;
        height: 0.375em;
        top: 0.937em;
        left: 1.375em;
    }

    .theme-switch__spot:nth-last-of-type(3) {
        width: 0.25em;
        height: 0.25em;
        top: 0.312em;
        left: 0.812em;
    }

    .theme-switch__clouds {
        width: 1.25em;
        height: 1.25em;
        background-color: var(--clouds-color);
        border-radius: var(--container-radius);
        position: absolute;
        bottom: -0.625em;
        left: 0.312em;
        -webkit-box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
        box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
        -webkit-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
        -o-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
        transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
    }

    .theme-switch__stars-container {
        position: absolute;
        color: var(--stars-color);
        top: -100%;
        left: 0.312em;
        width: 2.75em;
        height: auto;
        -webkit-transition: var(--transition);
        -o-transition: var(--transition);
        transition: var(--transition);
    }

    /* actions */

    .theme-switch__checkbox:checked + .theme-switch__container {
        background-color: var(--container-night-bg);
    }

    .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container {
        left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter));
    }

    .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container:hover {
        left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter) - 0.187em)
    }

    .theme-switch__circle-container:hover {
        left: calc(var(--circle-container-offset) + 0.187em);
    }

    .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__moon {
        -webkit-transform: translate(0);
        -ms-transform: translate(0);
        transform: translate(0);
    }

    .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__clouds {
        bottom: -4.062em;
    }

    .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__stars-container {
        top: 50%;
        -webkit-transform: translateY(-50%);
        -ms-transform: translateY(-50%);
        transform: translateY(-50%);
    }

    /* ========================================= */
    /* NEW CIRCUIT TRACE STYLES (Animated Lines) */
    /* ========================================= */
    .trace-bg {
        stroke: rgba(100, 220, 255, 0.2);
        stroke-width: 1.5;
        fill: none;
    }
    .dark .trace-bg {
        stroke: rgba(100, 220, 255, 0.15);
    }

    .trace-flow {
        stroke-width: 1.8;
        fill: none;
        stroke-dasharray: 40 400; /* Dấu gạch dài 40px, khoảng trống 400px */
        stroke-dashoffset: 440;
        filter: drop-shadow(0 0 6px currentColor);
        animation: flow 3s cubic-bezier(0.5, 0, 0.9, 1) infinite;
    }
    
    /* MOBILE OPTIMIZATION FOR CIRCUIT EFFECT */
    @media (max-width: 768px) {
        .trace-bg {
            stroke-width: 0.8; /* Mỏng hơn để tinh tế trên màn hình nhỏ */
            opacity: 0.6;
        }
        .trace-flow {
            stroke-width: 1.2; /* Mỏng hơn */
            stroke-dasharray: 15 120; /* Vệt sáng ngắn hơn và xuất hiện dày hơn một chút */
            stroke-dashoffset: 135;
            filter: drop-shadow(0 0 2px currentColor); /* Giảm glow để tăng hiệu năng và độ nét */
            animation-duration: 2s; /* Tốc độ nhanh hơn vì quãng đường ngắn */
        }
    }

    .circuit-blue {
        stroke: #3b82f6;
        color: #3b82f6;
    }
    .dark .circuit-blue {
        stroke: #00f0ff;
        color: #00f0ff; /* Neon cyan for dark mode */
    }

    @keyframes flow {
        to {
            stroke-dashoffset: 0;
        }
    }
</style>
</head>
<body class="min-h-screen flex flex-col transition-colors duration-500">

<!-- REPLACED OLD BUTTON WITH NEW ANIMATED TOGGLE -->
<label class="theme-switch" for="theme-toggle">
    <input type="checkbox" class="theme-switch__checkbox" id="theme-toggle" onchange="handleThemeToggle(event)">
    <div class="theme-switch__container">
        <div class="theme-switch__clouds"></div>
        <div class="theme-switch__stars-container">
            <!-- Simple SVG Stars -->
            <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%">
                <circle cx="4" cy="4" r="1.5" />
                <circle cx="12" cy="8" r="1" />
                <circle cx="20" cy="5" r="1.2" />
                <circle cx="8" cy="18" r="1" />
                <circle cx="18" cy="16" r="1.5" />
            </svg>
        </div>
        <div class="theme-switch__circle-container">
            <div class="theme-switch__sun-moon-container">
                <div class="theme-switch__moon">
                    <div class="theme-switch__spot"></div>
                    <div class="theme-switch__spot"></div>
                    <div class="theme-switch__spot"></div>
                </div>
            </div>
        </div>
    </div>
</label>

<div class="fixed top-4 left-4 z-30 pointer-events-none md:hidden">
    <div class="flex items-center space-x-2 bg-white/40 dark:bg-black/40 backdrop-blur rounded-full p-1 pr-3 border border-black/10 dark:border-white/10 pointer-events-auto shadow-sm">
        <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-holo-cyan/20 flex items-center justify-center text-blue-600 dark:text-holo-cyan">
            <span class="material-symbols-outlined text-lg">science</span>
        </div>
        <span class="text-xs font-bold text-slate-700 dark:text-white tracking-widest">VEO3</span>
    </div>
</div>

<div class="gesture-hint" id="zoom-hint">Kéo để di chuyển • Nhấn đúp để Reset</div>

<div id="panel-overlay" class="fixed inset-0 bg-black/30 dark:bg-black/70 backdrop-blur-[2px] z-50 hidden opacity-0 transition-opacity duration-300" onclick="closePanel()"></div>

<main class="flex-grow w-full relative h-screen overflow-hidden">
    <div class="absolute inset-0 conceptual-map-container" id="learning-galaxy">
        <div id="galaxy-transformer">
            <!-- SVG LAYER CHO HIỆU ỨNG MẠCH ĐIỆN -->
            <svg id="svg-connections" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 1; overflow: visible;">
                <!-- Lines will be drawn here by JS -->
            </svg>

            <div class="map-node type-main" id="main-node">
                <!-- ĐÃ XÓA FILTER DROP-SHADOW TRONG CLASS DƯỚI ĐÂY -->
                <img src="./media_veo3/veo3hinhmay.png" alt="VEO3 Machine" class="w-full h-full object-contain transition-all duration-300">
            </div>
            
            <!-- ĐÃ ĐỔI TÊN THÀNH 'VIDEO' -->
            <div class="map-node type-topic video-trigger" data-node-id="core-docs">
                <span class="material-symbols-outlined text-base mr-1 md:mr-2">play_circle</span>
                VIDEO
            </div>
            
            <div class="map-node type-topic" data-node-id="visual-assets">
                <span class="material-symbols-outlined text-base mr-1 md:mr-2">perm_media</span>
                MỤC LỤC
            </div>
            <div class="map-node type-topic" data-node-id="structure-map">
                <span class="material-symbols-outlined text-base mr-1 md:mr-2">hub</span>
                SƠ ĐỒ
            </div>
            
            <!-- THÊM MỤC MỚI 'HDSD' -->
            <div class="map-node type-topic" data-node-id="full-manual">
                <span class="material-symbols-outlined text-base mr-1 md:mr-2">description</span>
                HDSD
            </div>
        </div>
    </div>

    <div class="node-content-panel shadow-2xl" id="content-detail-panel">
        <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 dark:text-white/50 dark:hover:text-white p-2 z-10 transition-colors" onclick="closePanel()">
            <span class="material-symbols-outlined">close</span>
        </button>
        
        <!-- HEADER WITH NAVIGATION -->
        <div class="flex items-center mb-2 pr-8">
            <!-- Nút Back Mới -->
            <button id="panel-back-btn" class="hidden mr-2 p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-500 dark:text-slate-300 active:scale-95" title="Trở lại">
                <span class="material-symbols-outlined text-2xl">arrow_back</span>
            </button>
            
            <h3 class="font-semibold text-lg flex items-center text-slate-800 dark:text-white flex-grow">
                <span class="material-symbols-outlined text-xl mr-2 text-blue-500 dark:text-holo-cyan" id="panel-icon"></span>
                <span id="panel-title">Tiêu đề</span>
            </h3>
        </div>
        
        <div class="h-px w-full bg-gradient-to-r from-blue-200 to-transparent dark:from-holo-cyan/50 mb-4 flex-shrink-0"></div>
        
        <div class="overflow-y-auto pr-2 scrollbar-hide flex-grow">
            <div class="aspect-video-container mb-4 hidden" id="media-container">
                <div id="youtube-embed"></div>
                
                <!-- NEW: LOADER CONTAINER -->
                <div id="panel-loader" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-gray-50/80 dark:bg-gray-900/80 backdrop-blur-sm transition-opacity duration-300">
                    <div class="flex-col gap-4 w-full flex items-center justify-center">
                      <div class="w-20 h-20 border-4 border-transparent text-blue-400 text-4xl animate-spin flex items-center justify-center border-t-blue-400 rounded-full">
                        <div class="w-16 h-16 border-4 border-transparent text-red-400 text-2xl animate-spin flex items-center justify-center border-t-red-400 rounded-full"></div>
                      </div>
                    </div>
                </div>

                <!-- Thêm opacity-0 và transition-opacity để làm hiệu ứng fade-in -->
                <img alt="Content preview" class="hidden opacity-0 transition-opacity duration-500" id="panel-image" src=""/>
                <video class="hidden" controls="" id="panel-video" src=""></video>
            </div>
            
            <div class="hidden flex flex-col gap-2 mb-4" id="list-container"></div>
            
            <p class="text-sm text-slate-600 dark:text-gray-300 leading-relaxed mb-2" id="panel-description">Mô tả nội dung...</p>
            
            <div id="panel-long-text" class="hidden text-sm text-slate-700 dark:text-gray-200 leading-relaxed mt-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700"></div>
        </div>
    </div>
</main>

<script>
    // --- LOAD DỮ LIỆU TỪ FILE NGOÀI AN TOÀN ---
    var contentKhoi1 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi2 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi3 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi4 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi5 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi6 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi7 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    var contentKhoi8 = "<i>(Chưa tìm thấy dữ liệu)</i>";
    // Biến cho nội dung HDSD Chi tiết
    var contentHdsdChitiet = "<i>(Chưa tìm thấy dữ liệu. Vui lòng kiểm tra file media_veo3/hdsd_chitiet.js)</i>";

    // Kiểm tra và gán giá trị
    if (typeof DATA_KHOI_1 !== 'undefined') contentKhoi1 = DATA_KHOI_1;
    if (typeof DATA_KHOI_2 !== 'undefined') contentKhoi2 = DATA_KHOI_2;
    if (typeof DATA_KHOI_3 !== 'undefined') contentKhoi3 = DATA_KHOI_3;
    if (typeof DATA_KHOI_4 !== 'undefined') contentKhoi4 = DATA_KHOI_4;
    if (typeof DATA_KHOI_5 !== 'undefined') contentKhoi5 = DATA_KHOI_5;
    if (typeof DATA_KHOI_6 !== 'undefined') contentKhoi6 = DATA_KHOI_6;
    if (typeof DATA_KHOI_7 !== 'undefined') contentKhoi7 = DATA_KHOI_7;
    if (typeof DATA_KHOI_8 !== 'undefined') contentKhoi8 = DATA_KHOI_8;
    if (typeof DATA_HDSD_CHITIET !== 'undefined') contentHdsdChitiet = DATA_HDSD_CHITIET;

    // --- CẤU HÌNH NODE ---
    const nodeData = {
        'core-docs': {
            title: 'HƯỚNG DẪN VẬN HÀNH VEO3 (VIDEO)',
            description: 'Xem video chi tiết quy trình lắp đặt và vận hành hệ thống VEO3.',
            icon: 'play_circle',
            link: 'https://youtu.be/b2TZ0QTYN-I',
            videoType: 'youtube', 
            videoSrc: 'https://www.youtube.com/embed/b2TZ0QTYN-I?autoplay=1', 
            children: [] 
        },
        // MỤC MỚI: FULL MANUAL
        'full-manual': {
            title: 'HƯỚNG DẪN SỬ DỤNG - CHI TIẾT',
            description: 'Tài liệu hướng dẫn vận hành VEO3 đầy đủ.',
            icon: 'description',
            link: '#',
            manualContent: contentHdsdChitiet, // Sử dụng biến nội dung mới
            children: []
        },
        'visual-assets': {
            title: 'Danh sách các sơ đồ khối',
            icon: 'perm_media',
            link: '#',
            viewType: 'list', 
            children: [
                { 
                    type: 'image', 
                    title: '1 – KHỞI ĐỘNG & CHUẨN BỊ', 
                    description: 'Phân tích cấu trúc khối 1 và các bước chuẩn bị ban đầu.', 
                    icon: 'settings_power', 
                    link: '#', 
                    image: './media_veo3/Khối 1.png',
                    manualContent: contentKhoi1 
                },
                { 
                    type: 'image', 
                    title: '2 – TẠO SETUP MỚI', 
                    description: 'Hướng dẫn tạo cấu hình (Configuration) cho thiết bị.', 
                    icon: 'add_circle', 
                    link: '#', 
                    image: './media_veo3/Khối 2.png',
                    manualContent: contentKhoi2 
                },
                { 
                    type: 'image', 
                    title: '3 – KHAI BÁO ĐẦU DÒ/NÊM', 
                    description: 'Load Probe/Wedge', 
                    icon: 'sensors', 
                    link: '#', 
                    image: './media_veo3/Khối 3.png',
                    manualContent: contentKhoi3
                },
                { 
                    type: 'image', 
                    title: '4 – THIẾT LẬP SCAN PLAN', 
                    description: 'Group Setup', 
                    icon: 'qr_code_scanner', 
                    link: '#', 
                    image: './media_veo3/Khối 4.png',
                    manualContent: contentKhoi4
                },
                { 
                    type: 'image', 
                    title: '5 – TẠO GROUP 2', 
                    description: 'Nếu cần thiết', 
                    icon: 'layers', 
                    link: '#', 
                    image: './media_veo3/Khối 5.png',
                    manualContent: contentKhoi5
                },
                { 
                    type: 'image', 
                    title: '6 – HIỆU CHUẨN', 
                    description: 'Calibration', 
                    icon: 'tune', 
                    link: '#', 
                    image: './media_veo3/Khối 6.png',
                    manualContent: contentKhoi6
                },
                { 
                    type: 'image', 
                    title: '7 – HOÀN THIỆN THIẾT LẬP', 
                    description: 'Final Setup', 
                    icon: 'check_circle', 
                    link: '#', 
                    image: './media_veo3/Khối 7.png',
                    manualContent: contentKhoi7
                },
                { 
                    type: 'image', 
                    title: '8 – QUÉT THỰC TẾ & DỮ LIỆU', 
                    description: 'Data Acquisition', 
                    icon: 'database', 
                    link: '#', 
                    image: './media_veo3/Khối 8.png',
                    manualContent: contentKhoi8
                },
                { type: 'image', title: '9 – GIẢI ĐOÁN DỮ LIỆU VỚI UT-STUDIO PC', description: 'Data Acquisition', icon: 'database', link: '#', image: './media_veo3/UTstudio_giaidoan.png' },
		]
        },
        'structure-map': {
            title: 'Sơ Đồ Hệ Thống',
            description: 'Sơ đồ tổng quan toàn bộ hệ thống VEO3.',
            icon: 'hub',
            link: '#',
            image: './media_veo3/mindmaptong.png',
            children: []
        }
    };

    const state = { activeCluster: null, activeLeaf: null };

    const galaxy = document.getElementById('learning-galaxy');
    const transformer = document.getElementById('galaxy-transformer');
    const mainNode = document.getElementById('main-node');
    const contentPanel = document.getElementById('content-detail-panel');
    const overlay = document.getElementById('panel-overlay');
    const mediaContainer = document.getElementById('media-container');
    const listContainer = document.getElementById('list-container');
    const youtubeEmbed = document.getElementById('youtube-embed');
    const themeIcon = document.getElementById('theme-icon');
    
    // Panel Elements
    const pTitle = document.getElementById('panel-title');
    const pDesc = document.getElementById('panel-description');
    const pIcon = document.getElementById('panel-icon');
    const pImg = document.getElementById('panel-image');
    const pVid = document.getElementById('panel-video');
    const pLongText = document.getElementById('panel-long-text');
    const pBackBtn = document.getElementById('panel-back-btn');
    const pLoader = document.getElementById('panel-loader'); // NEW LOADER

    function initTheme() {
        const userPref = localStorage.getItem('theme');
        const themeToggle = document.getElementById('theme-toggle');
        
        if (userPref === 'dark') {
            document.documentElement.classList.add('dark');
            if(themeToggle) themeToggle.checked = true;
        } else {
            document.documentElement.classList.remove('dark');
            if(themeToggle) themeToggle.checked = false;
        }
    }

    // Hàm mới xử lý sự kiện click vào toggle
    function handleThemeToggle(event) {
        const isChecked = event.target.checked;
        if (isChecked) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    }

    function toggleTheme() {
        // Fallback function if called directly
        const html = document.documentElement;
        html.classList.toggle('dark');
        const themeToggle = document.getElementById('theme-toggle');
        
        if (html.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
            if(themeToggle) themeToggle.checked = true;
        } else {
            localStorage.setItem('theme', 'light');
            if(themeToggle) themeToggle.checked = false;
        }
    }

    function init() {
        initTheme();
        positionNodes();
        setTimeout(() => document.getElementById('zoom-hint').style.opacity = '0.8', 1000);
        setTimeout(() => document.getElementById('zoom-hint').style.opacity = '0', 5000);
    }

    function positionNodes() {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const isMobile = window.innerWidth < 768;
        
        mainNode.style.left = `${cx}px`;
        mainNode.style.top = `${cy}px`;
        mainNode.style.transform = 'translate(-50%, -50%)';

        const topics = document.querySelectorAll('.map-node.type-topic');
        const radius = isMobile ? 145 : 280; 
        
        // --- PREPARE FOR SVG LINES ---
        const svg = document.getElementById('svg-connections');
        svg.innerHTML = ''; // Clear old lines
        
        topics.forEach((topic, index) => {
            let angle;
            if (isMobile) {
                // Adjust layout for 4 items: Top, Right, Bottom, Left
                const angles = [-Math.PI/2, 0, Math.PI/2, Math.PI];
                // Or keep spreading evenly:
                angle = (index / topics.length) * 2 * Math.PI - Math.PI/2;
            } else {
                angle = (index / topics.length) * 2 * Math.PI - Math.PI/2; 
            }

            const x = cx + radius * Math.cos(angle);
            const y = cy + radius * Math.sin(angle);

            topic.style.left = `${x}px`;
            topic.style.top = `${y}px`;
            topic.style.transform = 'translate(-50%, -50%)';
            
            // --- DRAW CIRCUIT LINES FROM CENTER TO TOPIC ---
            // Draw background line
            const pathBg = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pathBg.setAttribute('d', `M ${cx} ${cy} L ${x} ${y}`);
            pathBg.setAttribute('class', 'trace-bg');
            svg.appendChild(pathBg);

            // Draw animated flow line
            const pathFlow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pathFlow.setAttribute('d', `M ${cx} ${cy} L ${x} ${y}`);
            pathFlow.setAttribute('class', 'trace-flow circuit-blue');
            svg.appendChild(pathFlow);
            
            if(state.activeCluster) {
                 const parent = document.querySelector(`[data-node-id="${state.activeCluster}"]`);
                 const children = document.querySelectorAll(`[data-parent-node="${state.activeCluster}"]`);
                 if(parent && children.length > 0) {
                     collapseCluster(state.activeCluster);
                 }
            }
        });
    }

    let transformState = { x: 0, y: 0, scale: 1 };
    let isDragging = false;
    let startX = 0, startY = 0;
    let lastX = 0, lastY = 0;
    let initialPinchDist = 0;
    let initialScale = 1;
    let isPinching = false;
    let moveThreshold = 0;

    function updateTransform() {
        transformer.style.transform = `translate(${transformState.x}px, ${transformState.y}px) scale(${transformState.scale})`;
    }

    function getDistance(touches) {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    }

    galaxy.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        lastX = transformState.x;
        lastY = transformState.y;
        moveThreshold = 0;
        transformer.classList.remove('smooth-reset');
        galaxy.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        moveThreshold += Math.abs(e.movementX) + Math.abs(e.movementY);
        transformState.x = lastX + dx;
        transformState.y = lastY + dy;
        updateTransform();
    });

    window.addEventListener('mouseup', () => {
        isDragging = false;
        galaxy.style.cursor = 'grab';
    });

    galaxy.addEventListener('wheel', (e) => {
        e.preventDefault();
        const scaleAmount = -e.deltaY * 0.001;
        const newScale = Math.min(Math.max(0.5, transformState.scale + scaleAmount), 3);
        transformState.scale = newScale;
        updateTransform();
    }, { passive: false });

    galaxy.addEventListener('touchstart', (e) => {
        transformer.classList.remove('smooth-reset');
        if (e.touches.length === 1) {
            isDragging = true;
            isPinching = false;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            lastX = transformState.x;
            lastY = transformState.y;
            moveThreshold = 0;
        } else if (e.touches.length === 2) {
            isDragging = false;
            isPinching = true;
            initialPinchDist = getDistance(e.touches);
            initialScale = transformState.scale;
        }
    }, { passive: false });

    galaxy.addEventListener('touchmove', (e) => {
        if (isDragging && e.touches.length === 1) {
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            moveThreshold += Math.abs(dx) + Math.abs(dy);
             transformState.x = lastX + dx;
             transformState.y = lastY + dy;
            updateTransform();
        } else if (isPinching && e.touches.length === 2) {
            e.preventDefault();
            const currentDist = getDistance(e.touches);
            const scaleFactor = currentDist / initialPinchDist;
            const newScale = Math.min(Math.max(0.5, initialScale * scaleFactor), 3);
            transformState.scale = newScale;
            updateTransform();
        }
    }, { passive: false });

    galaxy.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) isDragging = false;
        if (e.touches.length < 2) isPinching = false;
    });

    let lastTap = 0;
    galaxy.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0 && moveThreshold < 10) {
            resetView();
            e.preventDefault();
        }
        lastTap = currentTime;
    });
    galaxy.addEventListener('dblclick', () => {
        resetView();
    });

    function resetView() {
        transformer.classList.add('smooth-reset');
        transformState = { x: 0, y: 0, scale: 1 };
        updateTransform();
    }

    document.querySelectorAll('.map-node').forEach(node => {
        node.addEventListener('click', (e) => {
            e.stopPropagation();
            if (moveThreshold > 5) return;

            const nodeId = node.dataset.nodeId;
            const parentId = node.dataset.parentNode;

            if (nodeId) { // Topic Clicked
                const data = nodeData[nodeId];
                
                if (data && (data.videoType === 'youtube' || data.viewType === 'list' || data.image || data.manualContent)) {
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    showPanel(data);
                    return;
                }

                if (state.activeCluster === nodeId) {
                    collapseCluster(nodeId);
                } else {
                    if (state.activeCluster) collapseCluster(state.activeCluster);
                    expandCluster(nodeId, node);
                }
            } else if (parentId) { // Leaf Clicked
                handleLeafClick(node, parentId);
            } else if (node === mainNode) {
                showPanel({
                    title: 'Hệ Thống VEO3',
                    description: 'Thiết bị kiểm tra siêu âm mảng pha (PAUT) tiên tiến. Nhấp vào các nút xung quanh để xem tài liệu.',
                    icon: 'science',
                    link: '#',
                    image: './media_veo3/veo3hinhmay.png'
                });
            }
        });
        node.addEventListener('touchstart', (e) => {}, {passive: true});
    });

    function expandCluster(clusterId, parentNode) {
        state.activeCluster = clusterId;
        parentNode.classList.add('active-cluster');
        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());

        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);
        const isMobile = window.innerWidth < 768;
        
        const radius = isMobile ? 110 : 180;
        
        children.forEach((child, index) => {
            child.classList.remove('hidden', 'node-hidden');
            let angle;
            if (isMobile) {
                const isTop = cy < window.innerHeight / 2;
                const baseAngle = isTop ? Math.PI/2 : -Math.PI/2;
                const spread = Math.PI * 0.7; 
                const start = baseAngle - spread/2;
                const step = spread / (children.length - 1 || 1);
                angle = children.length === 1 ? baseAngle : start + (index * step);
            } else {
                angle = (index / children.length) * 2 * Math.PI;
            }

            const tx = cx + radius * Math.cos(angle);
            const ty = cy + radius * Math.sin(angle);

            child.style.left = `${tx}px`;
            child.style.top = `${ty}px`;
            child.style.transform = 'translate(-50%, -50%) scale(1)';

            setTimeout(() => createLine(parentNode, child, `line-${clusterId}`), 300);
        });
    }

    function collapseCluster(clusterId) {
        const parentNode = document.querySelector(`[data-node-id="${clusterId}"]`);
        if(parentNode) parentNode.classList.remove('active-cluster');
        const children = document.querySelectorAll(`[data-parent-node="${clusterId}"]`);
        if (!parentNode) return;

        const cx = parseFloat(parentNode.style.left);
        const cy = parseFloat(parentNode.style.top);

        document.querySelectorAll(`.line-${clusterId}`).forEach(l => l.remove());
        children.forEach(child => {
            child.style.left = `${cx}px`;
            child.style.top = `${cy}px`;
            child.classList.add('node-hidden');
            setTimeout(() => child.classList.add('hidden'), 400);
        });
        state.activeCluster = null;
        closePanel();
    }

    function handleLeafClick(node, parentId) {
        if (state.activeLeaf) state.activeLeaf.classList.remove('active-node');
        state.activeLeaf = node;
        node.classList.add('active-node');
        const text = node.textContent.trim();
        const parentData = nodeData[parentId];
        const data = parentData.children.find(c => text.includes(c.title));
        if(data) showPanel(data, parentData);
    }

    function showPanel(data, parentData = null) {
        youtubeEmbed.innerHTML = '';
        pVid.pause();

        pTitle.textContent = data.title;
        pDesc.textContent = data.description;
        pIcon.textContent = data.icon;
        
        if (parentData) {
            pBackBtn.classList.remove('hidden');
            pBackBtn.onclick = () => showPanel(parentData);
        } else {
            pBackBtn.classList.add('hidden');
            pBackBtn.onclick = null;
        }

        mediaContainer.classList.add('hidden');
        listContainer.classList.add('hidden');
        pImg.classList.add('hidden');
        pImg.classList.add('opacity-0'); // Reset opacity hidden
        pVid.classList.add('hidden');
        youtubeEmbed.classList.add('hidden');
        pLongText.classList.add('hidden');
        pLongText.innerHTML = '';
        pLoader.classList.add('hidden'); // Reset loader
        
        listContainer.innerHTML = '';

        if (data.viewType === 'list') {
            listContainer.classList.remove('hidden');
            if (data.children && data.children.length > 0) {
                data.children.forEach(child => {
                    const item = document.createElement('div');
                    item.className = 'panel-item-light flex items-center p-3 rounded-lg cursor-pointer transition-colors group';
                    item.innerHTML = `
                        <div class="w-10 h-10 rounded bg-blue-100 dark:bg-holo-blue/20 flex items-center justify-center mr-3 border border-blue-200 dark:border-holo-blue/30">
                            <span class="material-symbols-outlined text-blue-600 dark:text-holo-blue">${child.icon || 'image'}</span>
                        </div>
                        <div class="flex-grow">
                            <div class="font-medium text-sm text-slate-800 dark:text-white group-hover:text-blue-600 dark:group-hover:text-holo-cyan transition-colors">${child.title}</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">${child.details || 'Chi tiết'}</div>
                        </div>
                        <span class="material-symbols-outlined text-slate-300 dark:text-white/20 group-hover:text-blue-500 dark:group-hover:text-white transition-colors text-sm">arrow_forward_ios</span>
                    `;
                    item.onclick = () => showPanel(child, data);
                    listContainer.appendChild(item);
                });
            } else {
                 listContainer.innerHTML = '<p class="text-slate-400 dark:text-gray-500 text-sm text-center py-4">Chưa có dữ liệu.</p>';
            }
        } else if (data.videoType === 'youtube') {
            mediaContainer.classList.remove('hidden');
            youtubeEmbed.classList.remove('hidden');
            youtubeEmbed.innerHTML = `<iframe id="ytplayer" type="text/html" width="100%" height="100%" src="${data.videoSrc}" frameborder="0" allowfullscreen></iframe>`;
        } else if (data.image) {
            mediaContainer.classList.remove('hidden');
            
            // LOGIC MỚI CHO LOADER
            pLoader.classList.remove('hidden'); // Hiện loader trước
            pImg.classList.add('hidden');
            pImg.classList.add('opacity-0');
            
            pImg.onload = () => {
                pLoader.classList.add('hidden'); // Ẩn loader
                pImg.classList.remove('hidden'); // Hiện container ảnh
                // Dùng requestAnimationFrame để đảm bảo transition hoạt động mượt
                requestAnimationFrame(() => {
                    pImg.classList.remove('opacity-0'); 
                });
            };
            
            pImg.onerror = () => {
                 pLoader.classList.add('hidden'); // Ẩn loader nếu lỗi
            };

            pImg.src = data.image; // Bắt đầu load ảnh
            
        } else if (data.video) {
            mediaContainer.classList.remove('hidden');
            pVid.src = data.video;
            pVid.classList.remove('hidden');
        }
        
        if (data.manualContent) {
            pLongText.innerHTML = data.manualContent;
            pLongText.classList.remove('hidden');
        }

        contentPanel.classList.add('panel-visible');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
    }

    function closePanel() {
        contentPanel.classList.remove('panel-visible');
        overlay.classList.add('opacity-0');
        setTimeout(() => overlay.classList.add('hidden'), 300);

        setTimeout(() => {
            youtubeEmbed.innerHTML = '';
            pVid.pause();
        }, 300);

        if (state.activeLeaf) {
            state.activeLeaf.classList.remove('active-node');
            state.activeLeaf = null;
        }
    }

    function createLine(el1, el2, cls) {
        const x1 = parseFloat(el1.style.left);
        const y1 = parseFloat(el1.style.top);
        const x2 = parseFloat(el2.style.left);
        const y2 = parseFloat(el2.style.top);
        const dist = Math.hypot(x2 - x1, y2 - y1);
        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

        const line = document.createElement('div');
        line.className = `connecting-line ${cls}`;
        line.style.width = `0px`;
        line.style.left = `${x1}px`;
        line.style.top = `${y1}px`;
        line.style.transform = `rotate(${angle}deg)`;
        
        transformer.appendChild(line);
        
        requestAnimationFrame(() => {
            line.style.width = `${dist}px`;
            line.style.opacity = 1;
        });
    }

    init();
    
    window.addEventListener('resize', () => {
         positionNodes();
    });
</script>
</body>
</html>
