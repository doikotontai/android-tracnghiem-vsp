<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quản lý Stopcard NDT</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* NATIVE SCROLL: Remove hidden overflow on body */
        body { background-color: #f8fafc; color: #334155; font-size: 13px; -webkit-tap-highlight-color: transparent; min-height: 100vh; }
        html.dark body { background-color: #0f172a; color: #cbd5e1; }

        /* --- UI ELEMENTS --- */
        .glass-panel { background: rgba(255, 255, 255, 0.9); border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
        html.dark .glass-panel { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Compact Table Styles */
        .table-compact th { padding: 8px 12px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; background: #f8fafc; color: #64748b; font-weight: 600; }
        .table-compact td { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid #f1f5f9; }
        html.dark .table-compact th { background: #1e293b; color: #94a3b8; border-color: #334155; }
        html.dark .table-compact td { border-color: #334155; }
        .table-row-hover:hover { background-color: #f8fafc; }
        html.dark .table-row-hover:hover { background-color: rgba(30, 41, 59, 0.5); }
        
        /* Report Table Specifics */
        .report-table th { background: #f1f5f9; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        .report-table td { vertical-align: middle; }
        html.dark .report-table th { background: #1e293b; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Excel Button Style */
        .btn-excel {
            background: linear-gradient(to bottom, #107c41, #0c6132);
            box-shadow: 0 2px 0 #074924;
            transition: all 0.1s;
        }
        .btn-excel:active { transform: translateY(2px); box-shadow: none; }

        /* Modern Input */
        .modern-input {
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .modern-input:hover { background: rgba(0,0,0,0.03); }
        .modern-input:focus { background: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); outline: none; }
        html.dark .modern-input:focus { background: #1e293b; }

        /* Loader */
        .loader { width: 32px; height: 32px; border: 3px solid #e2e8f0; border-bottom-color: #3b82f6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>
    
    <!-- STICKY HEADER WRAPPER -->
    <div class="sticky top-0 z-50 shadow-md">
        <!-- HEADER & STATUS BAR -->
        <header class="bg-white/95 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200 dark:border-white/5">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <!-- Left: Title & Navigation -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center shadow-lg shadow-blue-500/20">
                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-slate-800 dark:text-white leading-tight">Quản lý Stopcard NDT</h1>
                            </div>
                        </div>
                        
                        <!-- Mobile Toggle Theme -->
                        <button id="theme-toggle-mobile" class="md:hidden p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                            <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                        </button>
                    </div>

                    <!-- Right: Stats Strip -->
                    <div class="flex-1 max-w-2xl bg-slate-100/50 dark:bg-slate-800/50 rounded-xl p-1.5 flex items-center justify-around border border-slate-200 dark:border-slate-700/50 relative overflow-hidden group">
                        <!-- Decor -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 pointer-events-none"></div>

                        <div class="flex items-center gap-2 px-2">
                            <div class="p-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg"><i data-lucide="files" class="w-4 h-4"></i></div>
                            <div class="leading-none">
                                <div class="text-[10px] text-slate-500 font-semibold uppercase">Tổng thẻ</div>
                                <div id="stat-total-cards" class="text-lg font-bold text-slate-800 dark:text-white">0</div>
                            </div>
                        </div>
                        
                        <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>

                        <div class="flex items-center gap-2 px-2">
                            <div class="p-1.5 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-lg"><i data-lucide="user-check" class="w-4 h-4"></i></div>
                            <div class="leading-none">
                                <div class="text-[10px] text-slate-500 font-semibold uppercase">Đã nộp</div>
                                <div id="stat-submitted-ratio" class="text-lg font-bold text-slate-800 dark:text-white">0/0</div>
                            </div>
                        </div>

                        <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>

                        <div class="flex items-center gap-2 px-2">
                            <div class="p-1.5 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg"><i data-lucide="alert-octagon" class="w-4 h-4"></i></div>
                            <div class="leading-none">
                                <div class="text-[10px] text-slate-500 font-semibold uppercase">Chưa nộp</div>
                                <div id="stat-unsubmitted" class="text-lg font-bold text-red-600 dark:text-red-400">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- TOOLBAR -->
        <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
            <div class="max-w-7xl mx-auto px-4 py-2">
                <div class="flex flex-col md:flex-row gap-2 md:gap-4 items-center">
                    <!-- Combined Date & Search Control -->
                    <div class="flex-1 w-full flex bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-1 items-center gap-1 shadow-inner">
                        <div class="flex items-center gap-1 bg-white dark:bg-slate-700 rounded-md px-2 py-1 shadow-sm shrink-0">
                            <button onclick="changeMonth(-1)" class="p-1 hover:text-blue-600 text-slate-400 transition"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <div class="flex items-center gap-1 text-sm font-bold text-slate-700 dark:text-slate-200 px-1 cursor-pointer select-none relative group">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-blue-500"></i>
                                <select id="filter-month" class="bg-transparent appearance-none outline-none cursor-pointer w-9 text-center"> <!-- JS --> </select>
                                <span class="text-slate-400">/</span>
                                <select id="filter-year" class="bg-transparent appearance-none outline-none cursor-pointer w-14"> <!-- JS --> </select>
                            </div>
                            <button onclick="changeMonth(1)" class="p-1 hover:text-blue-600 text-slate-400 transition"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <div class="w-px h-5 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                        <div class="flex-1 flex items-center px-2">
                            <i data-lucide="search" class="w-4 h-4 text-slate-400 mr-2"></i>
                            <input id="search-input" type="text" placeholder="Tìm tên, mã số..." class="w-full bg-transparent border-none outline-none text-sm text-slate-700 dark:text-slate-200 placeholder-slate-400">
                            <button onclick="document.getElementById('search-input').value='';renderTable()" class="text-slate-400 hover:text-red-500 transition"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>

                    <!-- Actions Right -->
                    <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                        <label class="cursor-pointer flex items-center gap-2 px-3 py-1.5 rounded-lg border border-dashed border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-800 transition select-none group">
                            <input type="checkbox" id="filter-unsubmitted" class="accent-red-500" onchange="renderTable()">
                            <span class="text-xs font-semibold text-slate-600 dark:text-slate-400 group-hover:text-red-500 transition">Chưa nộp</span>
                        </label>
                        <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                        <button onclick="window.syncAllApi()" class="p-2 rounded-lg text-purple-600 bg-purple-50 hover:bg-purple-100 border border-purple-200 transition relative group" title="Đồng bộ tất cả"><i data-lucide="cloud-lightning" class="w-4 h-4"></i></button>
                        <button onclick="window.openAddUserModal()" class="p-2 rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 transition" title="Thêm nhân sự"><i data-lucide="user-plus" class="w-4 h-4"></i></button>
                        <button onclick="window.openExportModal()" class="btn-excel flex items-center gap-2 px-3 py-1.5 rounded-lg text-white text-xs font-bold ml-1"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i><span>Xuất Excel</span></button>
                        <button id="theme-toggle" class="hidden md:flex p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    </div>
                </div>
            </div>
            <!-- Proxy Status -->
            <div id="proxy-status-bar" class="hidden bg-slate-50 dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 px-4 py-1 text-[10px] text-slate-400 justify-end items-center gap-2"><span>Data Source:</span><span id="proxy-name-display" class="font-mono font-bold text-slate-600 dark:text-slate-300">Direct</span></div>
        </div>
    </div>

    <!-- MAIN CONTENT (NATIVE SCROLL) -->
    <main class="w-full max-w-7xl mx-auto px-0 md:px-4 py-4">
        <div class="glass-panel md:rounded-xl overflow-hidden border-t md:border shadow-sm min-h-[500px] bg-white dark:bg-slate-900">
            <table class="w-full text-left border-collapse table-compact">
                <thead>
                    <tr>
                        <th class="w-10 text-center">#</th>
                        <th class="w-24 cursor-pointer hover:text-blue-500 transition" onclick="toggleSort('id')">Danh số</th>
                        <th class="cursor-pointer hover:text-blue-500 transition" onclick="toggleSort('name')">Họ và Tên</th>
                        <th class="w-24 text-center cursor-pointer hover:text-blue-500 transition" onclick="toggleSort('count')">Số thẻ</th>
                        <!-- CHANGED TO SYNC -->
                        <th class="w-16 text-center">Sync</th>
                        <th class="w-16 text-center">Log</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="text-slate-700 dark:text-slate-300">
                    <tr><td colspan="6" class="p-10 text-center text-slate-400"><div class="loader mb-2"></div><br>Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="py-6 text-center">
            <p class="text-[11px] text-slate-400 dark:text-slate-600 font-medium">© 2025 BCH-XNXL. Developed by Phong Luu.</p>
        </div>
    </main>

    <!-- Modals (kept same logic, just ensure z-index is high) -->
    <div id="export-modal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200 dark:border-slate-700 p-5">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i> Xuất Excel</h3><button onclick="document.getElementById('export-modal').classList.add('hidden');document.getElementById('export-modal').classList.remove('flex')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition group relative overflow-hidden"><input type="radio" name="exportOption" value="current" checked class="w-4 h-4 text-green-600 accent-green-600"><div class="flex-1"><div class="font-semibold text-sm text-slate-700 dark:text-slate-200">Tháng hiện tại</div><div class="text-xs text-slate-500">Chỉ xuất dữ liệu tháng <span id="export-current-label">...</span></div></div></label>
                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition group"><input type="radio" name="exportOption" value="all" class="w-4 h-4 text-green-600 accent-green-600"><div class="flex-1"><div class="font-semibold text-sm text-slate-700 dark:text-slate-200">Toàn bộ năm <span id="export-year-label">...</span></div><div class="text-xs text-slate-500">Tạo file có 12 Sheet (T1 - T12)</div></div><div class="px-2 py-1 bg-green-100 text-green-700 rounded text-[10px] font-bold">PRO</div></label>
                <label class="flex items-start gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition group"><input type="radio" name="exportOption" value="select" class="w-4 h-4 text-green-600 accent-green-600 mt-0.5" id="radio-select-months"><div class="flex-1"><div class="font-semibold text-sm text-slate-700 dark:text-slate-200 mb-2">Chọn tháng cụ thể</div><div class="grid grid-cols-4 gap-1" id="month-selector-grid"></div></div></label>
            </div>
            <button onclick="window.executeExport()" class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-sm shadow-lg shadow-green-500/20 transition active:scale-95 flex justify-center items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Tiến hành xuất file</button>
        </div>
    </div>

    <!-- Other Modals (Loading, Add User, History, API Report, Rate Limit, Sync Error - kept intact) -->
    <div id="loading-overlay" class="fixed inset-0 z-[99] hidden items-center justify-center bg-black/80 backdrop-blur-sm flex-col gap-4 animate-fade-in"><div class="loader border-t-blue-500 border-r-blue-500 border-b-transparent border-l-transparent"></div><div class="text-white font-bold text-sm tracking-wide" id="loading-text">Đang xử lý...</div><div class="w-48 h-1 bg-slate-700 rounded-full overflow-hidden"><div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div></div></div>
    
    <div id="add-user-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200 dark:border-slate-700 p-6 relative"><button onclick="window.closeAddUserModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button><h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6">Thêm Nhân Sự Mới</h3><div class="space-y-4"><div><label class="text-xs font-bold text-slate-500 uppercase">Danh số (ID)</label><input type="text" id="new-user-id" class="w-full p-2 mt-1 border border-slate-300 dark:border-slate-600 rounded-lg bg-transparent focus:border-blue-500 outline-none dark:text-white"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Họ và Tên</label><input type="text" id="new-user-name" class="w-full p-2 mt-1 border border-slate-300 dark:border-slate-600 rounded-lg bg-transparent focus:border-blue-500 outline-none dark:text-white"></div></div><button onclick="window.confirmAddUser()" class="w-full mt-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">Lưu nhân sự</button></div></div>
    
    <div id="history-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700 p-5 flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white">Lịch sử cập nhật</h3><button onclick="document.getElementById('history-modal').classList.add('hidden');document.getElementById('history-modal').classList.remove('flex')"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button></div><div id="history-content" class="flex-1 overflow-y-auto custom-scrollbar space-y-3"></div></div></div>
    
    <div id="api-report-modal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-0 md:p-6 animate-fade-in"><div class="bg-white dark:bg-slate-900 w-full h-full md:rounded-2xl md:h-[90vh] md:max-w-6xl flex flex-col overflow-hidden relative"><div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800"><div><h3 class="font-bold text-lg dark:text-white">Chi tiết thẻ an toàn</h3><p id="api-report-subtitle" class="text-xs text-slate-500"></p></div><button onclick="document.getElementById('api-report-modal').classList.add('hidden');document.getElementById('api-report-modal').classList.remove('flex')" class="p-2 bg-white dark:bg-slate-700 rounded-full hover:bg-red-50 text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-auto custom-scrollbar bg-white dark:bg-slate-950 p-0"><table class="w-full text-left border-collapse report-table table-compact"><thead><tr><th class="p-3 border-b">STT</th><th class="p-3 border-b">Ngày tạo</th><th class="p-3 border-b">Công trình</th><th class="p-3 border-b">Đơn vị</th><th class="p-3 border-b">Tổ chức</th><th class="p-3 border-b">Người tạo</th><th class="p-3 border-b">Trạng thái</th></tr></thead><tbody id="api-report-body"></tbody></table></div></div></div>
    
    <div id="rate-limit-modal" class="fixed inset-0 z-[95] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-sm border border-orange-200 dark:border-orange-900 p-6 text-center"><div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="shield-alert" class="w-6 h-6"></i></div><h3 class="font-bold text-lg mb-2 dark:text-white">Cảnh báo Spam</h3><p id="rate-limit-msg" class="text-sm text-slate-500 mb-6"></p><div class="flex gap-3"><button id="btn-wait" class="flex-1 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-bold text-sm">Chờ thêm</button><button id="btn-switch" class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm">Đổi Proxy</button></div></div></div>
    
    <div id="sync-error-modal" class="fixed inset-0 z-[90] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md border border-red-200 dark:border-red-900 p-6 flex flex-col max-h-[70vh]"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-red-600 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Kết quả Đồng bộ</h3><button onclick="document.getElementById('sync-error-modal').classList.add('hidden');document.getElementById('sync-error-modal').classList.remove('flex')"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="sync-error-list" class="flex-1 overflow-y-auto custom-scrollbar border rounded-lg p-2 bg-slate-50 dark:bg-slate-950"></div></div></div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // DANH SÁCH NHÂN SỰ MẶC ĐỊNH (GỘP VÀO TRONG FILE)
        // ==========================================
        const DEFAULT_PERSONNEL = [
            { id: "13453", name: "Nguyễn Anh Đức" },
            { id: "XL2467", name: "Trần Thanh Quang", apiId: "39a7fc3b-c4f5-4e2a-88e0-42dc9d139d9a" },
            { id: "16703", name: "Nguyễn Văn Nam", apiId: "ad607def-7ff3-4a14-b3ac-dd97b67455e1" },
            { id: "15567", name: "Nguyễn Thanh Hùng", apiId: "0dd04d60-3317-424d-bdee-bdf04444c21c" },
            { id: "16702", name: "Đinh Đức Quân", apiId: "96b1e630-8857-4141-8c71-11e0c978d7aa" },
            { id: "XL1595", name: "Ngô Thành Nam", apiId: "a8c27a79-13db-400a-be01-2e52744400f9" },
            { id: "14598", name: "Đào Đức Đông", apiId: "c89c21bb-4a5f-4533-8349-08e9d8fc176f" },
            { id: "15805", name: "Nguyễn Văn Minh", apiId: "6c6dc89f-3c7a-4fde-9be3-e627ce5919a1" },
            { id: "20396", name: "Phạm Thanh Nam", apiId: "104984c0-7a23-43a5-af33-a3ab1d9a0db7" },
            { id: "XL1709", name: "Ng. Viết Phong Lưu", apiId: "1e147ad6-31d9-4c16-a611-85a1caff06c1" }, 
            { id: "XL104", name: "Trần Văn Đoàn" },
            { id: "XL128", name: "Bùi Văn Dũng", apiId: "c6ece3b6-91a9-41ea-8809-2acd4d56e7b2" },
            { id: "XL204", name: "Nguyễn Ngọc Long", apiId: "80929c87-8b3e-4e5f-bfea-25549e2363a9" },
            { id: "XL239", name: "Bùi Hồng Sáng", apiId: "69e9f350-df92-4128-b8dd-26e815091c84" },
            { id: "XL246", name: "Võ Quốc Tuấn", apiId: "3e6827b3-e2f7-4187-803e-b1a9065b3c90" },
            { id: "XL248", name: "Nguyễn Mạnh Hùng", apiId: "0b20d0cf-4117-4358-8739-db6b23a0cf3e" },
            { id: "20492", name: "Trần Ngọc Thế", apiId: "4c1cbba7-95d5-43a5-a187-7f369490af59" },
            { id: "XL291", name: "Vũ Quang Dương" },
            { id: "XL354", name: "Nguyễn Văn Thủy", apiId: "c3ca0c70-659c-4679-8c46-c701ae235375" },
            { id: "XL419", name: "Đinh Văn Thiện", apiId: "d9632600-e7da-4a00-bb8b-dd441da937e7" },
            { id: "XL420", name: "Phạm Ngọc Điều", apiId: "b46fa046-0437-4077-a8d5-a9bc92a2d638" },
            { id: "XL431", name: "Phạm Văn Chinh", apiId: "0e5a9d4d-9da9-4224-9a84-6c1446636250" },
            { id: "XL432", name: "Lê Văn Dũng", apiId: "da0c64b8-6e6e-4e04-a7de-c59bac781c3d" },
            { id: "XL451", name: "Đào Văn Khôi", apiId: "ffb5f611-0433-4e7d-a221-9dea84bf0c87" },
            { id: "XL453", name: "Võ Hoàng Tiến", apiId: "6976c716-b61f-43cf-9f24-94ae377de90d" },
            { id: "XL454", name: "Nguyễn Anh Kiệt", apiId: "24579e9d-710b-4901-83c7-e49adcfe543f" },
            { id: "XL627", name: "Nguyễn Hàm Chung", apiId: "f4cae049-4afb-4fda-bc9a-9b5427b61da5" },
            { id: "XL628", name: "Trần Văn Toán", apiId: "61dcd131-7799-4966-a8a1-15fcfbd6ac52" },
            { id: "XL641", name: "Lê Huy", apiId: "66930a32-aa29-4076-8fef-6090be88e951" },
            { id: "XL742", name: "Nguyễn Trọng Tuyến", apiId: "6951ad82-2de8-42da-a141-d2a0400558f1" },
            { id: "XL780", name: "Vũ Tuấn Anh" },
            { id: "XL781", name: "Nguyễn Đức Hảo", apiId: "39e15b50-8710-4070-b38f-6479aa84a2ca" },
            { id: "XL831", name: "Trần Hồng Thành" },
            { id: "21517", name: "Nguyễn Ngọc An", apiId: "167da8dd-ae1a-420d-b865-4b23fca1ca39" },
            { id: "XL1123", name: "Nguyễn Văn Lộc", apiId: "6c58b2aa-2b0b-400d-8113-dbc0fd1fe793" },
            { id: "XL2064", name: "Nguyễn Quốc Tài", apiId: "25489db6-948f-4504-a1fc-d692127958bf" },
            { id: "XL1375", name: "Nguyễn Anh Tiến", apiId: "0f30900c-83e6-4021-bc02-9bc86fdab368" },
            { id: "XL1665", name: "Phạm Hồng Vũ", apiId: "1e0f9d58-7e4a-44fe-91ab-6e57d0c54573" },
            { id: "XL1781", name: "Lê Nguyễn Huy Hoàn", apiId: "3e2df8bd-c965-4eb2-83c1-5806169aedce" },
            { id: "XL1124", name: "Ngô Đức Thuận", apiId: "52be4e27-3831-425e-80ca-fc0990e751ee" },
            { id: "XL2066", name: "Nguyễn Quang Vinh", apiId: "62e56afa-22e5-4edc-b2a3-81c7e2ba9e25" },
            { id: "XL2067", name: "Trần Tiến Trường", apiId: "abe87f1e-dab4-4684-9bd6-4fbd575af559" },
            { id: "XL1546", name: "Nguyễn Tuấn Anh" },
            { id: "XL2217", name: "Ngô Lai Thích", apiId: "d20b95c5-ed4d-4a35-af0f-91288dc8c7dd" },
            { id: "XL2247", name: "Trần Quốc Thiện", apiId: "d3582ec7-d56a-4fab-b070-63cd373b772d" },
            { id: "XL2248", name: "Đinh Đức Vương", apiId: "37dec7a9-f8bc-4252-999a-7a4677e7c8fe" },
            { id: "XL2249", name: "Đoàn Ng.M.Trường", apiId: "391ef6c8-d9cc-4178-a663-3203af99b0a2" },
            { id: "XL1802", name: "Nguyễn Đăng Thành", apiId: "ab7d78c4-08b1-460d-bee3-784f32c052f9" },
            { id: "XL2463", name: "Hoàng Văn Sơn", apiId: "94c462d3-51d1-4d65-9023-667cdb187af2" },
            { id: "XL2443", name: "Trần Đức Ngân", apiId: "75f30394-0549-4664-b97c-adf60a489d00" },
            { id: "XL2465", name: "Đỗ Văn Nam", apiId: "8a9534f5-f8bc-4498-bc24-43b4216a4112" },
            { id: "XL2464", name: "Bùi Văn Vượng", apiId: "cb4fb6c0-e63c-4509-ad35-a0d30f704df9" },
            { id: "XL2466", name: "Nguyễn Thanh Ngân", apiId: "37aa182b-e25e-4b32-9aa6-2ff8eb3b4d9d" },
            { id: "XL2491", name: "Nghiêm Trình Nhật", apiId: "4882f260-9b06-4595-9538-85184841a700" },
            { id: "XL2492", name: "Phạm Văn Trinh" },
            { id: "XL2582", name: "Nguyễn Hiền Đăng", apiId: "a443b559-cc5f-4a11-9322-bed56149d070" },
            { id: "XL2618", name: "Hoàng Trọng Linh" },
            { id: "XL260", name: "Vũ Xuân Chính", apiId: "8f1ad5d0-3791-4690-82ff-6eea272f55fd" },
            { id: "XL2619", name: "Nguyễn Tuấn Đạt" },
            { id: "XL853", name: "Cù Chí Công", apiId: "988618de-5453-4944-b47a-e0cc8175a4de" }
        ];

        const CUSTOM_PROXY_URL = "https://api-proxy.phongluuservices.workers.dev/"; 
        const firebaseConfig = {
            apiKey: "AIzaSyCt14_pkmWE0MhD0SeH_MisjmHjlY-Mu84",
            authDomain: "tracnghiemndt.firebaseapp.com",
            projectId: "tracnghiemndt",
            storageBucket: "tracnghiemndt.firebasestorage.app",
            messagingSenderId: "187385061213",
            appId: "1:187385061213:web:fe7977f62aaaeec60f52b4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const CONFIG_USERS_DOC = doc(db, 'stopcard_config', 'users_list');
        
        let masterData = { users: {}, records: {} };
        let currentYear = parseInt(localStorage.getItem('stopcard_year')) || new Date().getFullYear();
        let currentMonth = parseInt(localStorage.getItem('stopcard_month')) || (new Date().getMonth() + 1);
        let sortMode = 'id_asc';
        let unsubscribeMonth = null;
        let isRenderPending = false;

        // UI HELPERS
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', warning: 'bg-orange-500', info: 'bg-blue-500' };
            toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg shadow-xl text-white text-sm font-medium ${colors[type]} animate-fade-in backdrop-blur-md`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function updateProxyStatus(proxyName) {
            const el = document.getElementById('proxy-status-bar');
            const text = document.getElementById('proxy-name-display');
            if(el) el.classList.remove('hidden');
            if(el) el.classList.add('flex');
            if(text) text.textContent = proxyName;
        }

        // --- EXCEL LOGIC ---
        window.openExportModal = () => {
            const modal = document.getElementById('export-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            document.getElementById('export-current-label').innerText = `${currentMonth}/${currentYear}`;
            document.getElementById('export-year-label').innerText = `${currentYear}`;
            
            const grid = document.getElementById('month-selector-grid');
            grid.innerHTML = '';
            for(let i=1; i<=12; i++) {
                grid.innerHTML += `<label class="flex items-center justify-center p-2 rounded border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 peer-checked:bg-green-100 dark:peer-checked:bg-green-900/40 select-none text-xs font-bold transition"><input type="checkbox" class="month-checkbox hidden" value="${i}"><span class="text-slate-600 dark:text-slate-400 checkbox-label">T${i}</span></label>`;
            }
            
            document.querySelectorAll('.month-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const label = e.target.nextElementSibling;
                    const parent = e.target.parentElement;
                    if(e.target.checked) { parent.classList.add('bg-green-100', 'dark:bg-green-900/40', 'border-green-500'); label.classList.add('text-green-700', 'dark:text-green-300'); } 
                    else { parent.classList.remove('bg-green-100', 'dark:bg-green-900/40', 'border-green-500'); label.classList.remove('text-green-700', 'dark:text-green-300'); }
                    document.getElementById('radio-select-months').checked = true;
                });
            });
        }

        window.executeExport = async () => {
            const option = document.querySelector('input[name="exportOption"]:checked').value;
            const modal = document.getElementById('export-modal');
            const loading = document.getElementById('loading-overlay');
            const loadingBar = document.getElementById('loading-bar');
            const loadingText = document.getElementById('loading-text');

            modal.classList.add('hidden'); modal.classList.remove('flex');
            loading.classList.remove('hidden'); loading.classList.add('flex');
            
            let monthsToExport = [];
            if (option === 'current') monthsToExport.push(currentMonth);
            else if (option === 'all') for(let i=1; i<=12; i++) monthsToExport.push(i);
            else if (option === 'select') document.querySelectorAll('.month-checkbox:checked').forEach(cb => monthsToExport.push(parseInt(cb.value)));

            if(monthsToExport.length === 0) { loading.classList.add('hidden'); loading.classList.remove('flex'); return alert("Vui lòng chọn ít nhất 1 tháng!"); }

            const wb = XLSX.utils.book_new();
            let hasData = false;

            try {
                const users = masterData.users;
                for (let i = 0; i < monthsToExport.length; i++) {
                    const m = monthsToExport[i];
                    loadingText.innerText = `Đang lấy dữ liệu Tháng ${m}/${currentYear}...`;
                    loadingBar.style.width = `${((i+1) / monthsToExport.length) * 100}%`;
                    
                    let monthRecords = {};
                    if (m === currentMonth && masterData.records) { monthRecords = masterData.records; } 
                    else {
                        const snap = await getDocs(collection(db, 'stopcard_records', `${currentYear}_${m}`, 'user_data'));
                        snap.forEach(doc => { monthRecords[doc.id] = doc.data(); });
                    }

                    const sheetData = [];
                    sheetData.push(["STT", "Danh Số", "Họ và Tên", `Thẻ Tháng ${m}/${currentYear}`, "Trạng thái"]);
                    let stt = 1;
                    Object.entries(users).forEach(([uid, info]) => {
                        const count = monthRecords[uid]?.count || 0;
                        sheetData.push([stt++, info.id, info.name, count, count > 0 ? "Đã nộp" : "Chưa nộp"]);
                    });

                    if (sheetData.length > 1) {
                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        const wscols = [{wch:5}, {wch:10}, {wch:25}, {wch:15}, {wch:15}];
                        ws['!cols'] = wscols;
                        XLSX.utils.book_append_sheet(wb, ws, `T${m}-${currentYear}`);
                        hasData = true;
                    }
                    await new Promise(r => setTimeout(r, 100));
                }

                if (!hasData) alert("Không có dữ liệu để xuất!");
                else { XLSX.writeFile(wb, `BaoCao_Stopcard_Nam${currentYear}.xlsx`); showToast("Xuất file thành công!"); }
            } catch (e) { console.error(e); alert("Lỗi khi xuất file: " + e.message); } 
            finally { loading.classList.add('hidden'); loading.classList.remove('flex'); }
        }

        // --- MAIN INIT ---
        const init = async () => {
            renderTimeSelectors();
            const html = document.documentElement;
            if (localStorage.getItem('theme') === 'dark') html.classList.add('dark');
            
            const toggleFn = () => { html.classList.toggle('dark'); localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light'); };
            document.getElementById('theme-toggle').onclick = toggleFn;
            document.getElementById('theme-toggle-mobile').onclick = toggleFn;

            try { await signInAnonymously(auth); } catch (e) { console.error(e); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    onSnapshot(CONFIG_USERS_DOC, async (snap) => {
                        let dbUsers = {};
                        if (snap.exists()) { dbUsers = snap.data().users || {}; }
                        
                        let needsUpdate = false;
                        
                        // Sử dụng mảng DEFAULT_PERSONNEL đã được nhúng trực tiếp ở trên
                        DEFAULT_PERSONNEL.forEach(defUser => {
                            const uid = "U_" + defUser.id.replace(/\s+/g, '');
                            
                            // 1. Nếu user chưa có trong DB -> Thêm mới
                            if (!dbUsers[uid]) { 
                                dbUsers[uid] = defUser; 
                                needsUpdate = true; 
                            } else { 
                                // 2. Nếu user đã có, kiểm tra và CẬP NHẬT nếu file code mới hơn
                                let changed = false;
                                if (defUser.name && dbUsers[uid].name !== defUser.name) {
                                    dbUsers[uid].name = defUser.name;
                                    changed = true;
                                }
                                if (defUser.apiId && dbUsers[uid].apiId !== defUser.apiId) {
                                    dbUsers[uid].apiId = defUser.apiId;
                                    changed = true;
                                }
                                if (changed) needsUpdate = true;
                            }
                        });
                        
                        masterData.users = dbUsers;
                        renderTable();
                        
                        // Tự động đồng bộ ngược lại Firebase nếu có thay đổi từ Code
                        if (needsUpdate) { 
                            try { await setDoc(CONFIG_USERS_DOC, { users: dbUsers }, { merge: true }); console.log("Đã đồng bộ dữ liệu từ Code lên Database."); } 
                            catch (e) { console.error("Lỗi đồng bộ:", e); } 
                        }
                    });
                    listenToMonthRecords();
                }
            });
        };

        const listenToMonthRecords = () => {
            if (unsubscribeMonth) unsubscribeMonth();
            const monthKey = `${currentYear}_${currentMonth}`;
            masterData.records = {}; 
            const tbody = document.querySelector('#table-body');
            tbody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-slate-400"><div class="loader mb-2"></div><br>Đang tải dữ liệu T${currentMonth}/${currentYear}...</td></tr>`;

            unsubscribeMonth = onSnapshot(collection(db, 'stopcard_records', monthKey, 'user_data'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const uid = change.doc.id;
                    if (change.type === "removed") { delete masterData.records[uid]; } 
                    else { masterData.records[uid] = change.doc.data(); }
                });
                if (!isRenderPending) { isRenderPending = true; requestAnimationFrame(() => { renderTable(); isRenderPending = false; }); }
            }, (error) => { console.log(error); });
        };

        function renderTimeSelectors() {
            const mSelect = document.getElementById('filter-month');
            const ySelect = document.getElementById('filter-year');
            mSelect.innerHTML = '';
            for(let i=1; i<=12; i++) mSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${i}</option>`;
            ySelect.innerHTML = '';
            for(let i=currentYear-1; i<=currentYear+1; i++) ySelect.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
            
            const updateDate = () => { localStorage.setItem('stopcard_month', currentMonth); localStorage.setItem('stopcard_year', currentYear); renderTimeSelectors(); listenToMonthRecords(); };
            mSelect.onchange = (e) => { currentMonth = parseInt(e.target.value); updateDate(); };
            ySelect.onchange = (e) => { currentYear = parseInt(e.target.value); updateDate(); };
        }

        window.changeMonth = (delta) => {
            let m = currentMonth + delta;
            if (m > 12) { m = 1; currentYear++; }
            if (m < 1) { m = 12; currentYear--; }
            currentMonth = m;
            localStorage.setItem('stopcard_month', currentMonth);
            localStorage.setItem('stopcard_year', currentYear);
            renderTimeSelectors();
            listenToMonthRecords();
        }

        window.toggleSort = (type) => {
            if (type === 'id') sortMode = sortMode === 'id_asc' ? 'id_desc' : 'id_asc';
            else if (type === 'name') sortMode = sortMode === 'name_asc' ? 'name_desc' : 'name_asc';
            else if (type === 'count') sortMode = sortMode === 'count_desc' ? 'count_asc' : 'count_desc';
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const search = document.getElementById('search-input').value.toLowerCase();
            const showUnsubmittedOnly = document.getElementById('filter-unsubmitted').checked;

            let list = Object.entries(masterData.users || {}).map(([uid, info]) => {
                const record = masterData.records[uid] || { count: 0, history: [] };
                return { uid: uid, id: info.id || "---", name: info.name || "Không tên", count: record.count || 0, history: record.history || [], apiId: info.apiId || null };
            });

            if (search) list = list.filter(u => u.name.toLowerCase().includes(search) || u.id.toLowerCase().includes(search));
            if (showUnsubmittedOnly) list = list.filter(u => u.count === 0);

            if (sortMode === 'id_asc') list.sort((a, b) => a.id.toString().localeCompare(b.id.toString(), 'en', { numeric: true }));
            else if (sortMode === 'id_desc') list.sort((a, b) => b.id.toString().localeCompare(a.id.toString(), 'en', { numeric: true }));
            else if (sortMode === 'name_asc') list.sort((a, b) => a.name.localeCompare(b.name, 'vi'));
            else if (sortMode === 'name_desc') list.sort((a, b) => b.name.localeCompare(a.name, 'vi'));
            else if (sortMode === 'count_desc') list.sort((a, b) => b.count - a.count);
            else if (sortMode === 'count_asc') list.sort((a, b) => a.count - b.count);

            const totalCards = list.reduce((sum, item) => sum + item.count, 0);
            const totalPersonnel = Object.keys(masterData.users).length;
            const submittedCount = Object.keys(masterData.records).filter(uid => masterData.records[uid].count > 0).length;

            document.getElementById('stat-total-cards').innerText = totalCards;
            document.getElementById('stat-submitted-ratio').innerText = `${submittedCount}/${totalPersonnel}`;
            document.getElementById('stat-unsubmitted').innerText = totalPersonnel - submittedCount;

            if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic">Không tìm thấy dữ liệu.</td></tr>`; return; }

            tbody.innerHTML = list.map((item, index) => {
                const rowClass = item.count === 0 && !showUnsubmittedOnly ? 'bg-red-50/60 dark:bg-red-900/10' : '';
                const apiBtnHtml = item.apiId 
                    ? `<button onclick="window.fetchApiData('${item.uid}', '${item.apiId}', '${item.name}')" class="p-1.5 rounded-lg bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 dark:bg-slate-800 dark:hover:bg-blue-900/30 transition group relative" title="Check API"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>`
                    : `<span class="text-slate-200 dark:text-slate-800 cursor-not-allowed"><i data-lucide="slash" class="w-3 h-3"></i></span>`;

                return `<tr class="table-row-hover transition-colors duration-150 border-b border-slate-100 dark:border-slate-800 group ${rowClass}">
                    <td class="text-center font-bold text-slate-400 text-xs">${index + 1}</td>
                    <td class="font-mono text-blue-700 dark:text-blue-400 font-bold text-xs">${item.id}</td>
                    <td class="font-medium text-slate-700 dark:text-slate-300 text-sm whitespace-nowrap">${item.name}</td>
                    <td class="text-center"><input type="number" min="0" id="input-${item.uid}" class="modern-input w-16 text-center font-bold rounded py-1 ${item.count > 0 ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400'}" value="${item.count}" onchange="window.updateCount('${item.uid}', this.value)" onfocus="this.select()"></td>
                    <td class="text-center">${apiBtnHtml}</td>
                    <td class="text-center"><button onclick="window.viewHistory('${item.uid}')" class="p-1.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-400 transition ${item.history.length > 0 ? 'text-blue-400' : 'opacity-20'}"><i data-lucide="history" class="w-3.5 h-3.5"></i></button></td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderTable = renderTable;
        document.getElementById('search-input').oninput = renderTable;

        window.updateCount = async (uid, newVal) => {
            const count = parseInt(newVal);
            if (isNaN(count) || count < 0) { renderTable(); return; }
            const monthKey = `${currentYear}_${currentMonth}`;
            const userDocRef = doc(db, 'stopcard_records', monthKey, 'user_data', uid);
            const oldRecord = masterData.records[uid] || { count: 0, history: [] };
            if (count === oldRecord.count) return;
            masterData.records[uid] = { ...oldRecord, count: count };
            try {
                const docSnap = await getDoc(userDocRef);
                let currentServerData = { count: 0, history: [] };
                if (docSnap.exists()) { currentServerData = docSnap.data(); }
                const now = new Date().toLocaleString('vi-VN');
                const newHistoryItem = {date: now, by: "User", old: currentServerData.count || 0, new: count};
                const newHistory = [newHistoryItem, ...(currentServerData.history || [])].slice(0, 5);
                await setDoc(userDocRef, { count: count, history: newHistory, lastUpdated: now }, { merge: true });
                showToast("Đã cập nhật!");
            } catch (e) { showToast("Lỗi khi lưu!", "error"); masterData.records[uid] = oldRecord; renderTable(); }
        };

        window.openAddUserModal = () => { document.getElementById('add-user-modal').classList.remove('hidden'); document.getElementById('add-user-modal').classList.add('flex'); document.getElementById('new-user-id').value = ''; document.getElementById('new-user-id').focus(); }
        window.closeAddUserModal = () => { document.getElementById('add-user-modal').classList.add('hidden'); document.getElementById('add-user-modal').classList.remove('flex'); }
        window.confirmAddUser = async () => {
            const id = document.getElementById('new-user-id').value.trim(); const name = document.getElementById('new-user-name').value.trim();
            if (!id || !name) return alert("Thiếu thông tin!");
            const uid = "U_" + id.replace(/\s+/g, '');
            if (masterData.users[uid]) return alert("Đã tồn tại!");
            try { await setDoc(CONFIG_USERS_DOC, { users: { [uid]: { id, name } } }, { merge: true }); showToast("Đã thêm!"); window.closeAddUserModal(); } catch (e) { alert("Lỗi: " + e.message); }
        }

        window.viewHistory = (uid) => {
            const history = masterData.records[uid]?.history || [];
            const userName = masterData.users[uid]?.name;
            const container = document.getElementById('history-content');
            container.innerHTML = `<div class="font-bold border-b pb-2 mb-2 dark:text-white">${userName}</div>` + (history.length ? history.map(h => `<div class="text-xs p-2 bg-slate-50 dark:bg-slate-800 rounded border border-slate-100 dark:border-slate-700"><div class="flex justify-between font-bold dark:text-slate-300"><span>${h.old} ➝ <span class="text-blue-500">${h.new}</span></span></div><div class="text-slate-400 mt-1">${h.date}</div></div>`).join('') : '<div class="text-slate-400 italic text-sm">Trống</div>');
            document.getElementById('history-modal').classList.remove('hidden'); document.getElementById('history-modal').classList.add('flex');
        }

        function showRateLimitModal(message) { return new Promise((resolve) => { const modal = document.getElementById('rate-limit-modal'); const msgEl = document.getElementById('rate-limit-msg'); msgEl.innerText = message || "Rate Limit Exceeded"; modal.classList.remove('hidden'); modal.classList.add('flex'); document.getElementById('btn-wait').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(false); }; document.getElementById('btn-switch').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(true); }; }); }

        window.fetchApiData = async (uid, apiId, name, isBulk = false) => {
            if (!apiId) return alert("Chưa có API ID.");
            if (!isBulk) showToast("Đang tải dữ liệu...", "info");
            const noCache = `?t=${Date.now()}`;
            const targetUrl = `https://apistopcard.vietsov.com.vn/api/StopCard/GetStopCardsByUserId/${apiId}`;
            let data = null;
            const fetchWithTimeout = (url, opts = {}, time = 5000) => { return Promise.race([ fetch(url, opts), new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout')), time)) ]); };
            const proxies = [];
            if (CUSTOM_PROXY_URL) proxies.push({ name: 'CustomWorker', url: `${CUSTOM_PROXY_URL}?apiId=${apiId}` });
            proxies.push({ name: 'Direct', url: targetUrl + noCache }, { name: 'CorsProxy', url: `https://corsproxy.io/?${encodeURIComponent(targetUrl)}` }, { name: 'CodeTabs', url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}` }, { name: 'AllOrigins', url: `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}` });

            for (const proxy of proxies) {
                if (data) break;
                try {
                    const res = await fetchWithTimeout(proxy.url, {}, 5000);
                    if (res.status === 429) { if (!isBulk) { const json = await res.json(); if (await showRateLimitModal(json.message)) continue; else return false; } else continue; }
                    if (res.ok) { const json = await res.json(); if (proxy.name === 'AllOrigins') { if (json && json.contents) try { data = JSON.parse(json.contents); } catch(e){} } else data = json; if (Array.isArray(data)) updateProxyStatus(proxy.name); else data = null; }
                } catch (e) {}
            }

            if (!Array.isArray(data)) { if (!isBulk) showToast("Lỗi kết nối API", "error"); return false; }
            
            const allMonthData = data.filter(item => { const d = new Date(item.createdDate); const startDate = new Date(currentYear, currentMonth - 2, 25, 0, 0, 0); const endDate = new Date(currentYear, currentMonth - 1, 24, 23, 59, 59); return d >= startDate && d <= endDate; });
            const approvedData = allMonthData.filter(item => { const s = (item.trangThai?.name || "").toLowerCase(); return s.includes('đạt') || s.includes('duyệt') || s.includes('approved') || s.includes('đã xử lý'); });
            const approvedCount = approvedData.length;
            const inputEl = document.getElementById(`input-${uid}`);
            if (approvedCount !== (masterData.records[uid]?.count || 0)) { if(inputEl) inputEl.value = approvedCount; await window.updateCount(uid, approvedCount); } 
            else if (!isBulk) showToast(`Dữ liệu khớp (${approvedCount} thẻ)`, "success");
            if (!isBulk) renderApiReport(name, allMonthData);
            return true; 
        };

        function renderApiReport(name, data) {
            const tbody = document.getElementById('api-report-body');
            document.getElementById('api-report-subtitle').innerText = `${name} - T${currentMonth}`;
            tbody.innerHTML = data.length ? data.map((item, i) => `<tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800"><td class="p-3 text-sm">${i + 1}</td><td class="p-3 text-sm font-mono text-slate-600 dark:text-slate-400 whitespace-nowrap">${new Date(item.createdDate).toLocaleString('vi-VN')}</td><td class="p-3 text-sm truncate max-w-[150px]" title="${item.constructionName || ''}">${item.constructionName || '-'}</td><td class="p-3 text-sm whitespace-nowrap">${(item.departmentName || '').replace('Xí nghiệp Xây lắp Khảo sát & Sửa chữa Công trình Dầu khí', 'XNXL')}</td><td class="p-3 text-sm whitespace-nowrap">${item.toChuc || '-'}</td><td class="p-3 text-sm font-mono text-slate-500 dark:text-slate-500">${(item.createBy || '').split('@')[0]}</td><td class="p-3 text-sm"><span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700 font-bold ${item.trangThai?.name?.includes('Đạt') ? 'text-green-600' : 'text-slate-600'}">${item.trangThai?.name || ''}</span></td></tr>`).join('') : `<tr><td colspan="7" class="p-4 text-center text-slate-400 italic">Không có thẻ trong kỳ báo cáo này.</td></tr>`;
            document.getElementById('api-report-modal').classList.remove('hidden'); document.getElementById('api-report-modal').classList.add('flex');
        }

        window.syncAllApi = async () => {
            if (!confirm("Đồng bộ tất cả nhân sự có API ID?")) return;
            const users = Object.entries(masterData.users).map(([uid, info]) => ({ uid, ...info })).filter(u => u.apiId);
            const overlay = document.getElementById('loading-overlay');
            const bar = document.getElementById('loading-bar');
            overlay.classList.remove('hidden'); overlay.classList.add('flex');
            const failed = [];
            const batch = 5;
            for(let i=0; i<users.length; i+=batch) {
                const chunk = users.slice(i, i+batch);
                await Promise.all(chunk.map(async u => { const ok = await window.fetchApiData(u.uid, u.apiId, u.name, true); if(!ok) failed.push(u.name); }));
                const pct = Math.round(((i+batch)/users.length)*100);
                bar.style.width = `${pct}%`;
            }
            overlay.classList.add('hidden'); overlay.classList.remove('flex');
            if(failed.length) { document.getElementById('sync-error-list').innerHTML = failed.map(n => `<div class="text-red-600 text-sm py-1 border-b">${n}</div>`).join(''); document.getElementById('sync-error-modal').classList.remove('hidden'); document.getElementById('sync-error-modal').classList.add('flex'); } else showToast("Đồng bộ hoàn tất!", "success");
        }

        init();
    </script>
</body>
</html>
